<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        
    </style>
</head>
<body>
    
    <script type="module">
        import defaultExport from "../src/Lancelot.js";

        class CarController extends Lancelot.Component {
    constructor(params) {
        super();
        this.wheels = params.wheels;
    }
    Update(dt) {
        const body = this.parent.body;
        const sprite = this.GetComponent("Sprite");

        if(body.position.y > 1000) {
            body.position.Set(0, -200);
            this.wheels[0].position.Set(body.width * 0.45, -200);
            this.wheels[1].position.Set(body.width * 0.45, -200);
        }
        
        const onGround = (this.wheels[0].body.collisions.all.size > 0 || this.wheels[1].body.collisions.all.size > 0);

        body.velocity.y += 500 * dt;
        
        sprite.angle = body.angle;
        const speed = 50;
        const rotSpeed = 15;

        if(this.scene.IsPressed("ArrowRight")) {
            if(onGround) {
                this.wheels[0].body.angularVelocity += speed * dt;
                this.wheels[1].body.angularVelocity += speed * dt;
            } else {
                body.angularVelocity -= rotSpeed * dt;
            }
        }
        if(this.scene.IsPressed("ArrowLeft")) {
            if(onGround) {
                this.wheels[0].body.angularVelocity -= speed * dt;
                this.wheels[1].body.angularVelocity -= speed * dt;
            } else {
                body.angularVelocity += rotSpeed * dt;
            }
        }
        if(this.scene.IsPressed("f")) {
            this.wheels[0].body.angularVelocity = 0;
            this.wheels[1].body.angularVelocity = 0;
        }

        for(let w of this.wheels) {
            const wbody = w.body;
            const wsprite = w.GetComponent("Sprite");
            
            
        
            wbody.velocity.y += 500 * dt;
        
            wsprite.angle = wbody.angle;
        }
    }
}

let game;

addEventListener("DOMContentLoaded", () => {
    
    game = new Lancelot.Game({
        width: 720,
        height: 480,
        init: init,
        controls: {
            active: true,
        }
    });
    
});

function init() {
    
    const level = this.CreateScene("level", {
        background: "#646464",
        light: "#FFF",
        physics: {
            iterations: 3,
            bounds: [[-100, -1100], [4000, 1400]]
        }
    });
    
    level.Play();
    
    
    const createCar = () => {
        
        const w = 128, h = 32;
        const car = level.CreateEntity();
        car.groupList.add("car");
        
        let body;
        car.AddComponent(body = new Lancelot.physics.Box({
            width: w,
            height: h,
            mass: 20,
            friction: { normal: 0, angular: 0.01, x: 0.01, y: 0.01 },
            rotating: 1
        }));
        let sprite;
        car.AddComponent(sprite = new Lancelot.drawable.Rect({
            width: w,
            height: h,
            fillStyle: "black",
            strokeStyle: "white",
            strokeWidth: 2
        }), "Sprite");
        
        const createWheel = (x, y, r) => {
            
            const wheel = level.CreateEntity();
            wheel.groupList.add("wheel");
            wheel.position.Set(x,y);
            
            let wheelBody;
            wheel.AddComponent(wheelBody = new Lancelot.physics.Ball({
                radius: r,
                mass: r,
                friction: { normal: 1, angular: 0.01, x: 0.01, y: 0.01 },
            }));
            let wheelSprite;
            wheel.AddComponent(wheelSprite = new Lancelot.drawable.Circle({
                radius: r,
                fillStyle: "black",
                strokeStyle: "white",
                strokeWidth: 2,
                zIndex: 5
            }), "Sprite");
            
           
            for(let i = 0; i < 1; ++i) {
                
                body.Join(wheelBody, "stick", {
                    offset1: { x: x, y: y },
                });
            }
            
            wheelBody.AddBehavior("obst", "ResolveCollision")
            
            return wheel;
        }
        
        const wheels = [];
        
        wheels.push(createWheel(-w * 0.45, 0, h * 1.2));
        wheels.push(createWheel(w * 0.45, 0, h * 1.2));
        
        car.AddComponent(new CarController({

            wheels: wheels
        }));
        
        body.AddBehavior("obst", "ResolveCollision")
        
        level.camera.Follow(car);

    }
    
    const createObstacle = (x, y, w, h, a) => {
        const obst = level.CreateEntity();
        obst.groupList.add("obst");
        obst.position.Set(x, y);
        
        let body;
        obst.AddComponent(body = new Lancelot.physics.Box({
            width: w,
            height: h,
        }));
        body.angle = a;
        
        let sprite;
        obst.AddComponent(sprite = new Lancelot.drawable.Rect({
            width: w,
            height: h,
            strokeStyle: "orange",
            strokeWidth: 2
        }), "Sprite");
        sprite.angle = a;
    }
    
    const sin = (x) => {
        const progress = Lancelot.math.lerp(x / 50, 0, Math.PI * 4);
        return Math.sin(progress) * 200 + 100;
    }
    
    let curDiffH = 0;
    let curY = 300;
    let stepX = 40;
    for(let i = 0; i < 100; ++i) {
        curDiffH += Lancelot.math.rand(-5, 5);
        const lastY = sin(i);
        curY = sin(i + 1);
        const lastX = (i - 3) * stepX;
        const curX = (i - 2) * stepX;
        
        const lastPos = new Lancelot.Vector(lastX, lastY);
        const curPos = new Lancelot.Vector(curX, curY);
        const center = curPos.Clone().Add(lastPos).Mult(0.5);
        const ang = curPos.Clone().Sub(lastPos).Angle();
        
        createObstacle(center.x, center.y, curPos.Clone().Sub(lastPos).Mag() * 1, 20, ang)
    }

    createCar();
    
}
        
    </script>
    
</body>
</html>