<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        
    </style>
</head>
<body>
    
    <script type="module">
        import defaultExport from "../src/Lancelot.js";

        class CarController extends Lancelot.Component {
    constructor(params) {
        super();
        this.wheels = params.wheels;
    }
    Update(dt) {
        const body = this.parent.body;
        const sprite = this.GetComponent("Sprite");
        const flame = this.GetComponent("Flame");

        flame.angle = body.angle;

        if(body.position.y > 1000) {
            body.position.Set(0, -200);
            this.wheels[0].position.Set(body.width * 0.45, -200);
            this.wheels[1].position.Set(body.width * 0.45, -200);
        }
        
        const onGround = (this.wheels[0].body.collisions.all.size > 0 || this.wheels[1].body.collisions.all.size > 0);

        body.velocity.y += 500 * dt;
        
        sprite.angle = body.angle;
        const speed = 50;
        const rotSpeed = 15;

        if(this.scene.IsPressed("ArrowRight")) {
            if(!onGround) {
                body.angularVelocity -= rotSpeed * dt;
                
            } else {
                this.wheels[0].body.angularVelocity += speed * dt;
                this.wheels[1].body.angularVelocity += speed * dt;
            }
        }
        if(this.scene.IsPressed("ArrowLeft")) {
            if(!onGround) {
                body.angularVelocity += rotSpeed * dt;
            } else {
                this.wheels[0].body.angularVelocity -= speed * dt;
                this.wheels[1].body.angularVelocity -= speed * dt;
            }
        }
        if(this.scene.IsPressed("f")) {
            this.wheels[0].body.angularVelocity = 0;
            this.wheels[1].body.angularVelocity = 0;
        }

        for(let w of this.wheels) {
            const wbody = w.body;
            const wsprite = w.GetComponent("Sprite");
            
            
        
            wbody.velocity.y += 500 * dt;
        
            wsprite.angle = wbody.angle;
        }
    }
}

class ObstacleController extends Lancelot.Component {
    constructor() {
        super();
    }
    Update(dt) {
        const body = this.parent.body;
        const sprite = this.GetComponent("Sprite");

        if(body.mass != 0) {
            body.velocity.y += 500 * dt;
        }
        
        sprite.angle = body.angle;
    }
}

let game;

addEventListener("DOMContentLoaded", () => {
    
    game = new Lancelot.Game({
        width: 720,
        height: 480,
        preload: preload,
        init: init,
        controls: {
            active: true,
        }
    });
    
});

function preload() {
    this.loader.AddImage("sl", "https://www.sololearn.com/Icons/Avatars/1.jpg");
}

function init() {
    
    const level = this.CreateScene("level", {
        background: "silver",
        light: "#FFFFFF",
        physics: {
            iterations: 3,
            bounds: [[-200, -2100], [7900, 2400]]
        }
    });
    
    level.Play();
    
    
    const createCar = () => {
        
        const w = 128, h = 32;
        const car = level.CreateEntity();
        car.groupList.add("car");
        
        let body;
        car.AddComponent(body = new Lancelot.physics.Box({
            width: w,
            height: h,
            mass: 20,
            friction: { normal: 0, angular: 0.01, x: 0.01, y: 0.01 },
            rotation: 1
        }));
        let sprite;
        car.AddComponent(sprite = new Lancelot.drawable.Rect({
            width: w,
            height: h,
            fillStyle: "white",
            strokeStyle: "black",
            strokeWidth: 2
        }), "Sprite");
        
        const createWheel = (x, y, r) => {
            
            const wheel = level.CreateEntity();
            wheel.groupList.add("wheel");
            wheel.position.Set(x,y);
            
            let wheelBody;
            wheel.AddComponent(wheelBody = new Lancelot.physics.Ball({
                radius: r,
                mass: r,
                friction: { normal: 1, angular: 0.01, x: 0.01, y: 0.01 },
            }));
            let wheelSprite;
            wheel.AddComponent(wheelSprite = new Lancelot.drawable.Circle({
                radius: r,
                fillStyle: "black",
                strokeStyle: "black",
                strokeWidth: 2,
                zIndex: 5,
                image: {
                    src: "sl"
                }
            }), "Sprite");
            
           
            for(let i = 0; i < 1; ++i) {
                
                body.Join(wheelBody, "stick", {
                    offset1: { x: x, y: y },
                    strength: 1
                });
            }
            
            wheelBody.AddBehavior("obst", "ResolveCollision")
            
            return wheel;
        }
        
        const wheels = [];
        
        wheels.push(createWheel(-w * 0.45, 0, h * 1.2));
        wheels.push(createWheel(w * 0.45, 0, h * 1.2));
        
        car.AddComponent(new CarController({

            wheels: wheels
        }));
        
        body.AddBehavior("obst", "ResolveCollision")
        
        level.camera.Follow(car);
        return car;
    }
    
    const createObstacle = (x, y, w, h, a, m) => {
        const obst = level.CreateEntity();
        obst.groupList.add("obst");
        obst.position.Set(x, y);
        
        let body;
        obst.AddComponent(body = new Lancelot.physics.Box({
            width: w,
            height: h,
            mass: m,
            friction: { x: 0.01, y: 0.01, angular: 0.01 }
        }));
        body.angle = a;
        
        let sprite;
        obst.AddComponent(sprite = new Lancelot.drawable.Rect({
            width: w,
            height: h,
            strokeStyle: "black",
            fillStyle: "white",
            strokeWidth: 2
        }), "Sprite");
        sprite.angle = a;

        obst.AddComponent(new ObstacleController());

        return obst;
    }
    
    const sin = (x) => {
        const progress = Lancelot.math.lerp(x / count, 0, Math.PI * (count / 10));
        return Math.sin(progress) * (x / count) * 300 + 100;
    }
    
    let curDiffH = 0;
    let curY = 300;
    let stepX = 50;
    const count = 160;
    let prevObst;
    for(let i = 0; i < count; ++i) {
        curDiffH += Lancelot.math.rand(-5, 5);
        const lastY = sin(i, count);
        curY = sin(i + 1, count);
        const lastX = (i - 3) * stepX;
        const curX = (i - 2) * stepX;
        
        const lastPos = new Lancelot.Vector(lastX, lastY);
        const curPos = new Lancelot.Vector(curX, curY);
        const center = curPos.Clone().Add(lastPos).Mult(0.5);
        const ang = curPos.Clone().Sub(lastPos).Angle();
        
        let curObst = createObstacle(center.x, center.y, curPos.Clone().Sub(lastPos).Mag() * 1, 20, ang, (i % 10 == 0 || i % 10 == 9) ? 0 : 50);
        if(prevObst) {
            prevObst.body.Join(curObst.body, "spring", {
                strength: 0.99,
                offset1: { x: prevObst.body.width / 2},
                offset2: { x: -curObst.body.width / 2 }
            });
        }
        prevObst = curObst;
    }

    let car = createCar();
    
    let text;
    
    let emitter;
    car.AddComponent(emitter = new Lancelot.particles.Emitter({
        width: 800,
        options: {
            angle: 0,
            force: { y: 750 },
            lifetime: 2000,
            rotationSpeed: 5,
            speed: 0,
            friction: { min: 0.01, max: 0.02 }
        }
    }));
    emitter.offset.y = -500;
    emitter.Add(Lancelot.drawable.Rect, {
        width: 16,
        height: 16,
        fillStyle: "blueviolet",
        zIndex: 50
    });
    emitter.Add(Lancelot.drawable.Circle, {
        radius: 8,
        fillStyle: "crimson",
        zIndex: 50
    });
    emitter.Add(Lancelot.drawable.Polygon, {
        radius: 12,
        sides: 3,
        fillStyle: "purple",
        zIndex: 50
    });
    emitter.Add(Lancelot.drawable.Rect, {
        width: 16,
        height: 16,
        fillStyle: "deeppink",
        zIndex: 50
    });
    emitter.Add(Lancelot.drawable.Circle, {
        radius: 8,
        fillStyle: "dodgerblue",
        zIndex: 50
    });
    emitter.Add(Lancelot.drawable.Polygon, {
        radius: 12,
        sides: 3,
        fillStyle: "indigo",
        zIndex: 50
    });
    emitter.Add(Lancelot.drawable.Rect, {
        width: 16,
        height: 16,
        fillStyle: "midnightblue",
        zIndex: 50
    });
    emitter.Emit(1, true, 20);

    let flame;
    car.AddComponent(flame = new Lancelot.particles.Emitter({
        angle: -Math.PI / 2,
        options: {
            lifetime: 1000,
            opacity: { to: 0 },
            speed: 20,
            variance: 5
        }
    }), "Flame");
    flame.Add(Lancelot.drawable.Circle, {
        radius: 16,
        fillStyle: "radial-gradient;0,0,0,0,0,16;rgb(255,100,0)=0;rgba(255,100,0,0)=1",
        zIndex: -1
    });
    flame.Add(Lancelot.drawable.Circle, {
        radius: 16,
        fillStyle: "radial-gradient;0,0,0,0,0,16;black=0;rgba(0,0,0,0)=1",
        zIndex: -1
    });
    flame.Emit(1, true, 20);
    
    text = level.CreateEntity();
    text.AddComponent(new Lancelot.drawable.Text({
        text: "Controls:\nMOVE LEFT - joystick / left arrow\nMOVE RIGHT - joystick / right arrow\nBREAK - B / F",
        fillStyle: "darkblue",
        fontSize: 32,
        align: "left",
        fontStyle: "italic",
        zIndex: -1
    }));
    text.position.Set(100, 0);
    
}
        
    </script>
    
</body>
</html>