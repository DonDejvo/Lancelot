var rt=Object.defineProperty;var ie=(o,t,e)=>t in o?rt(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var se=o=>rt(o,"__esModule",{value:!0});var at=(o,t)=>{se(o);for(var e in t)rt(o,e,{get:t[e],enumerable:!0})};var Ht=(o,t,e)=>(ie(o,typeof t!="symbol"?t+"":t,e),e);var E=class{_toLoad=[];_size=0;_counter=0;_path="";_onProgressHandler=null;_add(t,e,i){let s;e.startsWith("/")?s=this._path+e.slice(1):s=this._path+e,this._toLoad.push({name:t,path:s,type:i}),++this._size}image(t,e){this._add(t,e,"image")}audio(t,e){this._add(t,e,"audio")}json(t,e){this._add(t,e,"json")}font(t,e){this._add(t,e,"font")}onProgress(t){this._onProgressHandler=t}setPath(t){this._path=t,this._path.endsWith("/")||(this._path+="/")}load(t){let e=new Map;if(this._size===0){t(e);return}for(let i of this._toLoad)switch(i.type){case"image":E.loadImage(i.path,s=>{this._handleCallback(e,i,s,t)});break;case"audio":E.loadAudio(i.path,s=>{this._handleCallback(e,i,s,t)});break;case"json":E.loadJSON(i.path,s=>{this._handleCallback(e,i,s,t)});break;case"font":E.loadFont(i.name,i.path,s=>{this._handleCallback(e,i,s,t)})}}_handleCallback(t,e,i,s){t.set(e.name,i),++this._counter,this._onProgressHandler&&this._onProgressHandler(this._counter/this._size,e.path),this._counter===this._size&&(this._counter=this._size=0,this._toLoad=[],s(t))}static loadImage(t,e){let i=new Image;i.src=t,i.addEventListener("load",()=>{e(i)},{once:!0})}static loadAudio(t,e){let i=new Audio(t);i.load(),i.addEventListener("canplaythrough",()=>{e(i)},{once:!0})}static loadJSON(t,e){fetch(t).then(i=>i.json()).then(i=>e(i))}static loadFont(t,e,i){new FontFace(t,`url(${e})`).load().then(n=>{document.fonts.add(n),i(t)})}};var p=function(){return{parseValue(o,t){return o!==void 0&&(typeof o==typeof t||t===null)?o:t},parseObject(o,t){if(o)for(let e in t)t[e]=typeof t[e]=="object"&&!Array.isArray(t[e])&&t[e]!==null?this.parseObject(o[e],t[e]):this.parseValue(o[e],t[e]),typeof t[e]=="object"&&!Array.isArray(t[e])&&t[e]!==null?t[e].min!==void 0&&t[e].max!==void 0?t[e]=this.parseMinMax(o[e],t[e]):t[e]=this.parseObject(o[e],t[e]):t[e]=this.parseValue(o[e],t[e]);return t},parseMinMax(o,t){if(o===void 0)return t;if(typeof o=="number")return{min:o,max:o};if(typeof o=="object"&&!Array.isArray(o)&&o!==null){let e,i;if(typeof o.min=="number"&&o.min<=t.max?e=o.min:e=t.min,typeof o.max=="number"&&o.max>=t.min?i=o.max:i=t.max,e<=i)return{min:e,max:i}}return t}}}();var ht=class{_fps=60;_frameCounter=0;_timeCounter=0;get fps(){return this._fps}update(t){this._timeCounter+=t,++this._frameCounter,this._timeCounter>=1&&(this._timeCounter-=1,this._fps=this._frameCounter,this._frameCounter=0)}};var lt=class{_paused=!0;_step;_fpsMeter=new ht;_minFps=20;constructor(t){this._step=t}get paused(){return this._paused}_RAF(){this._frame=window.requestAnimationFrame(t=>{this._paused||this._RAF();let e=t-this._previousRAF;this._fpsMeter.update(e*.001),this._step(Math.min(e,1e3/this._minFps)),this._previousRAF=t})}start(){this._paused=!1,this._previousRAF=performance.now(),this._RAF()}stop(){this._paused=!0,window.cancelAnimationFrame(this._frame)}};var dt=class{_width;_height;_aspect;_scale;_parentElement;_container;_canvas;_context;_quality;constructor(t,e,i=1,s=document.body){this._width=t,this._height=e,this._quality=i,this._parentElement=s,this._aspect=this._width/this._height,this._scale=1,this._initContainer(),this._initCanvas(),this._onResize(),window.addEventListener("resize",()=>this._onResize())}get canvas(){return this._canvas}render(t){let e=this._context;e.beginPath(),e.clearRect(0,0,this._width,this._height);let i=this._width*this._quality,s=this._height*this._quality;for(let n=t.length-1;n>=0;--n){let r=t[n];r.hidden||(r.paused||r.render(i,s,this._quality),r.draw(e,i,s,this._quality))}}displayToSceneCoords(t,e,i){let s=this._canvas.getBoundingClientRect(),n=(e-s.x)/this._scale,r=(i-s.y)/this._scale,a=t.camera;return{x:(n-this._width/2)/a.scale+a.position.x,y:(r-this._height/2)/a.scale+a.position.y}}_initContainer(){let t=this._container=document.createElement("div");t.style.width=this._width+"px",t.style.height=this._height+"px",t.style.position="relative",t.style.left="50%",t.style.top="0%",t.style.transformOrigin="center",this._parentElement.appendChild(t)}_initCanvas(){let t=this._canvas=document.createElement("canvas");t.width=this._width*this._quality,t.height=this._height*this._quality,this._context=t.getContext("2d"),t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.width="100%",t.style.height="100%",t.style.display="block",t.style.imageRendering="pixelated",this._container.appendChild(t)}_onResize(){let[t,e]=[this._parentElement.clientWidth,this._parentElement.clientHeight];t/e>this._aspect?this._scale=e/this._height:this._scale=t/this._width,this._container.style.transform="translate(-50%, calc(-50% + "+this._height/2*this._scale+"px)) scale("+this._scale+")",this._context.imageSmoothingEnabled=!1}};var ut=class{_scenes=[];get scenes(){return this._scenes.map(t=>t.scene)}add(t,e,i=0){let s={scene:t,name:e,zIndex:i};this._scenes.push(s);for(let n=this._scenes.length-1;n>0&&!(s.zIndex<this._scenes[n-1].zIndex);--n)[this._scenes[n],this._scenes[n-1]]=[this._scenes[n-1],this._scenes[n]]}get(t){return this._scenes.find(e=>e.name==t).scene}setZIndex(t,e){let i=this.get(t);i&&(this.remove(t),this.add(i,t,e))}remove(t){let e=this._scenes.findIndex(i=>i.name==t);return e!=-1?(this._scenes.splice(e,1),!0):!1}};var d=class{_x;_y;constructor(t=0,e=0){this._x=t,this._y=e}get x(){return this._x}get y(){return this._y}set x(t){this.set(t,this.y)}set y(t){this.set(this.x,t)}set(t,e){this._x=t,this._y=e}copy(t){return this.set(t.x,t.y),this}clone(){return new d(this.x,this.y)}add(t){return this.set(this.x+t.x,this.y+t.y),this}sub(t){return this.set(this.x-t.x,this.y-t.y),this}mult(t){return this.set(this.x*t,this.y*t),this}norm(){return this.set(this.y,-this.x),this}unit(){let t=this.mag();return t===0?this:(this.set(this.x/t,this.y/t),this)}mag(){return Math.hypot(this.x,this.y)}lerp(t,e){return this.add(t.clone().sub(this).mult(e))}angle(){return Math.atan2(this.y,this.x)}rot(t){let e=Math.sin(t),i=Math.cos(t),s=this.x*i-this.y*e,n=this.x*e+this.y*i;return this.set(s,n),this}static fromAngle(t){return new d(1,0).rot(t)}static dot(t,e){return t.x*e.x+t.y*e.y}static dist(t,e){return t.clone().sub(e).mag()}static cross(t,e){return t.x*e.y-t.y*e.x}static angleBetween(t,e){let i=t.mag(),s=e.mag();return i===0||s===0?0:Math.acos(d.dot(t,e)/(i*s))}},tt=class extends d{_onChangeCallback;constructor(t,e=0,i=0){super(e,i);this._onChangeCallback=t}set(t,e){(t!=this.x||e!=this.y)&&(this._x=t,this._y=e,this._onChangeCallback())}};var O=class{_timeouts=[];set(t,e){let i={action:t,dur:e,counter:0};return this._timeouts.push(i),i}clear(t){let e=this._timeouts.indexOf(t);e!=-1&&this._timeouts.splice(e,1)}update(t){for(let e=0;e<this._timeouts.length;++e){let i=this._timeouts[e];(i.counter+=t)>=i.dur&&(i.action(),this._timeouts.splice(e--,1))}}};var y=function(){return{rand(o,t){return Math.random()*(t-o)+o},randint(o,t){return Math.floor(Math.random()*(t-o+1)+o)},lerp(o,t,e){return t+(e-t)*o},clamp(o,t,e){return Math.min(Math.max(o,t),e)},isBetween(o,t,e){return o>=t&&o<=e},sat(o){return this.clamp(o,0,1)},choice(o){let t=o.length;return o[this.randint(0,t-1)]},shuffle(o){let t=o.length;for(let e=0;e<t;++e){let i=this.randint(0,t-1);[o[e],o[i]]=[o[i],o[e]]}},easeIn(o){return Math.cos(Math.PI*(1+.5*o))+1},easeOut(o){return Math.sin(Math.PI*.5*o)},easeInOut(o){return Math.cos(Math.PI*(1+o))/2+.5}}}();var _t=class{_resources;_bgmusic;_effects;constructor(t){this._resources=t,this._effects=new qt(this._resources),this._music=new Ft(this._resources)}get music(){return this._music}get effects(){return this._effects}},Ft=class{_resources;_paused=!0;_audio=null;_volume=1;_speed=1;_loop=!1;constructor(t){this._resources=t}get volume(){return this._volume}set volume(t){this._volume=y.sat(t),this._set()}get speed(){return this._speed}set speed(t){t>0&&(this._speed=t,this._set())}get loop(){return this._loop}set loop(t){this._loop=t,this._set()}get time(){return this._audio?this._audio.currentTime:0}set time(t){this._audio&&(this._audio.currentTime=y.clamp(t,0,this._audio.duration))}get paused(){return this._paused}set(t){this._paused||this._audio.pause(),this._audio=this._resources.get(t).cloneNode(!0),this._set(),this._paused||this.play()}play(){if(this._paused=!1,this._audio){let t=this._audio.play();t&&t.then(e=>{}).catch(e=>{})}}pause(){if(this._paused=!0,this._audio)try{this._audio.pause()}catch(t){console.log(t)}}_set(){this._audio&&(this._audio.volume=this._volume,this._audio.playbackRate=this._speed,this._audio.loop=this._loop)}},qt=class{_resources;_volume=1;_arr=[];constructor(t){this._resources=t}get volume(){return this._volume}set volume(t){this._volume=y.sat(t);for(let e of this._arr)e.volume=this._volume}play(t,e={}){let i=p.parseValue(e.speed,1),s=this._resources.get(t).cloneNode(!0);s.addEventListener("ended",()=>{let r=this._arr.indexOf(s);r!=-1&&this._arr.splice(r,1)}),s.volume=this._volume,s.playbackRate=i,this._arr.push(s);let n=s.play();n&&n.then(r=>{}).catch(r=>{})}};var ct=class{_resources=null;_config;_width;_height;_init;_preload;_parentElement;_renderer;_load=new E;_sceneManager=new ut;_engine;_timeout=new O;_audio=null;_quality;constructor(t){this._config=t,this._width=t.width,this._height=t.height,this._quality=p.parseValue(t.quality,1),this._init=t.init.bind(this);let e;(e=p.parseValue(t.preload,null))!==null&&(this._preload=e.bind(this)),this._parentElement=p.parseValue(t.parentElement,document.body);let i=this._parentElement;i.style.WebkitUserSelect="none",i.style.userSelect="none",i.style.touchAction="none",i.style.overflow="hidden",this._renderer=new dt(this._width,this._height,this._quality,this._parentElement);let s=n=>{this._timeout.update(n);let r=this._sceneManager.scenes;for(let a of r)a._update(n*.001);this._renderer.render(r)};this._engine=new lt(s),this._initEventListeners(),this._initControls(),this._engine.start(),this._preload?(this._preload(),this._load.load(n=>{this._resources=n,this._audio=new _t(this._resources),this._init()})):this._init()}get width(){return this._width}get height(){return this._height}get load(){return this._load}get resources(){return this._resources}get timeout(){return this._timeout}get audio(){return this._audio}get quality(){return this._quality}set quality(t){this._quality=t,this._renderer._quality=this._quality,this._renderer._canvas.remove(),this._renderer._initCanvas();for(let e of this._sceneManager.scenes)e._buffer=null}get(t){let e=this._sceneManager.get(t);return e||null}requestFullScreen(){try{let t=this._parentElement,e=t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen;e&&e.call(t)}catch(t){console.log(t)}}_initEventListeners(){let t="ontouchstart"in document,e=this._renderer._container;t?(e.addEventListener("touchstart",i=>this._handleTouchEvent(i)),e.addEventListener("touchmove",i=>this._handleTouchEvent(i)),e.addEventListener("touchend",i=>this._handleTouchEvent(i))):(e.addEventListener("mousedown",i=>this._handleMouseEvent(i)),e.addEventListener("mousemove",i=>this._handleMouseEvent(i)),e.addEventListener("mouseup",i=>this._handleMouseEvent(i))),addEventListener("keydown",i=>this._handleKeyEvent(i)),addEventListener("keyup",i=>this._handleKeyEvent(i))}_handleKeyEvent(t){t.preventDefault(),this._handleSceneEvent(t.type,{key:t.key})}_handleTouchEvent(t){t.preventDefault();let e={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"};for(let i=0;i<t.changedTouches.length;++i)this._handleSceneEvent(e[t.type],{x:t.changedTouches[i].pageX,y:t.changedTouches[i].pageY,id:t.changedTouches[i].identifier})}_handleMouseEvent(t){t.preventDefault(),this._handleSceneEvent(t.type,{x:t.pageX,y:t.pageY,id:0})}_handleSceneEvent(t,e){for(let i of this._sceneManager.scenes){let s=Object.assign({},e);if(t.startsWith("mouse")){let n=this._renderer.displayToSceneCoords(i,s.x,s.y);s.x=n.x,s.y=n.y}if(i.handleEvent(t,s,this._renderer))break}}_initControls(){let t=p.parseObject(this._config.controls,{active:!1,left:1,right:1,sideButtons:!0,actionButtons:!0,joystickRange:{min:0,max:100},theme:"dark",layout:{DPad:{left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown"},X_Button:"e",Y_Button:"d",A_Button:"s",B_Button:"f",L_Button:"Control",R_Button:"Control",START_Button:" ",SELECT_Button:"Tab"}});if(!t.active||!("ontouchstart"in document))return;let e,i;switch(t.theme){case"light":e="black",i="white";break;default:e="white",i="black"}let s=t.layout,n=(f,c=!0)=>{f.style.pointerEvents="auto",f.style.position="absolute",f.style.border="2px solid "+e,f.style.color=e,f.style.fontFamily="Arial",f.style.display="flex",f.style.alignItems="center",f.style.justifyContent="center",c&&(f.style.background=i)},r=(f,c,C)=>{let m=document.createElement("div");return m.classList.add("l_button","l_element"),m.style.width="46px",m.style.height="46px",m.style.right=f-5+"px",m.style.bottom=c+10+"px",m.textContent=C,m.style.borderRadius="50%",m.style.fontSize="22px",n(m),u.appendChild(m),m},a=f=>{let c=document.createElement("div");return c.classList.add("l_side-button","l_element"),c.style.width="46px",c.style.height="46px",c.style.bottom=190+"px",c.style.fontSize="22px",f=="left"?(c.style.left=5+"px",c.textContent="L",c.style.borderRadius="50% 0 0 50%"):f=="right"&&(c.style.right=5+"px",c.textContent="R",c.style.borderRadius="0 50% 50% 0"),n(c),u.appendChild(c),c},l=f=>{let c=document.createElement("div");return c.classList.add("l_action-button","l_element"),c.style.width="50px",c.style.height="22px",f=="Start"?c.style.left="calc(50% + "+3+"px)":f=="Select"&&(c.style.right="calc(50% + "+3+"px)"),c.style.bottom=20+"px",c.textContent=f,c.style.borderRadius="12px",c.style.fontSize="12px",c.style.fontWeight="bolder",n(c),u.appendChild(c),c},u=document.createElement("div");u.style.width="100%",u.style.height="100%",u.style.left="0",u.style.top="0",u.style.zIndex="999",u.style.position="fixed",u.style.pointerEvents="none";let h={},_=document.createElement("div");_.classList.add("l_dpad","l_element"),_.style.width="120px",_.style.height="120px",_.style.left="15px",_.style.bottom="50px",_.style.borderRadius="50%",_.style.overflow="hidden",n(_),u.appendChild(_);for(let f=0;f<4;++f){let c=document.createElement("div");c.style.width="120px",c.style.height="120px",c.style.left=-75+150*(f%2)+"px",c.style.top=-75+150*Math.floor(f/2)+"px",n(c,!1),_.appendChild(c)}let g=document.createElement("div");g.classList.add("l_joystick","l_element"),g.style.width="120px",g.style.height="120px",g.style.right="15px",g.style.bottom="50px",g.style.borderRadius="50%",n(g),u.appendChild(g);let b=-1,w=-1,x=document.createElement("div");x.style.width="60px",x.style.height="60px",x.style.left="0",x.style.top="0",x.style.borderRadius="50%",n(x),g.appendChild(x),x.style.display="none";let F=(f,c,C)=>{let m=g.getBoundingClientRect();c=c-(m.x+m.width/2),C=C-(m.y+m.height/2);let v=new d(c,C),P=v.mag();P>60&&v.unit().mult(60);let q=v.clone().unit().mult(y.lerp(y.sat(P/60),t.joystickRange.min,t.joystickRange.max));x.style.left=v.x+m.width/4+"px",x.style.top=v.y+m.height/4+"px";let N=this._renderer._container.getBoundingClientRect();this._handleSceneEvent(f,{x:q.x+N.x+N.width/2,y:q.y+N.y+N.height/2,id:-1})};g.addEventListener("touchstart",f=>{f.preventDefault(),F("mousedown",f.changedTouches[0].pageX,f.changedTouches[0].pageY),b=f.changedTouches[0].identifier,x.style.display="block"}),g.addEventListener("touchmove",f=>{f.preventDefault();for(let c=0;c<f.changedTouches.length;++c)if(f.changedTouches[c].identifier==b){F("mousemove",f.changedTouches[c].pageX,f.changedTouches[c].pageY);break}}),g.addEventListener("touchend",f=>{f.preventDefault();for(let c=0;c<f.changedTouches.length;++c)if(f.changedTouches[c].identifier==b){F("mouseup",f.changedTouches[c].pageX,f.changedTouches[c].pageY),b=-1,x.style.display="none";break}}),h.DPad=_,h.A_Button=r(10,63,"A"),h.B_Button=r(63,10,"B"),h.X_Button=r(63,116,"X"),h.Y_Button=r(116,63,"Y"),h.L_Button=a("left"),h.R_Button=a("right"),h.SELECT_Button=l("Select",-20),h.START_Button=l("Start",20),this._parentElement.appendChild(u);let j={left:{v:new d(-1,0),n:"left"},right:{v:new d(1,0),n:"right"},up:{v:new d(0,-1),n:"up"},down:{v:new d(0,1),n:"down"}},K=(f,c)=>{let C=_.getBoundingClientRect();f=f-(C.x+C.width/2),c=c-(C.y+C.height/2);let m=new d(f,c);if(m.mag()<20)return[];let v=m.clone().unit(),P=[];return d.dot(v,j.left.v)>=.5&&P.push(j.left.n),d.dot(v,j.right.v)>=.5&&P.push(j.right.n),d.dot(v,j.up.v)>=.5&&P.push(j.up.n),d.dot(v,j.down.v)>=.5&&P.push(j.down.n),P},B=(f,c,C)=>{for(let m of c)this._handleSceneEvent(f,{key:C[m]})};for(let f in h){let c=h[f],C=s[f];if(f=="DPad"){c.addEventListener("touchstart",m=>{m.preventDefault();let v=K(m.changedTouches[0].pageX,m.changedTouches[0].pageY);w=m.changedTouches[0].identifier,B("keydown",v,C)}),c.addEventListener("touchmove",m=>{m.preventDefault();for(let v=0;v<m.changedTouches.length;++v)if(m.changedTouches[v].identifier==w){B("keyup",["left","right","up","down"],C);let P=K(m.changedTouches[v].pageX,m.changedTouches[v].pageY);B("keydown",P,C)}}),c.addEventListener("touchend",m=>{m.preventDefault();for(let v=0;v<m.changedTouches.length;++v)m.changedTouches[v].identifier==w&&(w=-1,B("keyup",["left","right","up","down"],C))});continue}c.addEventListener("touchstart",m=>{m.preventDefault(),this._handleSceneEvent("keydown",{key:C})}),c.addEventListener("touchmove",m=>{m.preventDefault(),this._handleSceneEvent("keydown",{key:C})}),c.addEventListener("touchend",m=>{m.preventDefault(),this._handleSceneEvent("keyup",{key:C})})}switch(t.left){case 0:_.style.display="none";break}t.left==0&&(_.style.display="none"),(t.right==2||t.right==0)&&(h.X_Button.style.display="none",h.Y_Button.style.display="none",h.A_Button.style.display="none",h.B_Button.style.display="none"),(t.right==1||t.right==0)&&(g.style.display="none"),t.sideButtons||(h.L_Button.style.display="none",h.R_Button.style.display="none"),t.actionButtons||(h.START_Button.style.display="none",h.SELECT_Button.style.display="none")}};var T=class{_value;_anim=null;constructor(t){this._value=t}get value(){return this._value}set value(t){this._value=t}animate(t,e,i="linear",s=null){this._anim={counter:0,dur:e,from:this._value,to:t,timing:i,onEnd:s}}isAnimating(){return this._anim!==null}stopAnimating(){this._anim=null}update(t){if(this._anim){let e=this._anim;e.counter+=t*1e3;let i=y.sat(e.counter/e.dur),s;switch(e.timing){case"linear":s=i;break;case"ease-in":s=y.easeIn(i);break;case"ease-out":s=y.easeOut(i);break;case"ease-in-out":s=y.easeInOut(i);break;default:s=i}this._value=y.lerp(s,e.from,e.to),i==1&&(this.stopAnimating(),e.onEnd&&e.onEnd())}}};var Q=class{_pos;_parent=null;_fixed=!1;_offset;_attached=[];_anim=null;constructor(){this._pos=new tt(this._onPositionChange.bind(this)),this._offset=new tt(this._onOffsetChange.bind(this))}get position(){return this._pos}set position(t){this._pos.copy(t)}get offset(){return this._offset}set offset(t){this._offset.copy(t)}clip(t,e=!1){this._attached.push(t),t._parent=this,t._fixed=e,t._offset.copy(t.position.clone().sub(this._pos))}unclip(t){let e=this._attached.indexOf(t);e!=-1&&(this._attached.splice(e,1),t._parent=null)}moveTo(t,e,i="linear",s=null){this._anim={counter:0,dur:e,from:this.position.clone(),to:t,timing:i,onEnd:s}}moveBy(t,e,i="linear",s=null){this.moveTo(this.position.clone().add(t),e,i,s)}stopMoving(){this._anim=null}isMoving(){return this._anim!=null}update(t){if(this._anim){let e=this._anim;e.counter+=t*1e3;let i=y.sat(e.counter/e.dur),s;switch(e.timing){case"linear":s=i;break;case"ease-in":s=y.easeIn(i);break;case"ease-out":s=y.easeOut(i);break;case"ease-in-out":s=y.easeInOut(i);break;default:s=i}this._pos.copy(e.from.clone().lerp(e.to,s)),i==1&&(this.stopMoving(),e.onEnd&&e.onEnd())}}_onPositionChange(){this._parent&&(this._fixed?this._parent.position.copy(this._pos.clone().sub(this._offset)):this._offset.copy(this._pos.clone().sub(this._parent.position)));for(let t of this._attached)t.position.copy(this._pos.clone().add(t._offset))}_onOffsetChange(){this._parent&&this._fixed&&this._pos.copy(this._parent.position.clone().add(this._offset))}};var S=class{_type="";_parent=null;_position=new Q;_angle=new T(0);get type(){return this._type}get scene(){return this._parent._scene}get parent(){return this._parent}get position(){return this._position.position}set position(t){this._position.position=t}get offset(){return this._position.offset}set offset(t){this._position.offset=t}get angle(){return this._angle.value}set angle(t){this._angle.value=t}initComponent(){}getComponent(t){return this._parent.getComponent(t)}rotate(t,e,i="linear",s=null){this._angle.animate(t,e,i,s)}update(t){}};var et=class extends S{_eventHandlers=new Map;_id=-1;constructor(){super();this._type="interactive"}on(t,e,i=!1){this._eventHandlers.has(t)||this._eventHandlers.set(t,[]),this._eventHandlers.get(t).push({handler:e,capture:i})}off(t,e){if(!this._eventHandlers.has(t))return;let i=this._eventHandlers.get(t),s=i.findIndex(n=>n.handler==e);s!=-1&&i.splice(s,1)}handleEvent(t,e){if(!this._eventHandlers.has(t))return!1;let i=!1,s=this._eventHandlers.get(t);for(let n of s)n.handler(e),n.capture&&(i=!0);return i}};var it=class{constructor(t,e,i,s,n=null){this.x=t,this.y=e,this.w=i,this.h=s,this.entity=n}_vsAabb(t){return this.x+this.w/2>=t.x-t.w/2&&this.x-this.w/2<=t.x+t.w/2&&this.y+this.h/2>=t.y-t.h/2&&this.y-this.h/2<=t.y+t.h/2}},V=class{_bounds;_limit;_aabb;_divided=!1;_data=[];_topLeft=null;_topRight=null;_bottomLeft=null;_bottomRight=null;_maxRecursionDepth=5;constructor(t,e){this._bounds=t;let i=t[1][0]-t[0][0],s=t[1][1]-t[0][1];this._aabb=new it(t[0][0]+i/2,t[0][1]+s/2,i,s),this._limit=e}newClient(t,e){let i=new it(t[0],t[1],e[0],e[1]);return this._insert(i),i}updateClient(t){this._insert(t)}findNear(t,e){let[i,s]=e,[n,r]=t,a=new it(n,r,i,s),l=this._search(a);return l==null?[]:Array.from(l)}clear(){this._data=[],this._divided=!1,this._topRight=null,this._topLeft=null,this._bottomLeft=null,this._bottomRight=null}draw(t){t.beginPath(),t.strokeStyle="white",t.strokeRect(this._aabb.x-this._aabb.w/2,this._aabb.y-this._aabb.h/2,this._aabb.w,this._aabb.h),this._divided&&(this._topLeft.draw(t),this._topRight.draw(t),this._bottomLeft.draw(t),this._bottomRight.draw(t))}_divide(){let t=this._bounds,e=t[1][0]-t[0][0],i=t[1][1]-t[0][1];this._topLeft=new V([[t[0][0],t[0][1]],[t[0][0]+e/2,t[0][1]+i/2]],this._limit),this._topRight=new V([[t[0][0]+e/2,t[0][1]],[t[0][0]+e,t[0][1]+i/2]],this._limit),this._bottomLeft=new V([[t[0][0],t[0][1]+i/2],[t[0][0]+e/2,t[0][1]+i]],this._limit),this._bottomRight=new V([[t[0][0]+e/2,t[0][1]+i/2],[t[0][0]+e,t[0][1]+i]],this._limit);for(let s of this._data)this._topLeft._insert(s),this._topRight._insert(s),this._bottomLeft._insert(s),this._bottomRight._insert(s);this._divided=!0}_search(t,e){if(e==null&&(e=new Set),!!t._vsAabb(this._aabb)){if(this._divided)this._topLeft._search(t,e),this._topRight._search(t,e),this._bottomLeft._search(t,e),this._bottomRight._search(t,e);else for(let i of this._data)t._vsAabb(i)&&e.add(i);return e}}_insert(t,e=0){if(!this._aabb._vsAabb(t))return!1;if(this._data.length<this._limit||e>this._maxRecursionDepth)return this._data.push(t),!0;this._divided||this._divide(),this._topLeft._insert(t,e+1),this._topRight._insert(t,e+1),this._bottomLeft._insert(t,e+1),this._bottomRight._insert(t,e+1)}};var pt=class{_relaxationCount;_gravity;_quadtree=null;_bodies=[];_joints=[];constructor(t={}){if(this._relaxationCount=p.parseValue(t.relaxationCount,1),this._gravity=p.parseValue(t.gravity,new d),this._isQuadtree=p.parseValue(t.quadtree,!1),this._isQuadtree){let e=p.parseValue(t.bounds,[[-1e3,-1e3],[1e3,1e3]]),i=p.parseObject(t.cellDimension,{width:100,height:100}),s=p.parseValue(t.cellLimit,10);this._quadtree=new V(e,s)}}get quadtree(){return this._quadtree}get gravity(){return this._gravity}set gravity(t){this._gravity=t}findNear(t,e){return this._isQuadtree?this.quadtree.findNear(t,e).map(i=>i.entity):this.findNearWithoutQuadtree(t,e)}findNearWithoutQuadtree(t,e){let[i,s]=e,[n,r]=t;return this._bodies.filter(a=>{let l=a.getBoundingRect();return(n+i/2-(a.position.x-l.width/2))*(n-i/2-(a.position.x+l.width/2))<=0&&(r+s/2-(a.position.y-l.height/2))*(r-s/2-(a.position.y+l.height/2))<=0}).map(a=>a.parent)}addJoint(t){this._joints.push(t)}removeJoint(t){let e=this._joints.indexOf(t);e!=-1&&this._joints.splice(e,1)}addBody(t,e){t._body=e,this._isQuadtree&&t.addComponent(new Nt({quadtree:this._quadtree})),this._bodies.push(e)}removeBody(t,e){let i=this._bodies.indexOf(e);if(i!=-1){for(let s of e._joints){let n=s._body2;n._joints.splice(n._joints.indexOf(s),1),this.removeJoint(s)}this._bodies.splice(i,1)}}update(t){for(let e of this._bodies)e._collisions.left.clear(),e._collisions.right.clear(),e._collisions.top.clear(),e._collisions.bottom.clear(),e._collisions.all.clear();for(let e of this._bodies)e.mass!=0&&e.velocity.add(this._gravity.clone().mult(t)),e.updatePosition(t);for(let e of this._joints)e.update(t);for(let e=0;e<this._relaxationCount;++e)for(let i of this._bodies)i.handleBehavior();if(this._isQuadtree){this._quadtree.clear();for(let e of this._bodies)e.getComponent("QuadtreeController").updateClient()}}},Nt=class extends S{_quadtree;_client=null;constructor(t){super();this._quadtree=t.quadtree}initComponent(){let t=[this._parent.body.position.x,this._parent.body.position.y],e=this._parent.body.getBoundingRect();this._client=this._quadtree.newClient(t,[e.width,e.height]),this._client.entity=this._parent}findNearby(t,e){return this._quadtree.findNear([this._parent.position.x,this._parent.position.y],[t,e]).filter(s=>s.entity!=this._parent).map(s=>s.entity)}updateClient(){let t=[this._parent.body.position.x,this._parent.body.position.y];if(this._client.x=t[0],this._client.y=t[1],this._parent.body._resized){this._parent.body._resized=!1;let e=this._parent.body.getBoundingRect();this._client.w=e.width,this._client.h=e.height}this._quadtree.updateClient(this._client)}};var st=class{_value;_str;constructor(t="black"){this.set(t)}get value(){return this._value}get alpha(){return this._str=="transparent"?0:this._str.startsWith("rgba")?parseFloat(this._str.slice(5,this._str.length-1).split(",")[3]):1}set(t){this._str=t,this._value=st.parse(t)}copy(t){this._str=t._str,this._value=t._value}static parse(t){let e=st._buffer;if(typeof t!="string")return"black";let i=t.split(";"),s=i.length;if(s===1)return t;let n,r=i[1].split(",").map(a=>parseFloat(a));switch(i[0]){case"linear-gradient":n=e.createLinearGradient(...r);break;case"radial-gradient":n=e.createRadialGradient(...r);break;default:return"black"}for(let a=2;a<s;++a){let l=i[a].split("=");n.addColorStop(parseFloat(l[1]),l[0])}return n}},A=st;Ht(A,"_buffer",document.createElement("canvas").getContext("2d"));var $=class{_offset=new d;_anim=null;get offset(){return this._offset}shake(t,e,i,s){let n=i*e/1e3;this._anim={counter:0,count:n,angle:s,dur:e,range:t}}isShaking(){return this._anim!==null}stopShaking(){this._anim=null,this._offset.set(0,0)}update(t){if(this._anim){let e=this._anim;e.counter+=t*1e3;let i=y.sat(e.counter/e.dur);this._offset.copy(new d(Math.sin(i*Math.PI*2*e.count)*e.range,0).rot(e.angle)),i==1&&this.stopShaking()}}};var D=class{_name=null;_scene=null;_parent=null;_groupList=new Set;_components=new Map;_position=new Q;_interactive=null;_body=null;_onUpdate=null;get name(){return this._name}get scene(){return this._scene}get position(){return this._position.position}set position(t){this._position.position=t}get interactive(){return this._interactive}get body(){return this._body}get groupList(){return this._groupList}constructor(t,e){t.addEntity(this,e)}clip(t,e=!1){this._position.clip(t._position,e)}unclip(t){this._position.unclip(t._position)}moveTo(t,e,i="linear",s=null){this._position.moveTo(t,e,i,s)}moveBy(t,e,i="linear",s=null){this._position.moveBy(t,e,i,s)}stopMoving(){this._position.stopMoving()}isMoving(){return this._position.isMoving()}addComponent(t,e){e===void 0&&(e=t.constructor.name),this._components.set(e,t),t._parent=this,t.position.copy(this.position.clone().add(t.offset)),this.clip(t,!0),t.initComponent()}getComponent(t){return this._components.get(t)}_updatePosition(t){this._position.update(t)}remove(){this._scene.removeEntity(this)}update(t){this._updatePosition(t),this._onUpdate&&this._onUpdate(t),this._components.forEach(e=>{e.update(t)})}onUpdate(t){this._onUpdate=t}};var ft=class extends D{_scale=new T(1);_target=null;_followOptions=null;_t=4;_vel=new d;_shaker=new $;constructor(t,e){super(t,e)}get position(){return this._position.position}get scale(){return this._scale.value}set scale(t){t>0&&(this._scale.value=t)}get velocity(){return this._vel}set velocity(t){this._vel.copy(t)}get shaker(){return this._shaker}follow(t,e={}){this._target=t,this._followOptions=p.parseObject(e,{x:!0,y:!0,transition:1})}unfollow(){this._target=null,this._followOptions=null}isScaling(){return this._scale.isAnimating()}scaleTo(t,e,i="linear",s=null){this._scale.animate(t,e,i,s)}stopScaling(){this._scale.stopAnimating()}moveAndScale(t,e,i,s="linear",n=null){this.moveTo(t,i,s,n),this.scaleTo(e,i,s)}stop(){this.stopMoving(),this.stopScaling()}_updatePosition(t){if(this.isMoving())this._position.update(t);else if(this._target!=null){let e=y.sat(this._followOptions.transition*t*60);this._followOptions.x&&this._followOptions.y?this.position.lerp(this._target.position,e):this._followOptions.x?this.position.x=y.lerp(e,this.position.x,this._target.position.x):this._followOptions.y&&(this.position.y=y.lerp(e,this.position.y,this._target.position.y))}else{let e=this._vel.clone();e.mult(t),this.position.add(e)}this._scale.update(t),this._shaker.update(t)}};var gt=class{_entities=[];_entitiesMap=new Map;_ids=0;add(t,e){e===void 0&&(e=this._generateName()),this._entities.push(t),this._entitiesMap.set(e,t),t._parent=this,t._name=e}get(t){return this._entitiesMap.get(t)}remove(t){let e=this._entities.indexOf(t);e<0||this._entities.splice(e,1)}filter(t){return this._entities.filter(t)}update(t){for(let e of this._entities)e.update(t)}_generateName(){return++this._ids,"__entity__"+this._ids}};var mt=class{_paused=!0;_hidden=!0;_world;_drawable=[];_interactiveEntities=[];_keys=new Set;_entityManager=new gt;_buffer=null;_background;_timeout=new O;_camera;_interactive=new et;_game=null;debug=!1;_drawCounter=0;constructor(t,e,i,s={}){this._game=t,this._game._sceneManager.add(this,e,i),this._world=new pt(s.world),this._background=new A(p.parseValue(s.background,s.background)),this._camera=new ft(this,"Camera")}get paused(){return this._paused}get hidden(){return this._hidden}get timeout(){return this._timeout}get camera(){return this._camera}get world(){return this._world}get resources(){return this._game.resources}get audio(){return this._game.audio}get background(){return this._background}set background(t){this._background.copy(t)}get game(){return this._game}get interactive(){return this._interactive}isKeyPressed(t){return this._keys.has(t)}setInteractive(t){this._interactiveEntities.push(t);let e=new et;t.addComponent(e),t._interactive=e}getEntityByName(t){return this._entityManager.get(t)}getEntitiesByGroup(t){return this._entityManager.filter(e=>e.groupList.has(t))}handleEvent(t,e){if(this.paused)return!1;let i=!1;if(t.startsWith("mouse"))if(t=="mousedown"){let s=this.world.findNear([e.x,e.y],[0,0]);for(let n of s)!n.interactive||n.body.contains(new d(e.x,e.y))&&(n.interactive._id=e.id,n.interactive.handleEvent(t,e)&&(i=!0))}else for(let s of this._interactiveEntities)e.id!=-1&&s.interactive._id==e.id&&(s.interactive.handleEvent(t,e)&&(i=!0),t=="mouseup"&&(s.interactive._id=-1));else if(t.startsWith("key"))switch(t){case"keydown":this._keys.add(e.key);break;case"keyup":this._keys.delete(e.key);break}return i||this._interactive.handleEvent(t,e)&&(i=!0),i}create(t){return new D(this,t)}addEntity(t,e){t._scene=this,this._entityManager.add(t,e)}removeEntity(t){this._entityManager.remove(t),t._components.forEach(e=>{switch(e._type){case"drawable":this.removeDrawable(e);break;case"body":this.removeBody(t,e);break;case"light":this.removeLight(e);break;case"interactive":this._interactiveEntities.splice(this._interactiveEntities.indexOf(t),1);break}})}addDrawable(t){this._drawable.push(t);for(let e=this._drawable.length-1;e>0&&!(t._zIndex>=this._drawable[e-1]._zIndex);--e)[this._drawable[e],this._drawable[e-1]]=[this._drawable[e-1],this._drawable[e]]}removeDrawable(t){let e=this._drawable.indexOf(t);e!=-1&&this._drawable.splice(e,1)}addBody(t,e){this._world.addBody(t,e)}removeBody(t,e){this._world.removeBody(t,e)}hide(){this._paused=!0,this._hidden=!0}show(){this._hidden=!1}pause(){this._paused=!0}play(){this._paused=!1,this._hidden=!1}update(t){}_update(t){this._paused||(this.timeout.update(t*1e3),this._entityManager.update(t),this.update(t),this._world.update(t))}render(t,e,i){let s=this._camera,n=s.position.clone().add(s.shaker.offset),r=s.scale*i/1;this._buffer||(this._buffer=document.createElement("canvas").getContext("2d"),this._buffer.canvas.width=t,this._buffer.canvas.height=e,this._buffer.imageSmoothingEnabled=!1);let a=this._buffer;a.beginPath(),a.clearRect(0,0,t,e),a.fillStyle=this.background.value,a.fillRect(0,0,t,e),a.save(),a.translate(Math.floor(-n.x*r+t/2+.5),Math.floor(-n.y*r+e/2+.5)),a.scale(r,r),this._drawCounter=0;for(let l of this._drawable){let u=l.getBoundingBox(),h=new d(u.x,u.y);h.sub(n),h.mult(s.scale);let[_,g]=[u.width,u.height].map(b=>b*s.scale);h.x+_/2<-t/2/i||h.x-_/2>t/2/i||h.y+g/2<-e/2/i||h.y-g/2>e/2/i||(++this._drawCounter,l.drawInternal(a))}if(this.debug){this.world.quadtree&&this.world.quadtree.draw(a);for(let l of this.world._bodies)l.draw(a)}a.restore(),this._drawDebugInfo(a,t,e)}draw(t,e,i,s){this._buffer||this.render(e,i,s),t.drawImage(this._buffer.canvas,0,0,e,i)}_drawDebugInfo(t,e,i){if(!this.debug)return;let s=0,n=0,r=Math.max(e*.4,200),a=Math.max(e*.2,100),l=Math.max(e*.01,4),u=Math.max(e*.025,12),h=Math.max(e*.005,2),_="white",g="rgba(128,128,128,0.5)",b=[`Paused: ${this._paused}`,`FPS: ${this._game._engine._fpsMeter.fps}`,`Keys pressed: ${Array.from(this._keys).join(",")}`,`Entities: ${this._entityManager._entities.length}`,`Bodies: ${this._world._bodies.length}`,`${this._drawCounter} objects drawn of total ${this._drawable.length}`,`Camera: x = ${this.camera.position.x.toFixed(2)}, y = ${this.camera.position.y.toFixed(2)}, z = ${this.camera.scale.toFixed(2)}`];t.beginPath(),t.font=u+"px Arial",t.fillStyle=g,t.fillRect(s,n,Math.max(Math.max(...b.map(w=>t.measureText(w).width))+l*2,r),Math.max(b.length*(u+h)+l*2,a)),t.textBaseline="top",t.fillStyle=_;for(let w=0;w<b.length;++w)t.fillText(b[w],s+l,n+l+w*(u+h))}};var wt={};at(wt,{Color:()=>A,LevelMaker:()=>yt,Loader:()=>E,QuadTree:()=>V,Tileset:()=>J,TimeoutHandler:()=>O,Vector:()=>d,math:()=>y,paramParser:()=>p});var L=class extends S{_zIndex;_opacity;_fillColor;_strokeColor;_strokeWidth;_visible=!0;constructor(t={}){super();this._type="drawable",this._zIndex=p.parseValue(t.zIndex,0),this._opacity=new T(p.parseValue(t.opacity,1)),this._fillColor=new A(p.parseValue(t.fillColor,"white")),this._strokeColor=new A(t.strokeColor),this._strokeWidth=p.parseValue(t.strokeWidth,1),this._strokeCap=p.parseValue(t.strokeCap,"butt"),this._shadowColor=new A(p.parseValue(t.shadowColor,"transparent")),this._shadow=p.parseObject(t.shadow,{x:0,y:0})}get visible(){return this._visible}set visible(t){this._visible=t}get zIndex(){return this._zIndex}set zIndex(t){this._zIndex=t,this.scene&&(this.scene.removeDrawable(this),this.scene.addDrawable(this))}get opacity(){return this._opacity.value}set opacity(t){this._opacity.value=y.sat(t)}get strokeWidth(){return this._strokeWidth}set strokeWidth(t){this._strokeWidth=Math.max(t,0)}get fillColor(){return this._fillColor}set fillColor(t){this._fillColor.copy(t)}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor.copy(t)}get shadow(){return this._shadow}get strokeColor(){return this._strokeColor}set strokeColor(t){this._strokeColor.copy(t)}fade(t,e,i="linear",s=null){this._opacity.animate(t,e,i,s)}getBoundingBox(){return{x:0,y:0,width:0,height:0}}initComponent(){this.scene.addDrawable(this)}drawInternal(t){!this.visible||(t.save(),this.shadowColor!="transparent"&&(this.shadow.x!=0||this.shadow.y!=0)&&(t.save(),t.translate(this.shadow.x,this.shadow.y),this.drawShadow(t),t.restore()),this.draw(t),t.restore())}draw(t){}drawShadow(t){}update(t){this._opacity.update(t)}},k=class extends L{_flip;_scale;_image=null;_imageOptions=null;_center=new d;_width;_height;_imageParams=null;_shaker=new $;constructor(t={}){super(t);this._imageParams=p.parseValue(t.image,null);let e=p.parseObject(t.scale,{x:1,y:1});this._scale={x:new T(e.x),y:new T(e.y)},this._width=p.parseValue(t.width,0),this._height=p.parseValue(t.height,0)}get width(){return this._width}set width(t){this._width=Math.max(t,0)}get height(){return this._height}set height(t){this._height=Math.max(t,0)}get scale(){return{x:this._scale.x.value,y:this._scale.y.value}}get image(){return this._imageOptions}set scale(t){let e=p.parseObject(t,{x:this._scale.x.value,y:this._scale.y.value});this._scale.x.value=e.x,this._scale.y.value=e.y}get center(){return this._center}set center(t){this._center.copy(t)}get shaker(){return this._shaker}scaleTo(t,e,i="linear",s=null){let n=p.parseObject(t,{x:this._scale.x.value,y:this._scale.y.value});this._scale.x.value!=n.x&&this._scale.x.animate(n.x,e,i,s),this._scale.y.value!=n.y&&this._scale.y.animate(n.y,e,i,s)}initComponent(){super.initComponent(),this._imageParams!==null&&(this._image=this.scene.resources.get(this._imageParams.name),this._imageOptions=p.parseObject(this._imageParams,{width:this._image.width,height:this._image.height,frameWidth:this._image.width,frameHeight:this._image.height,framePosition:{x:0,y:0}}))}getBoundingBox(){let t=Math.hypot(this._width,this._height);return{width:t*Math.abs(this.scale.x),height:t*Math.abs(this.scale.y),x:this.position.x-this._center.x*Math.abs(this.scale.x),y:this.position.y-this._center.y*Math.abs(this.scale.y)}}drawInternal(t){!this.visible||(t.save(),t.translate(this.position.x+this._shaker.offset.x,this.position.y+this._shaker.offset.y),this.shadowColor!="transparent"&&(this.shadow.x!=0||this.shadow.y!=0)&&(t.save(),t.translate(this.shadow.x,this.shadow.y),t.scale(this.scale.x,this.scale.y),t.rotate(this.angle),t.translate(-this._center.x,-this._center.y),this.drawShadow(t),t.restore()),t.scale(this.scale.x,this.scale.y),t.rotate(this.angle),t.translate(-this._center.x,-this._center.y),this.draw(t),t.restore())}drawImage(t,e={}){if(this._image==null)return;let i=p.parseObject(e,{clip:!0,framePosition:this._imageOptions.framePosition,width:this._imageOptions.width,height:this._imageOptions.height});i.clip&&t.clip(),t.drawImage(this._image,i.framePosition.x*this._imageOptions.frameWidth,i.framePosition.y*this._imageOptions.frameHeight,this._imageOptions.frameWidth,this._imageOptions.frameHeight,-i.width/2,-i.height/2,i.width,i.height)}update(t){super.update(t),this._scale.x.update(t),this._scale.y.update(t),this._shaker.update(t),this._angle.update(t)}followBody(){!this.parent.body||this.parent.addComponent(new Qt({target:this}))}setSize(t,e){this._width=t,this._height=e}},Qt=class extends S{constructor(t){super();this._target=t.target}update(t){let e=this.parent.body;this._target.angle=e.angle}};var X=class extends k{constructor(t){super(t)}draw(t){t.globalAlpha=this.opacity,this.drawImage(t,{clip:!1,width:this._width,height:this._height})}drawShadow(t){t.fillStyle=this.shadowColor.value,t.beginPath(),t.rect(-this._width/2,-this._height/2,this._width,this._height),t.fill()}};var Y=class extends k{_anims=new Map;_currentAnim=null;_paused=!0;_framePos={x:0,y:0};constructor(t){super(t)}get currentAnim(){return this._currentAnim?this._currentAnim.name:null}addAnim(t,e){this._anims.set(t,e)}play(t,e,i,s){if(t==null){this._currentAnim&&(this._paused=!1);return}if(this.currentAnim==t)return;this._paused=!1;let n={name:t,rate:e,repeat:i,OnEnd:s,frame:0,counter:0};this._currentAnim=n,this._framePos=this._anims.get(n.name)[n.frame]}reset(){this._currentAnim&&(this._currentAnim.frame=0,this._currentAnim.counter=0)}pause(){this._paused=!0}update(t){if(super.update(t),this._paused)return;let e=this._currentAnim,i=this._anims.get(e.name);e.counter+=t*1e3,e.counter>=e.rate&&(e.counter=0,++e.frame,e.frame>=i.length&&(e.OnEnd&&e.onEnd(),e.repeat?e.frame=0:(this._currentAnim=null,this._paused=!0)),this._framePos=i[e.frame])}draw(t){t.globalAlpha=this.opacity,this.drawImage(t,{clip:!1,width:this._width,height:this._height,framePosition:this._framePos})}drawShadow(t){t.fillStyle=this.shadowColor.value,t.beginPath(),t.rect(-this._width/2,-this._height/2,this._width,this._height),t.fill()}};var J=class{constructor(t){this._image=t.image,this._tileWidth=t.tileWidth,this._tileHeight=t.tileHeight,this._columns=t.columns,this._tileCount=t.tileCount,this._tileData=[]}get image(){return this._image}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get columns(){return this._columns}get tileCount(){return this._tileCount}createTile(t,e){let i=this._getData(e),s=new D(t),n;i&&i.animation?(n=new Y({image:{name:this._image,frameWidth:this._tileWidth,frameHeight:this._tileHeight}}),n.addAnim("loop",i.animation.frames.map(a=>this._getPos(a))),n.play("loop",i.animation.frameRate,!0)):n=new X({image:{name:this._image,frameWidth:this._tileWidth,frameHeight:this._tileHeight,framePosition:this._getPos(e)}}),s.addComponent(n,"TileSprite");let r={};if(i!=null)for(let a of i.properties)r[a.name]=a.value;return{tile:s,data:r}}addAnim(t,e,i){let s=this._getData(t);s||(s=this._createData(t)),s.animation={frameRate:e,frames:i}}addProp(t,e,i){let s=this._getData(t);s||(s=this._createData(t)),s.properties.push({name:e,value:i})}_getPos(t){return{x:t%this._columns,y:Math.floor(t/this._columns)}}_createData(t){let e={id:t,properties:[]};return this._tileData.push(e),e}_getData(t){return this._tileData.find(e=>e.id==t)}static loadFromTiledJSON(t,e){let i=new J({image:e,tileWidth:t.tilewidth,tileHeight:t.tileheight,columns:t.columns,tileCount:t.tilecount});if(t.tiles)for(let s of t.tiles){let n=s.id;if(s.properties)for(let r of s.properties)i.addProp(n,r.name,r.value);if(s.animation){let r=[];for(let a of s.animation)r.push(a.tileid);i.addAnim(n,s.animation[0].duration,r)}}return i}};var yt=class{_tileWidth;_tileHeight;_onTile=null;_onObject=null;constructor(t){this._tileWidth=t.tileWidth,this._tileHeight=t.tileHeight}get tileWidth(){return this._tileWidth}set tileWidth(t){this._tileWidth=t}get tileHeight(){return this._tileHeight}set tileHeight(t){this._tileHeight=t}onTile(t){this._onTile=t}onObject(t){this._onObject=t}createLevel(t,e,i){let s=a=>{let l=-1,u=0;for(let h=0;h<i.length;++h){if(a<u+i[h].tileCount){l=h;break}u+=i[h].tileCount}return l==-1?null:i[l].createTile(t,a-u)},n=(a,l)=>{for(let u=0;u<a.data.length;++u){let h=a.data[u]-1,_=u%e.width,g=Math.floor(u/e.width);if(h==-1)continue;let b=s(h);if(b===null)return;let w=b.tile;w.position.set((_+.5)*this._tileWidth,(g+.5)*this._tileHeight);let x=w.getComponent("TileSprite");x.setSize(this._tileWidth,this._tileHeight),x.zIndex=l,this._onTile&&this._onTile(w,b.data,l)}},r=(a,l)=>{let u=(h,_,g,b,w)=>{let x=new d(b,w);return x.rot(g),new d(h,_).sub(x)};for(let h of a.objects){let _={name:h.name,type:h.type,x:h.x/e.tilewidth*this._tileWidth,y:h.y/e.tileheight*this._tileHeight,angle:h.rotation===void 0?0:h.rotation/180*Math.PI,width:h.width===void 0?0:h.width/e.tilewidth*this._tileWidth,height:h.height===void 0?0:h.height/e.tileheight*this._tileHeight},g;if(h.gid!==void 0){g=s(h.gid-1).tile,g.position=u(_.x,_.y,_.angle,-_.width/2,_.height/2);let w=g.getComponent("TileSprite");w.setSize(_.width,_.height),w.angle=_.angle,w.zIndex=l}else g=new D(t),g.position=u(_.x,_.y,_.angle,-_.width/2,-_.height/2);this._onObject&&this._onObject(g,_,l);let b=new Map;if(h.properties!==void 0)for(let w of h.properties)b.set(w.name,w.value)}};for(let a=0;a<e.layers.length;++a){let l=e.layers[a],u=a;switch(l.type){case"tilelayer":n(l,u);break;case"objectgroup":r(l,u);break}}}};var Et={};at(Et,{Buffer:()=>jt,Circle:()=>Mt,Drawable:()=>L,FixedDrawable:()=>k,Heart:()=>Bt,Line:()=>xt,Path:()=>Rt,Picture:()=>X,Polygon:()=>H,Rect:()=>vt,RegularPolygon:()=>bt,Ring:()=>St,RoundedRect:()=>kt,Sprite:()=>Y,Star:()=>Ct,Text:()=>Pt,fillRing:()=>U,heart:()=>z,polygon:()=>R,regularPolygon:()=>Xt,roundedRect:()=>$t,star:()=>Yt,strokeRing:()=>G});var vt=class extends k{constructor(t){super(t)}draw(t){t.globalAlpha=this.opacity,t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.fillColor.value,t.strokeStyle=this.strokeColor.value,t.beginPath(),t.rect(-this._width/2,-this._height/2,this._width,this._height),t.fill(),this._strokeWidth!=0&&t.stroke(),this.drawImage(t)}drawShadow(t){t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.shadowColor.value,t.strokeStyle=this.shadowColor.value,this.fillColor!="transparent"&&(t.globalAlpha=this._fillColor.alpha,t.fillRect(-this._width/2,-this._height/2,this._width,this._height)),this.strokeWidth!=0&&(t.globalAlpha=this._strokeColor.alpha,t.strokeRect(-this._width/2,-this._height/2,this._width,this._height))}};var U=function(o,t,e,i,s){let n=o.strokeStyle,r=o.lineWidth;o.beginPath(),o.strokeStyle=o.fillStyle,o.lineWidth=s-i,o.arc(t,e,i+(s-i)/2,0,2*Math.PI),o.stroke(),o.strokeStyle=n,o.lineWidth=r},G=function(o,t,e,i,s){o.beginPath(),o.arc(t,e,i,0,2*Math.PI),o.stroke(),o.beginPath(),o.arc(t,e,s,0,2*Math.PI),o.stroke()},R=function(o,...t){let e=t[0],i=e.length;o.moveTo(e[i-2],e[i-1]);for(let s=0;s<=t.length;++s)e=t[s%t.length],i=e.length,e.length==6?o.bezierCurveTo(...e):e.length==4?o.quadraticCurveTo(...e):o.lineTo(...e)},$t=function(o,t,e,i,s,n){R(o,[t,e+n],[t,e,t+n,e],[i+t-n,e],[i+t,e,i+t,e+n],[i+t,s+e-n],[i+t,s+e,i+t-n,s+e],[t+n,s+e],[t,s+e,t,s+e-n])},Xt=function(o,t,e,i,s){let n=[];for(let r=0;r<s;++r){let a=2*Math.PI*(r/s-.25);n.push([t+Math.cos(a)*i,e+Math.sin(a)*i])}R(o,...n)},Yt=function(o,t,e,i,s,n){let r=n*2,a=[];for(let l=0;l<r;++l){let u=2*Math.PI*(l/r-.25),h=l%2?i:s;a.push([t+Math.cos(u)*h,e+Math.sin(u)*h])}R(o,...a)},z=function(o,t,e,i,s){o.moveTo(t,e+s/4),o.quadraticCurveTo(t,e,t+i/4,e),o.quadraticCurveTo(t+i/2,e,t+i/2,e+s/4),o.quadraticCurveTo(t+i/2,e,t+i*3/4,e),o.quadraticCurveTo(t+i,e,t+i,e+s/4),o.quadraticCurveTo(t+i,e+s/2,t+i*3/4,e+s*3/4),o.lineTo(t+i/2,e+s),o.lineTo(t+i/4,e+s*3/4),o.quadraticCurveTo(t,e+s/2,t,e+s/4)};var H=class extends k{_points;constructor(t){super(t);this._points=p.parseValue(t.points,[])}getBoundingBox(){let t=this._points,e=0,i=0;for(let n=0;n<t.length;++n){let r=t[n],a=r.length,l=Math.hypot(r[a-2],r[a-1]);l>e&&(e=l,i=n)}let s=e*2;return{width:s*Math.abs(this.scale.x),height:s*Math.abs(this.scale.y),x:this.position.x-this._center.x*Math.abs(this.scale.x),y:this.position.y-this._center.y*Math.abs(this.scale.y)}}draw(t){t.globalAlpha=this.opacity,t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.fillColor.value,t.strokeStyle=this.strokeColor.value,t.beginPath(),R(t,...this._points),t.closePath(),t.fill(),this._strokeWidth!=0&&t.stroke(),this.drawImage(t)}drawShadow(t){t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.shadowColor.value,t.strokeStyle=this.shadowColor.value,this.fillColor!="transparent"&&(t.globalAlpha=this._fillColor.alpha,t.beginPath(),R(t,...this._points),t.closePath(),t.fill()),this.strokeWidth!=0&&(t.globalAlpha=this._strokeColor.alpha,t.beginPath(),R(t,...this._points),t.closePath(),t.stroke())}},bt=class extends H{_radius;_edges;constructor(t){super(t);this._radius=t.radius,this._edges=t.edges,this._initPoints()}get radius(){return this._radius}set radius(t){this._radius=Math.max(t,0),this._initPoints()}get edges(){return this._edges}set edges(t){this._edges=Math.max(t,3),this._initPoints()}_initPoints(){let t=[];for(let e=0;e<this.edges;++e){let i=2*Math.PI*(e/this.edges-.25);t.push([Math.cos(i)*this.radius,Math.sin(i)*this.radius])}this._points=t}getBoundingBox(){return{width:this._radius*2*Math.abs(this.scale.x),height:this._radius*2*Math.abs(this.scale.y),x:this.position.x-this._center.x*Math.abs(this.scale.x),y:this.position.y-this._center.y*Math.abs(this.scale.y)}}},Ct=class extends H{_innerRadius;_outerRadius;_peaks;constructor(t){super(t);this._innerRadius=t.innerRadius,this._outerRadius=t.outerRadius,this._peaks=t.peaks,this._initPoints()}get innerRadius(){return this._innerRadius}set innerRadius(t){this._innerRadius=Math.max(t,0),this._initPoints()}get outerRadius(){return this._innerRadius}set outerRadius(t){this._outerRadius=Math.max(t,0),this._initPoints()}get peaks(){return this._peaks}set peaks(t){this._peaks=Math.max(t,3),this._initPoints()}_initPoints(){let t=this._peaks*2,e=[];for(let i=0;i<t;++i){let s=2*Math.PI*(i/t-.25),n=i%2?this._innerRadius:this._outerRadius;e.push([Math.cos(s)*n,Math.sin(s)*n])}this._points=e}getBoundingBox(){return{width:this._outerRadius*2*Math.abs(this.scale.x),height:this._outerRadius*2*Math.abs(this.scale.y),x:this.position.x-this._center.x*Math.abs(this.scale.x),y:this.position.y-this._center.y*Math.abs(this.scale.y)}}},kt=class extends H{_borderRadius;constructor(t){super(t);this._borderRadius=t.borderRadius,this._initPoints()}get width(){return this._width}set width(t){this._width=t,this._initPoints()}get height(){return this._height}set height(t){this._height=t,this._initPoints()}get borderRadius(){return this._borderRadius}set borderRadius(t){this._borderRadius=t,this._initPoints()}_initPoints(){let t=this._width,e=this._height,i=this._borderRadius;this._points=[[-t/2,-(e/2-i)],[-t/2,-e/2,-(t/2-i),-e/2],[t/2-i,-e/2],[t/2,-e/2,t/2,-(e/2-i)],[t/2,e/2-i],[t/2,e/2,t/2-i,e/2],[-(t/2-i),e/2],[-t/2,e/2,-t/2,e/2-i]]}};var xt=class extends k{_length;constructor(t){super(t);this._length=t.length}get length(){return this._length}set length(t){this._length=Math.max(t,0)}getGoundingBox(){let t=d.fromAngle(this._angle).mult(this._length/2);return{width:this._length*Math.abs(this.scale.x),height:this._length*Math.abs(this.scale.y),x:t.x,y:t.y}}draw(t){t.globalAlpha=this.opacity,t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.strokeStyle=this.strokeColor.value,t.beginPath(),t.moveTo(0,0),t.lineTo(this._length,0),t.stroke()}drawShadow(t){t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.strokeStyle=this.shadowColor.value,t.globalAlpha=this._strokeColor.alpha,t.beginPath(),t.moveTo(0,0),t.lineTo(this._length,0),t.stroke()}};var Mt=class extends k{_radius;constructor(t){super(t);this._radius=t.radius,this._angleRange=p.parseValue(t.angleRange,2*Math.PI),this._centered=p.parseValue(t.centered,!1)}get radius(){return this._radius}set radius(t){this._radius=t}get angleRange(){return this._angleRange}set angleRange(t){this._angleRange=t}getBoundingBox(){return{width:this._radius*2*Math.abs(this.scale.x),height:this._radius*2*Math.abs(this.scale.y),x:this.position.x-this._center.x*Math.abs(this.scale.x),y:this.position.y-this._center.y*Math.abs(this.scale.y)}}draw(t){t.globalAlpha=this.opacity,t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.fillColor.value,t.strokeStyle=this.strokeColor.value,t.beginPath(),t.arc(0,0,this._radius,-this.angleRange/2,this.angleRange/2),this._centered&&t.lineTo(0,0),t.closePath(),t.fill(),this.strokeWidth!=0&&t.stroke(),this.drawImage(t)}drawShadow(t){t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.shadowColor.value,t.strokeStyle=this.shadowColor.value,this.fillColor!="transparent"&&(t.globalAlpha=this._fillColor.alpha,t.beginPath(),t.arc(0,0,this._radius,-this.angleRange/2,this.angleRange/2),this._centered&&t.lineTo(0,0),t.closePath(),t.fill()),this.strokeWidth!=0&&(t.globalAlpha=this._strokeColor.alpha,t.beginPath(),t.arc(0,0,this._radius,-this.angleRange/2,this.angleRange/2),this._centered&&t.lineTo(0,0),t.closePath(),t.stroke())}};var Pt=class extends k{_text;_lines;_padding;_align;_fontFamily;_fontSize;_fontStyle;constructor(t){super(t);this._text=p.parseValue(t.text,""),this._lines=this._text.split(/\n/),this._padding=p.parseValue(t.padding,0),this._align=p.parseValue(t.align,"center"),this._fontSize=p.parseValue(t.fontSize,16),this._fontFamily=p.parseValue(t.fontFamily,"Arial"),this._fontStyle=p.parseValue(t.fontStyle,"normal"),this._computeDimensions()}get linesCount(){return this._lines.length}get lineHeight(){return this._fontSize+this._padding*2}get text(){return this._text}set text(t){this._text=t,this._lines=this._text.split(/\n/),this._computeDimensions()}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=Math.max(t,0),this._computeDimensions()}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily=t,this._computeDimensions()}get padding(){return this._padding}set padding(t){this._padding=t,this._computeDimensions()}get align(){return this._align}set align(t){this._align=t,this._computeDimensions()}_computeDimensions(){this._height=this.lineHeight*this.linesCount;let t=0,e=document.createElement("canvas").getContext("2d");e.font=`${this._fontStyle} ${this._fontSize}px '${this._fontFamily}'`;for(let i of this._lines){let s=e.measureText(i).width;s>t&&(t=s)}this._width=t+this._padding*2}draw(t){t.globalAlpha=this.opacity,t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.fillColor.value,t.strokeStyle=this.strokeColor.value,t.font=`${this._fontStyle} ${this._fontSize}px '${this._fontFamily}'`,t.textAlign=this._align,t.textBaseline="middle",t.beginPath();for(let e=0;e<this.linesCount;++e)t.fillText(this._lines[e],this._padding,this.lineHeight*e-(this.linesCount-1)/2*this.lineHeight),this._strokeWidth&&t.strokeText(this._lines[e],this._padding,this.lineHeight*e-(this.linesCount-1)/2*this.lineHeight)}drawShadow(t){t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.shadowColor.value,t.strokeStyle=this.shadowColor.value;let e=this._align=="left"?-this._width/2:this._align=="right"?this._width/2:0;t.font=`${this._fontStyle} ${this._fontSize}px '${this._fontFamily}'`,t.textAlign=this._align,t.textBaseline="middle",t.beginPath();for(let i=0;i<this.linesCount;++i)this.fillColor!="transparent"&&(t.globalAlpha=this._fillColor.alpha,t.fillText(this._lines[i],e+this._padding,this.lineHeight*i-(this.linesCount-1)/2*this.lineHeight)),this._strokeWidth&&(t.globalAlpha=this._strokeColor.alpha,t.strokeText(this._lines[i],e+this._padding,this.lineHeight*i-(this.linesCount-1)/2*this.lineHeight))}};var Rt=class extends L{_points;constructor(t){super(t);this._points=t.points}getBoundingBox(){let t=this._points,e=1/0,i=-1/0,s=1/0,n=-1/0;for(let r=0;r<t.length;++r){let a=t[r],l=a.length,u=a[l-2],h=a[l-1];u<e?e=u:u>i&&(i=u),h<s?s=h:h>n&&(n=h)}return{width:Math.abs(i-e),height:Math.abs(n-s),x:(i+e)/2,y:(n+s)/2}}draw(t){t.globalAlpha=this.opacity,t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.fillColor.value,t.strokeStyle=this.strokeColor.value,t.beginPath(),R(t,...this._points),t.closePath(),t.fill(),this._strokeWidth!=0&&t.stroke()}drawShadow(t){t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,this._shadowColor.fill(t),this._shadowColor.stroke(t),this.fillColor!="transparent"&&(t.globalAlpha=this._fillColor.alpha,t.beginPath(),R(t,...this._points),t.closePath(),t.fill()),this.strokeWidth!=0&&(t.globalAlpha=this._strokeColor.alpha,t.beginPath(),R(t,...this._points),t.closePath(),t.stroke())}};var jt=class extends L{_buffer=document.createElement("canvas").getContext("2d");constructor(t){super(t);this._bounds=t.bounds,this._initBuffer()}_initBuffer(){this._buffer.canvas.width=this._bounds[1][0]-this._bounds[0][0],this._buffer.canvas.height=this._bounds[1][1]-this._bounds[0][1]}add(t){let e=this._buffer;e.save(),e.translate(-this._bounds[0][0],-this._bounds[0][1]),t.drawInternal(e),e.restore()}clear(){let t=this._buffer;t.beginPath(),t.clearRect(0,0,t.canvas.width,t.canvas.height)}getBoundingBox(){let t=this._bounds[1][0]-this._bounds[0][0],e=this._bounds[1][1]-this._bounds[0][1];return{width:t,height:e,x:this._bounds[0][0]+t/2,y:this._bounds[0][1]+e/2}}draw(t){t.globalAlpha=this.opacity,t.beginPath(),t.drawImage(this._buffer.canvas,this._bounds[0][0],this._bounds[0][1])}};var St=class extends k{_innerRadius;_outerRadius;constructor(t){super(t);this._innerRadius=t.innerRadius,this._outerRadius=t.outerRadius}get innerRadius(){return this._innerRadius}set innerRadius(t){this._innerRadius=Math.max(t,0)}get outerRadius(){return this._innerRadius}set outerRadius(t){this._outerRadius=Math.max(t,this._innerRadius)}getBoundingBox(){return{width:this._outerRadius*2*Math.abs(this.scale.x),height:this._outerRadius*2*Math.abs(this.scale.y),x:this.position.x-this._center.x*Math.abs(this.scale.x),y:this.position.y-this._center.y*Math.abs(this.scale.y)}}draw(t){t.globalAlpha=this.opacity,t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.fillColor.value,t.strokeStyle=this.strokeColor.value,U(t,0,0,this._innerRadius,this._outerRadius),this.strokeWidth!=0&&G(t,0,0,this._innerRadius,this._outerRadius)}drawShadow(t){t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.shadowColor.value,t.strokeStyle=this.shadowColor.value,this.fillColor!="transparent"&&(t.globalAlpha=this._fillColor.alpha,U(t,0,0,this._innerRadius,this._outerRadius)),this.strokeWidth!=0&&(t.globalAlpha=this._strokeColor.alpha,G(t,0,0,this._innerRadius,this._outerRadius))}};var Bt=class extends k{constructor(t){super(t)}draw(t){t.globalAlpha=this.opacity,t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.fillColor.value,t.strokeStyle=this.strokeColor.value,t.beginPath(),z(t,-this._width/2,-this._height/2,this._width,this._height),t.closePath(),t.fill(),this._strokeWidth!=0&&t.stroke(),this.drawImage(t)}drawShadow(t){t.lineWidth=this.strokeWidth,t.lineCap=this.strokeCap,t.fillStyle=this.shadowColor.value,t.strokeStyle=this.shadowColor.value,this.fillColor!="transparent"&&(t.globalAlpha=this._fillColor.alpha,t.beginPath(),z(t,-this._width/2,-this._height/2,this._width,this._height),t.closePath(),t.fill()),this.strokeWidth!=0&&(t.globalAlpha=this._strokeColor.alpha,t.beginPath(),z(t,-this._width/2,-this._height/2,this._width,this._height),t.closePath(),t.stroke())}};var It={};at(It,{Ball:()=>W,Box:()=>Tt,Polygon:()=>M,Ray:()=>I,RegularPolygon:()=>Dt});var Vt=class{_body1;_body2;_offset1;_offset2;_length;_strength;constructor(t,e,i){this._body1=t,this._body2=e;let s=p.parseObject(i.offset1,{x:0,y:0});this._offset1=new d(s.x,s.y);let n=p.parseObject(i.offset2,{x:0,y:0});this._offset2=new d(n.x,n.y);let r=this._body1.position.clone().add(this._offset1.clone().rot(this._body1.angle)),a=this._body2.position.clone().add(this._offset2.clone().rot(this._body2.angle));this._length=p.parseValue(i.length,Math.max(d.dist(r,a),1)),this._strength=p.parseValue(i.strength,1)}get offset1(){return this._offset1}set offset1(t){this._offset1.copy(t)}get offset2(){return this._offset2}set offset2(t){this._offset2.copy(t)}get length(){return this._length}set length(t){this._length=Math.max(t,1)}get strength(){return this._strength}set strength(t){this._strength=y.sat(t)}update(t){}},At=class extends Vt{constructor(t,e,i){super(t,e,i)}update(t){if(this._body1.mass===0&&this._body2.mass===0)return;let e=this.offset1.clone().rot(this._body1.angle),i=this.offset2.clone().rot(this._body2.angle),s=this._body1.position.clone().add(e),n=this._body2.position.clone().add(i),r=s.clone().sub(n),a=r.clone().unit(),u=(r.mag()-this.length)/this.length,h=a.clone().mult(u*-this.strength*512/(this._body1.inverseMass+this._body2.inverseMass)),_=h.clone().mult(this._body1.inverseMass);this._body1.velocity.add(_.clone().mult(t)),this._body1.angularVelocity+=d.cross(e,_.clone().mult(1/this._body1.inertia))*t;let g=h.clone().mult(this._body2.inverseMass);this._body2.velocity.sub(g.clone().mult(t)),this._body2.angularVelocity-=d.cross(i,g.clone().mult(1/this._body2.inertia))*t}},Wt=class extends Vt{constructor(t,e,i){super(t,e,i)}update(t){if(this._body1.mass===0&&this._body2.mass===0)return;let e=this.offset1.clone().rot(this._body1.angle),i=this.offset2.clone().rot(this._body2.angle),s=this._body1.position.clone().add(e),n=this._body2.position.clone().add(i),r=s.clone().sub(n),a=r.clone().unit(),l=r.mag(),u=16,h=a.clone().mult((l-this.length)*-1/(this._body1.inverseMass+this._body2.inverseMass));this._body1.position.add(h.clone().mult(this._body1.inverseMass*u*t)),this._body2.position.sub(h.clone().mult(this._body2.inverseMass*u*t));let _=(l-this.length)/this.length,g=a.clone().mult(_*-this.strength*512/(this._body1.inverseMass+this._body2.inverseMass)),b=g.clone().mult(this._body1.inverseMass);this._body1.velocity.add(b.clone().mult(t)),this._body1.angularVelocity+=d.cross(e,b.clone().mult(1/this._body1.inertia))*t;let w=g.Clone().Mult(this._body2.inverseMass);this._body2.velocity.Sub(w.Clone().Mult(t)),this._body2.angularVelocity-=d.Cross(i,w.Clone().Mult(1/this._body2.inertia))*t}};var ot=class extends S{_vel=new d;_angVel=0;_passiveVel=new d;_behavior=[];_friction;_mass;_rotation;_collisions={left:new Set,right:new Set,top:new Set,bottom:new Set,all:new Set};_options;_followBottomObject;_resized=!1;_behaviorIds=0;_joints=[];constructor(t){super();this._type="body",this._friction=p.parseObject(t.friction,{x:0,y:0,angular:0}),this._mass=p.parseValue(t.mass,0),this._rotation=p.parseValue(t.rotation,0),this._options=p.parseObject(t.options,{axes:{x:!0,y:!0},sides:{left:!0,right:!0,top:!0,bottom:!0}}),this._followBottomObject=p.parseValue(t.followBottomObject,!1)}get velocity(){return this._vel}set velocity(t){this._vel.copy(t)}get angularVelocity(){return this._angVel}set angularVelocity(t){this._angVel=t}get mass(){return this._mass}set mass(t){this._mass=Math.max(t,0)}get friction(){return this._friction}get rotation(){return this._rotation}set rotation(t){this._rotation=t}get inverseMass(){return this._mass===0?0:1/this._mass}get inertia(){return 0}get collisions(){return this._collisions}get options(){return this._options}get followBottomObject(){return this._followBottomObject}set followBottomObject(t){this._followBottomObject=t}get passiveVelocity(){return this._passiveVel}set passiveVelocity(t){this._passiveVel.copy(t)}initComponent(){this.scene.addBody(this.parent,this)}getBoundingRect(){return{width:0,height:0}}addBehavior(t,e,i,s){s===void 0&&(s=this._generateBehaviorName()),this._behavior.push({groups:t.split(" "),type:e,options:p.parseObject(i,{bounce:0,friction:0,action:null}),name:s})}removeBehavior(t){let e=this._behavior.findIndex(i=>i.name==t);e!=-1&&this._behavior.splice(e,1)}updateBehavior(t,e={}){let i=this._behavior.find(s=>s.name==t);if(i)for(let s in e)i.options[s]=e[s]}join(t,e,i){i===void 0&&(i={});let s;switch(e){case"elastic":s=new At(this,t,i);break;case"solid":s=new Wt(this,t,i);break}return s?(this.scene.world._addJoint(s),this._joints.push(s),t._joints.push(s),s):null}contains(t){return!1}applyForce(t,e){let i=e.clone().sub(this.position),s=t.clone().mult(this.inverseMass);this.velocity.add(s),this.angularVelocity+=d.cross(i,s.clone().mult(1/this.inertia))}updatePosition(t){let e=30,i=new d(this._vel.x*this._friction.x*e,this._vel.y*this._friction.y*e);this._vel.sub(i.mult(t));let s=this._vel.clone().mult(t);this.position.add(s),this.position.add(this._passiveVel.clone().mult(t)),this._passiveVel.set(0,0),this._angVel-=this._angVel*this._friction.angular*e*t,this.angle+=this._angVel*t}handleBehavior(){let t=this.getComponent("QuadtreeController"),e=this.getBoundingRect();for(let i of this._behavior){let s=(t===void 0?this.parent.scene.world.findNearWithoutQuadtree([this.position.x,this.position.y],[e.width,e.height]):t.findNearby(e.width,e.height)).filter(n=>i.groups.map(r=>n.groupList.has(r)).some(r=>r));s.sort((n,r)=>{let a=n.body.getBoundingRect(),l=r.body.getBoundingRect(),u=d.dist(this.position,n.body.position)/new d(e.width+a.width,e.height+a.height).mag(),h=d.dist(this.position,r.body.position)/new d(e.width+l.width,e.height+l.height).mag();return u-h});for(let n of s){let r;switch(i.type){case"detect":r=Jt(this,n.body),r.collide&&i.options.action&&i.options.action(n.body,r.point);break;case"resolve":r=ae(this,n.body,i.options),r.collide&&i.options.action&&i.options.action(n.body,r.point);break}}}}draw(t){}_generateBehaviorName(){return++this._behaviorIds,"__behavior__"+this._behaviorIds}},M=class extends ot{_points;constructor(t){super(t);this._points=t.points}get inertia(){let t=0;for(let e=0;e<verts.length;++e){let s=verts[e].mag();s>t&&(t=s)}return Math.PI*t**2*.5/this.rotation}getBoundingRect(){let t=this._getVertices(),e=0;for(let s=0;s<t.length;++s){let r=t[s].mag();r>e&&(e=r)}let i=e*2;return{width:i,height:i}}contains(t){let e=this.getComputedVertices(),i=e.length,s=0;for(let n=0;n<i;++n){let r=e[n],a=e[(n+1)%i];(t.y-r.y)*(t.y-a.y)<=0&&(t.x<=r.x||t.x<=a.x)&&(r.x>=t.x&&a.x>=t.x||(a.x-r.x)*(t.y-r.y)/(a.y-r.y)>=t.x-r.x)&&++s}return s%2}getComputedVertices(){let t=this._getVertices();for(let e=0;e<t.length;++e){let i=t[e];i.rot(this.angle),i.add(this.position)}return t}draw(t){t.beginPath(),t.strokeStyle="white";let e=this.getComputedVertices(),i=e[0];t.moveTo(i.x,i.y);for(let s=1;s<e.length;++s)i=e[s],t.lineTo(i.x,i.y);t.closePath(),t.stroke()}_getVertices(){return this._points.map(t=>new d(t[0],t[1]))}static getFaceNormals(t){let e=[];for(let i=0;i<t.length;i++){let s=t[i].clone(),n=t[(i+1)%t.length].clone();e[i]=n.clone().sub(s).norm().unit()}return e}static findSupportPoint(t,e,i){let s=-1/0,n=-1;for(let r=0;r<t.length;r++){let a=t[r].clone().sub(i),l=d.dot(a,e);l>0&&l>s&&(s=l,n=r)}return{sp:t[n],depth:s}}},Tt=class extends M{_width;_height;constructor(t){super(t);this._width=t.width,this._height=t.height,this._initPoints()}get width(){return this._width}get height(){return this._height}set width(t){this._width=Math.max(t,0),this._initPoints()}set height(t){this._height=Math.max(t,0),this._initPoints()}get inertia(){return(this.width**2+this.height**2)*.1/this.rotation}_initPoints(){this._points=[[-this._width/2,-this._height/2],[this._width/2,-this._height/2],[this._width/2,this._height/2],[-this._width/2,this._height/2]],this._resized=!0}},Dt=class extends M{_radius;_sides;constructor(t){super(t);this._radius=t.radius,this._sides=t.sides,this._initPoints()}get radius(){return this._radius}set radius(t){this._radius=Math.max(t,0),this._initPoints()}get sides(){return this._sides}set sides(t){this._sides=Math.max(t,3),this._initPoints()}get inertia(){return Math.PI*this.radius**2*.2/this.rotation}getBoundingRect(){return{width:2*this.radius,height:2*this.radius}}_initPoints(){let t=[];for(let e=0;e<this._sides;++e){let i=Math.PI*2/this._sides*e;t.push([Math.cos(i)*this._radius,Math.sin(i)*this._radius])}this._points=t,this._resized=!0}},W=class extends ot{_radius;constructor(t){super(t);this._radius=t.radius}get radius(){return this._radius}set radius(t){this._radius=Math.max(t,0),this._resized=!0}get inertia(){return Math.PI*this.radius**2*.4/this.rotation}getBoundingRect(){return{width:2*this.radius,height:2*this.radius}}findSupportPoint(t,e){let i=[];i[0]=this.position.clone().add(t.clone().mult(this.radius)),i[1]=this.position.clone().add(t.clone().mult(-this.radius));let s=-1/0,n=-1;for(let r=0;r<i.length;r++){let a=i[r].clone().sub(e),l=d.dot(a,t);l>0&&l>s&&(s=l,n=r)}return{sp:i[n],depth:s,n:t}}findNearestVertex(t){let e=1/0,i=0;for(let s=0;s<t.length;s++){let n=d.dist(t[s],this.position);n<e&&(e=n,i=s)}return t[i]}contains(t){return d.dist(t,this.position)<=this.radius}draw(t){t.beginPath(),t.strokeStyle="white",t.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI),t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+Math.cos(this.angle)*this.radius,this.position.y+Math.sin(this.angle)*this.radius),t.stroke()}},I=class extends ot{_range;constructor(t){super(t);this._range=t.range}get range(){return this._range}set range(t){this._range=t,this._resized=!0}get point(){return this.position.clone().add(new d(this.range,0).rot(this.angle))}getBoundingRect(){return{width:2*this.range,height:2*this.range}}draw(t){let e=this.point;t.beginPath(),t.strokeStyle="white",t.moveTo(0,0),t.lineTo(e.x,e.y),t.stroke()}},Jt=(o,t)=>o instanceof W&&t instanceof W?ne(o,t):o instanceof M&&t instanceof M?re(o,t):o instanceof W&&t instanceof M?Zt(o,t):o instanceof M&&t instanceof W?Zt(t,o):o instanceof I&&t instanceof M?Gt(o,t):o instanceof M&&t instanceof I?Gt(t,o):o instanceof I&&t instanceof W?Kt(o,t):o instanceof W&&t instanceof I?Kt(t,o):o instanceof I&&t instanceof I?oe(t,o):{collide:!1},Ut=(o,t,e,i)=>{let s=t.clone().sub(o),n=i.clone().sub(e),r=s.x*n.y-s.y*n.x,a=((e.x-o.x)*s.y-(e.y-o.y)*s.x)/r,l=((e.x-o.x)*n.y-(e.y-o.y)*n.x)/r;return 0<=a&&a<=1&&0<=l&&l<=1?{collide:!0,point:o.clone().add(s.clone().mult(l))}:{collide:!1}},oe=(o,t)=>{let e=Ut(o.position,o.point,t.position,t.point);return e.collide&&(o._collisions.all.add(t),t._collisions.all.add(o)),e},Gt=(o,t)=>{let e=o.point,i=1/0,s=null,n=t.getComputedVertices();for(let r=0;r<n.length;++r){let a=n[r],l=n[(r+1)%n.length],u=Ut(o.position,e,a,l);if(u.collide){let h=d.dist(o.position,u.point);h<i&&(i=h,s=u.point)}}return s!=null?(o._collisions.all.add(t),t._collisions.all.add(o),{collide:!0,point:s}):{collide:!1}},Kt=(o,t)=>{let e=o.point,i=e.clone().sub(o.position).unit(),s=t.position.clone().sub(o.position),n=t.radius**2,r=s.mag()**2,a=d.dot(s,i),l=r-a*a;if(n-l<0)return{collide:!1};let u=Math.sqrt(n-l),h;r<n?h=a+u:h=a-u;let _=o.position.clone().add(i.clone().mult(h));return d.dot(_.clone().sub(o.position),e.clone().sub(o.position))<0||d.dist(_,o.position)>o.range?{collide:!1}:(o._collisions.all.add(t),t._collisions.all.add(o),{collide:!0,point:_})},ne=(o,t)=>{let e=o.position.clone().sub(t.position),i={};return e.mag()<o.radius+t.radius?(i.normal=e.clone().unit(),i.depth=o.radius+t.radius-e.mag(),i.point=o.position.clone().add(i.normal.clone().mult(o.radius)),i.collide=!0,o._collisions.all.add(t),t._collisions.all.add(o),i):{collide:!1}},re=(o,t)=>{let e=o.getComputedVertices(),i=t.getComputedVertices(),s=M.getFaceNormals(e),n=M.getFaceNormals(i),r=[];for(let _=0;_<s.length;_++){let g=M.findSupportPoint(i,s[_].clone().mult(-1),e[_]);if(g.n=s[_].clone(),r[_]=g,g.sp==null)return{collide:!1}}let a=[];for(let _=0;_<n.length;_++){let g=M.findSupportPoint(e,n[_].clone().mult(-1),i[_]);if(g.n=n[_].clone(),a[_]=g,g.sp==null)return{collide:!1}}r=r.concat(a);let l=1/0,u=0;for(let _=0;_<r.length;_++)r[_].depth<l&&(l=r[_].depth,u=_);let h=t.position.clone().sub(o.position);return d.dot(h,r[u].n)>0&&r[u].n.mult(-1),o._collisions.all.add(t),t._collisions.all.add(o),{collide:!0,normal:r[u].n,depth:r[u].depth,point:r[u].sp}},Zt=(o,t)=>{let e=t.getComputedVertices(),i=M.getFaceNormals(e),s=[];for(let h=0;h<i.length;h++){let _=o.findSupportPoint(i[h].clone().mult(-1),e[h].clone());if(_.sp==null)return{collide:!1};s[h]=_}let n=t.position.clone().sub(o.position).unit().mult(-1),r=M.findSupportPoint(e,n.clone(),o.position.clone().add(n.clone().mult(-o.radius)));if(r.sp==null)return{collide:!1};r.n=n.clone(),s.push(r);let a=1/0,l=0;for(let h=0;h<s.length;h++)s[h].depth<a&&(a=s[h].depth,l=h);let u=t.position.clone().sub(o.position);return d.dot(u,s[l].n)<0&&s[l].n.mult(-1),o._collisions.all.add(t),t._collisions.all.add(o),{collide:!0,normal:s[l].n,point:s[l].sp,depth:s[l].depth}},ae=(o,t,e)=>{o instanceof W&&t instanceof M&&([o,t]=[t,o]);let i=Jt(o,t);if(i.collide){let s={collide:!0,point:i.point};if(o.mass===0&&t.mass===0)return s;o.options.axes.x&&t.options.axes.x||(i.normal.x=0),o.options.axes.y&&t.options.axes.y||(i.normal.y=0);let n=e.bounce,r=e.friction,a={left:new d(-1,0),right:new d(1,0),top:new d(0,-1),bottom:new d(0,1)},l;d.dot(i.normal,a.left)>=Math.SQRT2/2?l="left":d.dot(i.normal,a.right)>=Math.SQRT2/2?l="right":d.dot(i.normal,a.top)>=Math.SQRT2/2?l="top":d.dot(i.normal,a.bottom)>=Math.SQRT2/2&&(l="bottom");let u=i.point.clone().sub(o.position),h=i.point.clone().sub(t.position),_=o.angularVelocity,g=t.angularVelocity,b=o._vel,w=t._vel,x=b.clone().add(new d(-_*u.y,_*u.x)),F=w.clone().add(new d(-g*h.y,g*h.x)),j=x.clone().sub(F),K=-(1+n)*d.dot(j,i.normal)/(o.inverseMass+t.inverseMass+Math.pow(d.cross(u,i.normal),2)/o.inertia+Math.pow(d.cross(h,i.normal),2)/t.inertia),B=i.normal.clone().mult(K),f=B.clone().mult(o.inverseMass),c=B.clone().mult(t.inverseMass),C=d.dot(B,a.left),m=d.dot(B,a.right),v=d.dot(B,a.top),P=d.dot(B,a.bottom);if((C>=Math.SQRT2/2||C<Math.SQRT2/2&&l=="left")&&(!o.options.sides.right||!t.options.sides.left))return s;if((m>=Math.SQRT2/2||m<Math.SQRT2/2&&l=="right")&&(!o.options.sides.left||!t.options.sides.right))return s;if((v>=Math.SQRT2/2||v<Math.SQRT2/2&&l=="top")&&(!o.options.sides.bottom||!t.options.sides.top))return s;if((P>=Math.SQRT2/2||P<Math.SQRT2/2&&l=="bottom")&&(!o.options.sides.top||!t.options.sides.bottom))return s;let q=i.normal.clone().mult(i.depth/(o.inverseMass+t.inverseMass));if(o.position.add(q.clone().mult(o.inverseMass)),t.position.sub(q.clone().mult(t.inverseMass)),d.dot(j,i.normal)<=0){o._vel.add(f),t._vel.sub(c),o.angularVelocity+=d.cross(u,f.clone().mult(1/o.inertia)),t.angularVelocity-=d.cross(h,c.clone().mult(1/o.inertia));let Z=i.normal.clone().norm(),ee=-(1+n)*d.dot(j,Z)*r/(o.inverseMass+t.inverseMass+Math.pow(d.cross(u,Z),2)/o.inertia+Math.pow(d.cross(h,Z),2)/t.inertia),Lt=Z.clone().mult(ee),Ot=Lt.clone().mult(o.inverseMass),zt=Lt.clone().mult(t.inverseMass);switch(o._vel.add(Ot.clone()),t._vel.sub(zt.clone()),o.angularVelocity+=d.cross(u,Ot.clone().mult(1/o.inertia)),t.angularVelocity-=d.cross(h,zt.clone().mult(1/t.inertia)),l){case"left":o._collisions.right.add(t),t._collisions.left.add(o);break;case"right":o._collisions.left.add(t),t._collisions.right.add(o);break;case"top":o._collisions.bottom.add(t),t._collisions.top.add(o);break;case"bottom":o._collisions.top.add(t),t._collisions.bottom.add(o);break}}return l=="bottom"?t.followBottomObject&&(t.passiveVelocity=o.velocity):l=="top"&&o.followBottomObject&&(o.passiveVelocity=t.velocity),s}return{collide:!1}};var he=o=>{addEventListener("DOMContentLoaded",()=>new ct(o))},te="Lancelot",nt={start:he,Scene:mt,Component:S,utils:wt,drawable:Et,physics:It};if(typeof module=="object"&&typeof module.exports=="object")module.exports=nt;else if(typeof define=="function"&&define.amd)define(te,[],nt);else{let o=typeof globalThis!="undefined"?globalThis:self;o[te]=nt}var Us=nt;export{Us as default};
