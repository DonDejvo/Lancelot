(()=>{var Dt=Object.defineProperty;var Wt=o=>Dt(o,"__esModule",{value:!0});var q=(o,t)=>{Wt(o);for(var e in t)Dt(o,e,{get:t[e],enumerable:!0})};var y=function(){return{rand(o,t){return Math.random()*(t-o)+o},randint(o,t){return Math.floor(Math.random()*(t-o+1)+o)},lerp(o,t,e){return t+(e-t)*o},clamp(o,t,e){return Math.min(Math.max(o,t),e)},in_range(o,t,e){return o>=t&&o<=e},sat(o){return this.clamp(o,0,1)},ease_out(o){return this.sat(Math.pow(o,1/2))},ease_in(o){return this.sat(Math.pow(o,3))},choice(o){let t=o.length;return o[this.randint(0,t-1)]},shuffle(o){let t=o.length;for(let e=0;e<t;++e){let s=this.randint(0,t-1);[o[e],o[s]]=[o[s],o[e]]}}}}();var N=class{constructor(){this._volume=1,this._playing=!1,this._audioMap=new Map,this._current=null,this._secondary=[]}get volume(){return this._volume}set volume(t){t=y.sat(t),this._volume=t,this._audioMap.forEach(e=>{e.volume=this._volume});for(let e of this._secondary)e.volume=this._volume}get playing(){return this._current?!this._current.paused:!1}AddAudio(t,e){e.volume=this._volume,this._audioMap.set(t,e)}Play(t,e){this._current&&this._current.pause();let s=this._audioMap.get(t);s&&(e.primary===void 0||e.primary==!0?(this._current=s,e.time!==void 0&&(this._current.currentTime=y.sat(e.time)*this._current.duration),this._current.loop=e.loop||!1,this._current.play()):this.PlaySecondary(t))}PlaySecondary(t){let e=this._audioMap.get(t);if(e){let s=e.cloneNode(!0);this._secondary.push(s),s.addEventListener("ended",()=>{let n=this._secondary.indexOf(s);n!=-1&&this._secondary.splice(n,1)}),s.volume=this._volume,s.play()}}Pause(){this._current&&this._current.pause()}};var V=class{constructor(){this._timeouts=[]}Set(t,e){let s={action:t,dur:e,counter:0};return this._timeouts.push(s),s}Clear(t){let e=this._timeouts.indexOf(t);e!=-1&&this._timeouts.splice(e,1)}Update(t){for(let e=0;e<this._timeouts.length;++e){let s=this._timeouts[e];(s.counter+=t)>=s.dur&&(s.action(),this._timeouts.splice(e--,1))}}};var X=class{constructor(t){this._step=t,this.paused=!0,this.timeout=new V}_RAF(){this.paused||(this._frame=window.requestAnimationFrame(t=>{this._RAF();let e=Math.min(t-this._previousRAF,1e3/30);this.timeout.Update(e),this._step(e),this._previousRAF=t}))}Start(){this.paused=!1,this._previousRAF=performance.now(),this._RAF()}Stop(){this.paused=!0,window.cancelAnimationFrame(this._frame)}};var D=function(){return{ParseColor(o,t){if(t==null)return"black";let e=t.split(";"),s=e.length;if(s===1)return t;let n,r=e[1].split(",").map(h=>parseFloat(h));switch(e[0]){case"linear-gradient":n=o.createLinearGradient(...r);break;case"radial-gradient":n=o.createRadialGradient(...r);break;default:return"black"}for(let h=2;h<s;++h){let l=e[h].split("=");n.addColorStop(parseFloat(l[1]),l[0])}return n}}}();var a=class{constructor(t=0,e=0){this._x=t,this._y=e}get x(){return this._x}get y(){return this._y}set x(t){this.Set(t,this.y)}set y(t){this.Set(this.x,t)}Set(t,e){this._x=t,this._y=e}Copy(t){return this.Set(t.x,t.y),this}Clone(){return new a(this.x,this.y)}Add(t){return this.Set(this.x+t.x,this.y+t.y),this}Sub(t){return this.Set(this.x-t.x,this.y-t.y),this}Mult(t){return this.Set(this.x*t,this.y*t),this}Norm(){return this.Set(this.y,-this.x),this}Unit(){let t=this.Mag();return t===0?this:(this.Set(this.x/t,this.y/t),this)}Mag(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}Lerp(t,e){return this.Add(t.Clone().Sub(this).Mult(e))}Angle(){return Math.atan2(this.y,this.x)}Rotate(t){let e=Math.sin(t),s=Math.cos(t),n=this.x*s-this.y*e,r=this.x*e+this.y*s;return this.Set(n,r),this}Project(t){let e=a.Dot(this,t);return t.Clone().Mult(e)}static FromAngle(t){return new a(1,0).Rotate(t)}static Dot(t,e){return t.x*e.x+t.y*e.y}static Dist(t,e){return t.Clone().Sub(e).Mag()}static Cross(t,e){return t.x*e.y-t.y*e.x}static AngleBetween(t,e){let s=t.Mag(),n=e.Mag();return s===0||n===0?0:Math.acos(a.Dot(t,e)/(s*n))}},H=class extends a{constructor(t,e=0,s=0){super(e,s);this._positionFunction=t}Set(t,e){(t!=this.x||e!=this.y)&&(this._x=t,this._y=e,this._positionFunction())}};var Q=class{constructor(t){this._width=t.width,this._height=t.height,this._aspect=this._width/this._height,this._scale=1,this._parentElement=t.parentElement,this._buffers=[];for(let e=0;e<5;++e){let s=document.createElement("canvas").getContext("2d");s.canvas.width=this._width,s.canvas.height=this._height,s.imageSmoothingEnabled=!1,this._buffers[e]=s}this._InitContainer(),this._InitCanvas(),this._OnResize(),window.addEventListener("resize",()=>this._OnResize()),this.draw=(e,s,n,r)=>{let h=e[n];if(!h)return;if(h.paused){this.draw(e,s,n+1,r);return}let l=this._width,d=this._height;if(h.DrawLights(s,l,d),!this._buffers[r]){let f=document.createElement("canvas").getContext("2d");f.canvas.width=this._width,f.canvas.height=this._height,this._buffers[r]=f}let _=this._buffers[r];n<e.length-1&&(this.draw(e,_,n+1,r+1),_.globalCompositeOperation="source-over"),h.DrawObjects(_,l,d),s.drawImage(_.canvas,0,0)}}get dimension(){return this._canvas.getBoundingClientRect()}_InitContainer(){let t=this._container=document.createElement("div");t.style.width=this._width+"px",t.style.height=this._height+"px",t.style.position="relative",t.style.left="50%",t.style.top="0%",t.style.transformOrigin="center",this._parentElement.appendChild(t)}_InitCanvas(){let t=this._canvas=document.createElement("canvas");t.width=this._width,t.height=this._height,this._context=t.getContext("2d"),t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.display="block",t.style.background="black",this._container.appendChild(t)}_OnResize(){let[t,e]=[this._parentElement.clientWidth,this._parentElement.clientHeight];t/e>this._aspect?this._scale=e/this._height:this._scale=t/this._width,this._container.style.transform="translate(-50%, calc(-50% + "+this._height/2*this._scale+"px)) scale("+this._scale+")",this._context.imageSmoothingEnabled=!1}Render(t){let e=this._context;e.beginPath(),e.clearRect(0,0,this._width,this._height),this.draw(t,e,0,0)}DisplayToSceneCoords(t,e,s){let n=this.dimension,r=(e-n.left)/this._scale,h=(s-n.top)/this._scale,l=t.camera;return{x:(r-this._width/2)/l.scale+l.position.x,y:(h-this._height/2)/l.scale+l.position.y}}};var Y=class{constructor(){this._scenes=[],this._scenesMap=new Map}Add(t,e,s=0){t._zIndex=s,this._scenesMap.set(e,t);let n=this._scenes.indexOf(t);n!=-1&&this._scenes.splice(n,i),this._scenes.push(t);for(let r=this._scenes.length-1;r>0&&!(this._scenes[r]._zIndex<=this._scenes[r-1]._zIndex);--r)[this._scenes[r],this._scenes[r-1]]=[this._scenes[r-1],this._scenes[r]];return t}Get(t){return this._scenesMap.get(t)||null}Play(t){let e=this._scenesMap.get(t);return e?(e.paused=!1,e):null}};var J=class{constructor(){this._entities=[],this._entitiesMap=new Map,this._ids=0}_GenerateName(){return++this._ids,"__entity__"+this._ids}Add(t,e){e===void 0&&(e=this._GenerateName()),this._entities.push(t),this._entitiesMap.set(e,t),t._parent=this,t._name=e}Get(t){return this._entitiesMap.get(t)}Remove(t){let e=this._entities.indexOf(t);e<0||this._entities.splice(e,1)}Filter(t){return this._entities.filter(t)}Update(t){for(let e of this._entities)e.Update(t)}};var k=class{constructor(){this._pos=new H(this.DoWeirdStuff.bind(this)),this._parent=null,this._fixed=!1,this._offset=new H(this.DoWeirdStuffWithOffset.bind(this)),this._attached=[],this._moving=null}Clip(t,e=!1){this._attached.push(t),t._parent=this,t._fixed=e,t._offset.Copy(t.position.Clone().Sub(this.position))}Unclip(t){let e=this._attached.indexOf(t);e!=-1&&(this._attached.splice(e,1),t._parent=null)}get position(){return this._pos}set position(t){this.position.Copy(t)}MoveTo(t,e,s="linear"){this._moving={counter:0,dur:e,from:this.position.Clone(),to:t,timing:s}}StopMoving(){this._moving=null}DoWeirdStuff(){this._parent&&(this._fixed?this._parent.position.Copy(this.position.Clone().Sub(this._offset)):this._offset.Copy(this.position.Clone().Sub(this._parent.position)));for(let t of this._attached)t.position.Copy(this.position.Clone().Add(t._offset))}DoWeirdStuffWithOffset(){this._parent&&this._fixed&&this.position.Copy(this._parent.position.Clone().Add(this._offset))}Update(t){if(this._moving){let e=this._moving;e.counter+=t*1e3;let s=Math.min(e.counter/e.dur,1),n;switch(e.timing){case"linear":n=s;break;case"ease-in":n=y.ease_in(s);break;case"ease-out":n=y.ease_out(s);break}this.position.Copy(e.from.Clone().Lerp(e.to,n)),s==1&&(this._moving=null)}}};var $=class{constructor(){this._position=new k,this.scale=1,this._target=null,this._vel=new a,this._scaling=null,this._shaking=null,this._offset=new a}get position(){return this._position.position}set position(t){this._position.position.Copy(t)}get shaking(){return this._shaking}get scaling(){return this._scaling}get moving(){return this._position._moving}get velocity(){return this._vel}set velocity(t){this._vel.Copy(t)}Clip(t){this._position.Clip(t._position)}Unclip(t){this._position.Unclip(t._position)}MoveTo(t,e,s="linear"){this._position.MoveTo(t,e,s)}StopMoving(){this._position.StopMoving()}Follow(t){this._target=t}Unfollow(){this._target=null}ScaleTo(t,e,s="linear"){this._scaling={counter:0,dur:e,from:this.scale,to:t,timing:s}}StopScaling(){this._scaling=null}MoveAndScale(t,e,s,n="linear"){this.MoveTo(t,s,n),this.ScaleTo(e,s,n)}Shake(t,e,s,n){this._shaking={counter:0,count:s,angle:n,dur:e,range:t}}StopShaking(){this._shaking=null,this._offset=new a}Update(t){if(this.moving)this._position.Update(t);else if(this._target){let e=4*t;this.position.Lerp(this._target.position,e)}else{let e=this._vel.Clone();e.Mult(t),this.position.Add(e)}if(this._scaling){let e=this._scaling;e.counter+=t*1e3;let s=Math.min(e.counter/e.dur,1),n;switch(e.timing){case"linear":n=s;break;case"ease-in":n=y.ease_in(s);break;case"ease-out":n=y.ease_out(s);break}this.scale=y.lerp(n,e.from,e.to),s==1&&this.StopScaling()}if(this._shaking){let e=this._shaking;e.counter+=t*1e3;let s=Math.min(e.counter/e.dur,1);this.position.Sub(this._offset),this._offset.Copy(new a(Math.sin(s*Math.PI*2*e.count)*e.range,0).Rotate(e.angle)),this.position.Add(this._offset),s==1&&this.StopShaking()}}};var w=class{constructor(t){this._type="",this._parent=null,this._position=new k}get type(){return this._type}get scene(){return this._parent._scene}get parent(){return this._parent}get position(){return this._position.position}set position(t){this._position.position=t}get offset(){return this._position._offset}set offset(t){this._position._offset.Copy(t)}InitComponent(){}GetComponent(t){return this._parent.GetComponent(t)}FindEntity(t){return this._parent.FindEntity(t)}Update(t){}};var p=function(){return{ParseValue(o,t){return o!=null&&typeof o==typeof t?o:t},ParseObject(o,t){if(o)for(let e in t)t[e]=typeof t[e]=="object"?this.ParseObject(o[e],t[e]):this.ParseValue(o[e],t[e]),typeof t[e]=="object"?t[e].min!==void 0&&t[e].max!==void 0?t[e]=this.ParseMinMax(o[e],t[e]):t[e]=this.ParseObject(o[e],t[e]):t[e]=this.ParseValue(o[e],t[e]);return t},ParseMinMax(o,t){return o===void 0?t:typeof o!="object"?{min:o,max:o}:(o.min!==void 0&&(t.min=o.min),o.max!==void 0&&(t.max=o.max),t)}}}();var K=class extends w{constructor(t){super();this._type="interactive",this._capture=p.ParseValue(t.capture,!0),this._eventHandlers=new Map}On(t,e){this._eventHandlers.has(t)||this._eventHandlers.set(t,[]),this._eventHandlers.get(t).push(e)}Off(t,e){if(!this._eventHandlers.has(t))return;let s=this._eventHandlers.get(t),n=s.indexOf(e);n>-1&&s.splice(n,1)}_On(t,e){if(!this._eventHandlers.has(t))return;let s=this._eventHandlers.get(t);for(let n of s)n(e)}};var Z=class{constructor(){this._position=new k(this.DoWeirdStuff.bind(this)),this._components=new Map,this._parent=null,this._name=null,this._scene=null,this.groupList=new Set}get name(){return this._name}get scene(){return this._scene}get position(){return this._position.position}set position(t){this._position.position=t}get moving(){return this._position._moving}DoWeirdStuff(){this._components.forEach(t=>{t.position.Copy(this.position.Clone().Add(t.offset))})}Update(t){this._position.Update(t),this._components.forEach(e=>{e.Update(t)})}Clip(t,e=!1){this._position.Clip(t._position,e)}Unclip(t){this._position.Unclip(t._position)}MoveTo(t,e,s="linear"){this._position.MoveTo(t,e,s)}StopMoving(){this._position.StopMoving()}AddComponent(t,e){switch(e===void 0&&(e=t.constructor.name),this._components.set(e,t),t._parent=this,t.position.Copy(this.position.Clone().Add(t.offset)),this.Clip(t,!0),t.InitComponent(),t.type){case"drawable":this.scene._AddDrawable(t);break;case"body":this.scene._AddBody(this,t);break;case"light":this._scene._lights.push(t)}}GetComponent(t){return this._components.get(t)}FindEntity(t){return this._parent.Get(t)}};var nt={};q(nt,{Ball:()=>b,Box:()=>kt,Polygon:()=>jt,Ray:()=>j,World:()=>G});var tt=class{constructor(t,e){let[s,n]=e;this._cells=[...Array(n)].map(r=>[...Array(s)].map(h=>null)),this._dimensions=e,this._bounds=t}NewClient(t,e){let s={position:t,dimensions:e,indices:null};return this._InsertClient(s),s}_InsertClient(t){let[e,s]=t.dimensions,[n,r]=t.position,h=this._GetCellIndex([n-e/2,r-s/2]),l=this._GetCellIndex([n+e/2,r+s/2]);t.indices=[h,l];for(let d=h[1];d<=l[1];++d)for(let _=h[0];_<=l[0];++_)this._cells[d][_]||(this._cells[d][_]=new Set),this._cells[d][_].add(t)}_GetCellIndex(t){let e=y.sat((t[0]-this._bounds[0][0])/(this._bounds[1][0]-this._bounds[0][0])),s=y.sat((t[1]-this._bounds[0][1])/(this._bounds[1][1]-this._bounds[0][1])),n=Math.floor(e*(this._dimensions[0]-1)),r=Math.floor(s*(this._dimensions[1]-1));return[n,r]}FindNear(t,e){let[s,n]=e,[r,h]=t,l=this._GetCellIndex([r-s/2,h-n/2]),d=this._GetCellIndex([r+s/2,h+n/2]),_=new Set;for(let f=l[1];f<=d[1];++f)for(let u=l[0];u<=d[0];++u)if(this._cells[f][u])for(let c of this._cells[f][u])_.add(c);return Array.from(_)}UpdateClient(t){this.RemoveClient(t),this._InsertClient(t)}RemoveClient(t){let[e,s]=t.indices;for(let n=e[1];n<=s[1];++n)for(let r=e[0];r<=s[0];++r)this._cells[n][r].delete(t)}Draw(t){let e=this._bounds;t.save(),t.strokeStyle="white",t.beginPath();let s=(e[1][0]-e[0][0])/this._dimensions[0];for(let r=0;r<=this._dimensions[0];++r)t.moveTo(e[0][0]+r*s,e[0][1]),t.lineTo(e[0][0]+r*s,e[1][1]);let n=(e[1][1]-e[0][1])/this._dimensions[1];for(let r=0;r<=this._dimensions[1];++r)t.moveTo(e[0][0],e[0][1]+r*n),t.lineTo(e[1][0],e[0][1]+r*n);t.stroke(),t.restore()}};var U=class{constructor(t,e,s,n,r){this.x=t,this.y=e,this.w=s,this.h=n,this.entity=r}_vsAabb(t){return this.x+this.w/2>=t.x-t.w/2&&this.x-this.w/2<=t.x+t.w/2&&this.y+this.h/2>=t.y-t.h/2&&this.y-this.h/2<=t.y+t.h/2}},S=class{constructor(t,e){this._bounds=t;let s=t[1][0]-t[0][0],n=t[1][1]-t[0][1];this.aabb=new U(t[0][0]+s/2,t[0][1]+n/2,s,n),this.limit=e,this.divided=!1,this.data=[]}_divide(){let t=this._bounds,e=t[1][0]-t[0][0],s=t[1][1]-t[0][1];this.topLeft=new S([[t[0][0],t[0][1]],[t[0][0]+e/2,t[0][1]+s/2]],this.limit),this.topRight=new S([[t[0][0]+e/2,t[0][1]],[t[0][0]+e,t[0][1]+s/2]],this.limit),this.bottomLeft=new S([[t[0][0],t[0][1]+s/2],[t[0][0]+e/2,t[0][1]+s]],this.limit),this.bottomRight=new S([[t[0][0]+e/2,t[0][1]+s/2],[t[0][0]+e,t[0][1]+s]],this.limit);for(let n=0;n<this.data.length;n++)this.topLeft._Insert(this.data[n]),this.topRight._Insert(this.data[n]),this.bottomLeft._Insert(this.data[n]),this.bottomRight._Insert(this.data[n]);this.divided=!0}Clear(){this.data=[],this.divided=!1,this.topRight=null,this.topLeft=null,this.bottomLeft=null,this.bottomRight=null}FindNear(t,e){let[s,n]=e,[r,h]=t,l=new U(r,h,s,n),d=this._Search(l);return d==null?[]:Array.from(d)}_Search(t,e){if(e==null&&(e=new Set),!!t._vsAabb(this.aabb)){if(this.divided)this.topLeft._Search(t,e),this.topRight._Search(t,e),this.bottomLeft._Search(t,e),this.bottomRight._Search(t,e);else for(let s=0;s<this.data.length;s++)t._vsAabb(this.data[s])&&e.add(this.data[s]);return e}}NewClient(t,e){let s=new U(t[0],t[1],e[0],e[1]);return this._Insert(s),s}_Insert(t,e=0){let s=5;if(!this.aabb._vsAabb(t))return!1;if(this.data.length<this.limit||e>s)return this.data.push(t),!0;this.divided||this._divide(),this.topLeft._Insert(t,e+1),this.topRight._Insert(t,e+1),this.bottomLeft._Insert(t,e+1),this.bottomRight._Insert(t,e+1)}UpdateClient(t){this._Insert(t)}Draw(t){t.beginPath(),t.strokeStyle="white",t.strokeRect(this.aabb.x-this.aabb.w/2,this.aabb.y-this.aabb.h/2,this.aabb.w,this.aabb.h),this.divided&&(this.topLeft.Draw(t),this.topRight.Draw(t),this.bottomLeft.Draw(t),this.bottomRight.Draw(t))}};var et=class extends w{constructor(t){super();this._params=t,this._width=this._params.width,this._height=this._params.height,this._quadtree=this._params.quadtree}InitComponent(){let t=[this._parent.body.position.x,this._parent.body.position.y];this._client=this._quadtree.NewClient(t,[this._width,this._height]),this._client.entity=this._parent}FindNearby(t,e){return this._quadtree.FindNear([this._parent.position.x,this._parent.position.y],[t,e]).filter(n=>n.entity!=this._parent).map(n=>n.entity)}UpdateClient(){let t=[this._parent.body.position.x,this._parent.body.position.y];this._client.x=t[0],this._client.y=t[1],this._quadtree.UpdateClient(this._client)}};var G=class{constructor(t={}){this._relaxationCount=p.ParseValue(t.iterations,3),this._bounds=p.ParseValue(t.bounds,[[-1e3,-1e3],[1e3,1e3]]),this._cellDimensions=p.ParseObject(t.cellDimensions,{width:100,height:100}),this._limit=p.ParseValue(t.limit,10),this._bodies=[],this._joints=[],this._gravity=p.ParseValue(t.gravity,0);let e=Math.floor((this._bounds[1][0]-this._bounds[0][0])/this._cellDimensions.width),s=Math.floor((this._bounds[1][1]-this._bounds[0][1])/this._cellDimensions.height);this._spatialGrid=new tt(this._bounds,[e,s]),this._quadtree=new S(this._bounds,this._limit)}Raycast(t,e,s,n){let r=[],h=new j({range:n});h.position=new a(t,e),h.angle=s;for(let l of this._bodies){let d=it(h,l);d.collide&&r.push({body:l,point:d.point})}return r.sort((l,d)=>{let _=a.Dist(h.position,l.point),f=a.Dist(h.position,d.point);return _-f}),r}_AddJoint(t){this._joints.push(t)}_AddBody(t,e){t.body=e;let s=e.boundingRect,n=new et({quadtree:this._quadtree,width:s.width,height:s.height});t.AddComponent(n),this._bodies.push(e)}_RemoveBody(t,e){let s=this._bodies.indexOf(e);s!=-1&&this._bodies.splice(s,1)}Update(t){for(let e of this._bodies)e._collisions.left.clear(),e._collisions.right.clear(),e._collisions.top.clear(),e._collisions.bottom.clear(),e._collisions.all.clear();for(let e of this._bodies)e.mass!=0&&(e.velocity.y+=this._gravity*t),e.UpdatePosition(t);for(let e of this._joints)e.Update(t);for(let e=0;e<this._relaxationCount;++e)for(let s of this._bodies)s.HandleBehavior();this._quadtree.Clear();for(let e of this._bodies)e.GetComponent("QuadtreeController").UpdateClient()}},B=class extends w{constructor(t){super();this._type="body",this._vel=new a,this.passiveVelocity=new a,this._angVel=0,this.mass=p.ParseValue(t.mass,0),this.angle=0,this.rotation=p.ParseValue(t.rotation,0),this.friction=p.ParseObject(t.friction,{x:0,y:0,angular:0}),this._behavior=[],this._collisions={left:new Set,right:new Set,top:new Set,bottom:new Set,all:new Set},this.options=p.ParseObject(t.options,{axes:{x:!0,y:!0},sides:{left:!0,right:!0,top:!0,bottom:!0}}),this.followBottomObject=p.ParseValue(t.followBottomObject,!1)}get velocity(){return this._vel}set velocity(t){this._vel.Copy(t)}get angularVelocity(){return this._angVel}set angularVelocity(t){this._angVel=t}get inverseMass(){return this.mass===0?0:1/this.mass}get inertia(){return 0}get boundingRect(){return{width:0,height:0}}get collisions(){return this._collisions}AddBehavior(t,e,s={}){this._behavior.push({groups:t.split(" "),type:e,options:p.ParseObject(s,{bounce:0,friction:0,action:(n,r)=>{}})})}UpdatePosition(t){let e=16,s=new a(this._vel.x*this.friction.x*e,this._vel.y*this.friction.y*e);this._vel.Sub(s.Mult(t));let n=this._vel.Clone().Mult(t);this.position.Add(n),this.position.Add(this.passiveVelocity.Clone().Mult(t)),this.passiveVelocity.Set(0,0),this._angVel-=this._angVel*this.friction.angular*e*t,this.angle+=this._angVel*t}HandleBehavior(){let t=this.GetComponent("QuadtreeController"),e=this.boundingRect;for(let s of this._behavior){let r=t.FindNearby(e.width,e.height).filter(h=>s.groups.map(l=>h.groupList.has(l)).some(l=>l));r.sort((h,l)=>{let d=h.body.boundingRect,_=l.body.boundingRect,f=a.Dist(this.position,h.body.position)/new a(e.width+d.width,e.height+d.height).Mag(),u=a.Dist(this.position,l.body.position)/new a(e.width+_.width,e.height+_.height).Mag();return f-u});for(let h of r){let l;switch(s.type){case"DetectCollision":l=it(this,h.body),l.collide&&s.options.action(h.body,l.point);break;case"ResolveCollision":l=Xt(this,h.body,s.options),l.collide&&s.options.action(h.body,l.point);break}}}}Join(t,e,s={}){let n;switch(e){case"elastic":n=new Et(this,t,s);break;case"solid":n=new Ot(this,t,s);break}if(!n)return;this.scene._world._AddJoint(n)}Contains(t){return!1}ApplyForce(t,e){let s=this.position.Clone().Sub(e),n=t.Clone().Mult(1/this.inverseMass);this.velocity.Add(n),this.angularVelocity+=a.Cross(s,n.Clone().Mult(1/this.inertia))}},C=class extends B{constructor(t){super(t);this._points=t.points}GetVertices(){return this._points.map(t=>new a(t[0],t[1]))}GetComputedVertices(){let t=this.GetVertices();for(let e=0;e<t.length;++e){let s=t[e];s.Rotate(this.angle),s.Add(this.position)}return t}get boundingRect(){let t=this.GetVertices(),e=0,s=0;for(let r=0;r<t.length;++r){let l=t[r].Mag();l>e&&(e=l,s=r)}let n=e*2;return{width:n,height:n}}static GetFaceNormals(t){let e=[];for(let s=0;s<t.length;s++){let n=t[s].Clone(),r=t[(s+1)%t.length].Clone();e[s]=r.Clone().Sub(n).Norm().Unit()}return e}static FindSupportPoint(t,e,s){let n=-1/0,r=-1;for(let h=0;h<t.length;h++){let l=t[h].Clone().Sub(s),d=a.Dot(l,e);d>0&&d>n&&(n=d,r=h)}return{sp:t[r],depth:n}}Contains(t){let e=this.GetComputedVertices(),s=e.length,n=0;for(let r=0;r<s;++r){let h=e[r],l=e[(r+1)%s];(t.y-h.y)*(t.y-l.y)<=0&&(t.x<=h.x||t.x<=l.x)&&(h.x>=t.x&&l.x>=t.x||(l.x-h.x)*(t.y-h.y)/(l.y-h.y)>=t.x-h.x)&&++n}return n%2}},kt=class extends C{constructor(t){super(t);this._width=t.width,this._height=t.height,this._points=[[-this._width/2,-this._height/2],[this._width/2,-this._height/2],[this._width/2,this._height/2],[-this._width/2,this._height/2]]}get width(){return this._width}get height(){return this._height}get inertia(){return(this.width**2+this.height**2)/2/this.rotation}},b=class extends B{constructor(t){super(t);this._radius=t.radius}get radius(){return this._radius}get boundingRect(){return{width:2*this.radius,height:2*this.radius}}get inertia(){return Math.PI*this.radius**2/2/this.rotation}FindSupportPoint(t,e){let s=[];s[0]=this.position.Clone().Add(t.Clone().Mult(this.radius)),s[1]=this.position.Clone().Add(t.Clone().Mult(-this.radius));let n=-1/0,r=-1;for(let h=0;h<s.length;h++){let l=s[h].Clone().Sub(e),d=a.Dot(l,t);d>0&&d>n&&(n=d,r=h)}return{sp:s[r],depth:n,n:t}}FindNearestVertex(t){let e=1/0,s=0;for(let n=0;n<t.length;n++){let r=a.Dist(t[n],this.position);r<e&&(e=r,s=n)}return t[s]}Contains(t){return a.Dist(t,this.position)<=this.radius}},jt=class extends C{constructor(t){super(t);this._radius=t.radius,this._sides=t.sides;let e=[];for(let s=0;s<this._sides;++s){let n=Math.PI*2/this._sides*s;e.push([Math.cos(n)*this._radius,Math.sin(n)*this._radius])}this._points=e}get radius(){return this._radius}get boundingRect(){return{width:2*this.radius,height:2*this.radius}}get inertia(){return Math.PI*this.radius**2/1/this.rotation}},j=class extends B{constructor(t){super(t);this._range=t.range}get range(){return this._range}set range(t){this._range=t}get boundingRect(){return{width:2*this.range,height:2*this.range}}get point(){return this.position.Clone().Add(new a(this.range,0).Rotate(this.angle))}},it=(o,t)=>o instanceof b&&t instanceof b?qt(o,t):o instanceof C&&t instanceof C?Nt(o,t):o instanceof b&&t instanceof C?Vt(o,t):o instanceof C&&t instanceof b?Vt(t,o):o instanceof j&&t instanceof C?Rt(o,t):o instanceof C&&t instanceof j?Rt(t,o):o instanceof j&&t instanceof b?It(o,t):o instanceof b&&t instanceof j?It(t,o):{collide:!1},Tt=(o,t,e,s)=>{let n=t.Clone().Sub(o),r=s.Clone().Sub(e),h=n.x*r.y-n.y*r.x,l=((e.x-o.x)*n.y-(e.y-o.y)*n.x)/h,d=((e.x-o.x)*r.y-(e.y-o.y)*r.x)/h;return 0<=l&&l<=1&&0<=d&&d<=1?{collide:!0,point:o.Clone().Add(n.Clone().Mult(d))}:{collide:!1}},Rt=(o,t)=>{let e=o.point,s=1/0,n=null,r=t.GetComputedVertices();for(let h=0;h<r.length;++h){let l=r[h],d=r[(h+1)%r.length],_=Tt(o.position,e,l,d);if(_.collide){let f=a.Dist(o.position,_.point);f<s&&(s=f,n=_.point)}}return n!=null?(o._collisions.all.add(t),t._collisions.all.add(o),{collide:!0,point:n}):{collide:!1}},It=(o,t)=>{let e=o.point,s=e.Clone().Sub(o.position).Unit(),n=t.position.Clone().Sub(o.position),r=t.radius**2,h=n.Mag()**2,l=a.Dot(n,s),d=h-l*l;if(r-d<0)return{collide:!1};let _=Math.sqrt(r-d),f;h<r?f=l+_:f=l-_;let u=o.position.Clone().Add(s.Clone().Mult(f));return a.Dot(u.Clone().Sub(o.position),e.Clone().Sub(o.position))<0||a.Dist(u,o.position)>o.range?{collide:!1}:(o._collisions.all.add(t),t._collisions.all.add(o),{collide:!0,point:u})},qt=(o,t)=>{let e=o.position.Clone().Sub(t.position),s={};return e.Mag()<o.radius+t.radius?(s.normal=e.Clone().Unit(),s.depth=o.radius+t.radius-e.Mag(),s.point=o.position.Clone().Add(s.normal.Clone().Mult(o.radius)),s.collide=!0,o._collisions.all.add(t),t._collisions.all.add(o),s):{collide:!1}},Nt=(o,t)=>{let e=o.GetComputedVertices(),s=t.GetComputedVertices(),n=C.GetFaceNormals(e),r=C.GetFaceNormals(s),h=[];for(let u=0;u<n.length;u++){let c=C.FindSupportPoint(s,n[u].Clone().Mult(-1),e[u]);if(c.n=n[u].Clone(),h[u]=c,c.sp==null)return{collide:!1}}let l=[];for(let u=0;u<r.length;u++){let c=C.FindSupportPoint(e,r[u].Clone().Mult(-1),s[u]);if(c.n=r[u].Clone(),l[u]=c,c.sp==null)return{collide:!1}}h=h.concat(l);let d=1/0,_=0;for(let u=0;u<h.length;u++)h[u].depth<d&&(d=h[u].depth,_=u);let f=t.position.Clone().Sub(o.position);return a.Dot(f,h[_].n)>0&&h[_].n.Mult(-1),o._collisions.all.add(t),t._collisions.all.add(o),{collide:!0,normal:h[_].n,depth:h[_].depth,point:h[_].sp}},Vt=(o,t)=>{let e=t.GetComputedVertices(),s=C.GetFaceNormals(e),n=[];for(let u=0;u<s.length;u++){let c=o.FindSupportPoint(s[u].Clone().Mult(-1),e[u].Clone());if(c.sp==null)return{collide:!1};n[u]=c}let r=o.FindNearestVertex(e),h=t.position.Clone().Sub(o.position).Unit().Mult(-1),l=C.FindSupportPoint(e,h.Clone(),o.position.Clone().Add(h.Clone().Mult(-o.radius)));if(l.sp==null)return{collide:!1};l.n=h.Clone(),n.push(l);let d=1/0,_=0;for(let u=0;u<n.length;u++)n[u].depth<d&&(d=n[u].depth,_=u);let f=t.position.Clone().Sub(o.position);return a.Dot(f,n[_].n)<0&&n[_].n.Mult(-1),o._collisions.all.add(t),t._collisions.all.add(o),{collide:!0,normal:n[_].n,point:n[_].sp,depth:n[_].depth}},Xt=(o,t,e)=>{o instanceof b&&t instanceof C&&([o,t]=[t,o]);let s=it(o,t);if(s.collide){let n={collide:!0,point:s.point};if(o.mass===0&&t.mass===0)return n;o.options.axes.x&&t.options.axes.x||(s.normal.x=0),o.options.axes.y&&t.options.axes.y||(s.normal.y=0);let r=e.bounce,h=e.friction,l={left:new a(-1,0),right:new a(1,0),top:new a(0,-1),bottom:new a(0,1)},d;a.Dot(s.normal,l.left)>=Math.SQRT2/2?d="left":a.Dot(s.normal,l.right)>=Math.SQRT2/2?d="right":a.Dot(s.normal,l.top)>=Math.SQRT2/2?d="top":a.Dot(s.normal,l.bottom)>=Math.SQRT2/2&&(d="bottom");let _=s.point.Clone().Sub(o.position),f=s.point.Clone().Sub(t.position),u=o.angularVelocity,c=t.angularVelocity,g=o._vel,m=t._vel,x=g.Clone().Add(new a(-u*_.y,u*_.x)),F=m.Clone().Add(new a(-c*f.y,c*f.x)),M=x.Clone().Sub(F),A=-(1+r)*a.Dot(M,s.normal)/(o.inverseMass+t.inverseMass+Math.pow(a.Cross(_,s.normal),2)/o.inertia+Math.pow(a.Cross(f,s.normal),2)/t.inertia),R=s.normal.Clone().Mult(A),yt=R.Clone().Mult(o.inverseMass),wt=R.Clone().Mult(t.inverseMass),vt=a.Dot(R,l.left),Ct=a.Dot(R,l.right),xt=a.Dot(R,l.top),bt=a.Dot(R,l.bottom);if((vt>=Math.SQRT2/2||vt<Math.SQRT2/2&&d=="left")&&(!o.options.sides.right||!t.options.sides.left))return n;if((Ct>=Math.SQRT2/2||Ct<Math.SQRT2/2&&d=="right")&&(!o.options.sides.left||!t.options.sides.right))return n;if((xt>=Math.SQRT2/2||xt<Math.SQRT2/2&&d=="top")&&(!o.options.sides.bottom||!t.options.sides.top))return n;if((bt>=Math.SQRT2/2||bt<Math.SQRT2/2&&d=="bottom")&&(!o.options.sides.top||!t.options.sides.bottom))return n;let Mt=s.normal.Clone().Mult(s.depth/(o.inverseMass+t.inverseMass));if(o.position.Add(Mt.Clone().Mult(o.inverseMass)),t.position.Sub(Mt.Clone().Mult(t.inverseMass)),a.Dot(M,s.normal)<=0){o._vel.Add(yt),t._vel.Sub(wt),o.angularVelocity+=a.Cross(_,yt.Clone().Mult(1/o.inertia)),t.angularVelocity-=a.Cross(f,wt.Clone().Mult(1/o.inertia));let L=s.normal.Clone().Norm(),zt=-(1+r)*a.Dot(M,L)*h/(o.inverseMass+t.inverseMass+Math.pow(a.Cross(_,L),2)/o.inertia+Math.pow(a.Cross(f,L),2)/t.inertia),St=L.Clone().Mult(zt),Pt=St.Clone().Mult(o.inverseMass),At=St.Clone().Mult(t.inverseMass);switch(o._vel.Add(Pt.Clone()),t._vel.Sub(At.Clone()),o.angularVelocity+=a.Cross(_,Pt.Clone().Mult(1/o.inertia)),t.angularVelocity-=a.Cross(f,At.Clone().Mult(1/t.inertia)),d){case"left":o._collisions.right.add(t),t._collisions.left.add(o);break;case"right":o._collisions.left.add(t),t._collisions.right.add(o);break;case"top":o._collisions.bottom.add(t),t._collisions.top.add(o);break;case"bottom":o._collisions.top.add(t),t._collisions.bottom.add(o);break}}return d=="bottom"?t.followBottomObject&&t.passiveVelocity.Copy(o.velocity):d=="top"&&o.followBottomObject&&o.passiveVelocity.Copy(t.velocity),n}return{collide:!1}},st=class{constructor(t,e,s){this._body1=t,this._body2=e;let n=p.ParseObject(s.offset1,{x:0,y:0});this.offset1=new a(n.x,n.y);let r=p.ParseObject(s.offset2,{x:0,y:0});this.offset2=new a(r.x,r.y);let h=this._body1.position.Clone().Add(this.offset1.Clone().Rotate(this._body1.angle)),l=this._body2.position.Clone().Add(this.offset2.Clone().Rotate(this._body2.angle));this.length=p.ParseValue(s.length,Math.max(a.Dist(h,l),1)),this.strength=p.ParseValue(s.strength,1)}Update(t){}},Et=class extends st{constructor(t,e,s){super(t,e,s)}Update(t){if(this._body1.mass===0&&this._body2.mass===0)return;let e=this.offset1.Clone().Rotate(this._body1.angle),s=this.offset2.Clone().Rotate(this._body2.angle),n=this._body1.position.Clone().Add(e),r=this._body2.position.Clone().Add(s),h=n.Clone().Sub(r),l=h.Clone().Unit(),_=(h.Mag()-this.length)/this.length,f=l.Clone().Mult(_*-this.strength*512/(this._body1.inverseMass+this._body2.inverseMass)),u=f.Clone().Mult(this._body1.inverseMass);this._body1.velocity.Add(u.Clone().Mult(t)),this._body1.angularVelocity+=a.Cross(e,u.Clone().Mult(1/this._body1.inertia))*t;let c=f.Clone().Mult(this._body2.inverseMass);this._body2.velocity.Sub(c.Clone().Mult(t)),this._body2.angularVelocity-=a.Cross(s,c.Clone().Mult(1/this._body2.inertia))*t}},Ot=class extends st{constructor(t,e,s){super(t,e,s)}Update(t){if(this._body1.mass===0&&this._body2.mass===0)return;let e=this.offset1.Clone().Rotate(this._body1.angle),s=this.offset2.Clone().Rotate(this._body2.angle),n=this._body1.position.Clone().Add(e),r=this._body2.position.Clone().Add(s),h=n.Clone().Sub(r),l=h.Clone().Unit(),d=h.Mag(),_=16,f=l.Clone().Mult((d-this.length)*-1/(this._body1.inverseMass+this._body2.inverseMass));this._body1.position.Add(f.Clone().Mult(this._body1.inverseMass*_*t)),this._body2.position.Sub(f.Clone().Mult(this._body2.inverseMass*_*t));let u=(d-this.length)/this.length,c=l.Clone().Mult(u*-this.strength*512/(this._body1.inverseMass+this._body2.inverseMass)),g=c.Clone().Mult(this._body1.inverseMass);this._body1.velocity.Add(g.Clone().Mult(t)),this._body1.angularVelocity+=a.Cross(e,g.Clone().Mult(1/this._body1.inertia))*t;let m=c.Clone().Mult(this._body2.inverseMass);this._body2.velocity.Sub(m.Clone().Mult(t)),this._body2.angularVelocity-=a.Cross(s,m.Clone().Mult(1/this._body2.inertia))*t}};var rt={};q(rt,{AmbientLight:()=>z,RadialLight:()=>Ft});var ot=class extends w{constructor(t){super();this._type="light",this._color=p.ParseValue(t.color,"white"),this._colorParsed=null}get color(){return this._color}set color(t){this._color=t,this._colorParsed=null}Draw0(t){this._colorParsed||(this._colorParsed=D.ParseColor(t,this.color)),t.save(),t.fillStyle=this._colorParsed,this.Draw(t),t.restore()}Draw(t){}},z=class extends ot{constructor(t){super(t)}Draw(t){t.beginPath(),t.fillRect(0,0,t.canvas.width,t.canvas.height)}},Ft=class extends ot{constructor(t){super(t);this.radius=p.ParseValue(t.radius,100),this.angle=0,this.angleRange=p.ParseValue(t.angleRange,Math.PI*2)}Draw(t){t.beginPath(),t.translate(this.position.x,this.position.y),t.rotate(this.angle),t.arc(0,0,this.radius,-this.angleRange/2,this.angleRange/2),t.lineTo(0,0),t.closePath(),t.fill()}};var ht=class{constructor(t){this._zIndex=0,this._background=t.background,this._backgroundParsed=null,this._world=new G(t.physics),this.paused=!0,this.speed=1,this.timeout=new V,this._lights=[],this._ambientLight=new z({color:t.light||"white"}),this._keys=new Set,this._drawable=[],this._interactiveEntities=[],this._eventHandlers=new Map,this._entityManager=new J,this._camera=new $,this._buffer=null}get camera(){return this._camera}set light(t){this._ambientLight.color=t}get background(){return this._background}set background(t){this._background=t,this._backgroundParsed=null}IsPressed(t){return this._keys.has(t)}CreateEntity(t){let e=new Z;return this.AddEntity(e,t),e}On(t,e){this._eventHandlers.has(t)||this._eventHandlers.set(t,[]),this._eventHandlers.get(t).push(e)}Off(t,e){if(!this._eventHandlers.has(t))return;let s=this._eventHandlers.get(t),n=s.indexOf(e);n>-1&&s.splice(n,1)}SetInteractive(t,e={}){this._interactiveEntities.push(t);let s=new K(e);t.AddComponent(s),t.interactive=s}_On(t,e){if(this.paused)return!1;let s=!1;if(t=="mousedown"){let n=this._world._quadtree.FindNear([e.x,e.y],[0,0]).map(r=>r.entity);for(let r of n)!r.interactive||r.body.Contains(new a(e.x,e.y))&&(r.interactive._On(t,e),r.interactive._id=e.id,r.interactive._capture&&(s=!0))}else if(t=="mousemove"||t=="mouseup")for(let n of this._interactiveEntities)n.interactive._id==e.id&&(n.interactive._capture&&(s=!0),n.interactive._On(t,e),t=="mouseup"&&(n.interactive._id=-1));else t=="keydown"?this._keys.add(e.key):t=="keyup"&&this._keys.delete(e.key);if(s)return!0;if(this._eventHandlers.has(t)){let n=this._eventHandlers.get(t);for(let r of n)r(e)}return s}GetEntityByName(t){return this._entityManager.Get(t)}GetEntitiesByGroup(t){return this._entityManager.Filter(e=>e.groupList.has(t))}AddEntity(t,e){t._scene=this,this._entityManager.Add(t,e)}Raycast(t,e,s,n){return this._world.Raycast(t,e,s,n)}RemoveEntity(t){this._entityManager.Remove(t),t._components.forEach(e=>{switch(e._type){case"drawable":this._RemoveDrawable(e);break;case"body":this._RemoveBody(t,e);break;case"light":this._lights.splice(this._lights.indexOf(e),1);break;case"interactive":this._interactiveEntities.splice(this._interactiveEntities.indexOf(t),1);break}})}_AddDrawable(t){this._drawable.push(t);for(let e=this._drawable.length-1;e>0&&!(t._zIndex>=this._drawable[e-1]._zIndex);--e)[this._drawable[e],this._drawable[e-1]]=[this._drawable[e-1],this._drawable[e]]}_RemoveDrawable(t){let e=this._drawable.indexOf(t);e!=-1&&this._drawable.splice(e,1)}_AddBody(t,e){this._world._AddBody(t,e)}_RemoveBody(t,e){this._world._RemoveBody(t,e)}Update(t){this.paused||(this.timeout.Update(t*1e3),this._entityManager.Update(t),this._world.Update(t),this._camera.Update(t))}Play(){this.paused=!1}Pause(){this.paused=!0}DrawLights(t,e,s){t.globalCompositeOperation="source-over",this._ambientLight.Draw0(t);let n=this.camera;t.globalCompositeOperation="lighter",t.save(),t.translate(-n.position.x*n.scale+e/2,-n.position.y*n.scale+s/2),t.scale(n.scale,n.scale);for(let r of this._lights)r.Draw0(t);t.restore(),t.globalCompositeOperation="multiply"}DrawObjects(t,e,s){let n=this.camera;this._buffer||(this._buffer=document.createElement("canvas").getContext("2d"),this._buffer.canvas.width=e,this._buffer.canvas.height=s,this._buffer.imageSmoothingEnabled=!1);let r=this._buffer;this._backgroundParsed||(this._backgroundParsed=D.ParseColor(r,this.background)),r.beginPath(),r.fillStyle=this._backgroundParsed,r.fillRect(0,0,e,s),r.save(),r.translate(-n.position.x*n.scale+e/2,-n.position.y*n.scale+s/2),r.scale(n.scale,n.scale);for(let h of this._drawable){let l=h.boundingBox,d=new a(l.x,l.y);d.Sub(n.position),d.Mult(n.scale);let[_,f]=[l.width,l.height].map(u=>u*n.scale);d.x+_/2<-this._width/2||d.x-_/2>this._width/2||d.y+f/2<-this._height/2||d.y-f/2>this._height/2||h.Draw0(r)}r.restore(),t.drawImage(r.canvas,0,0)}};var P=class{constructor(){this._toLoad=[],this._size=0,this._counter=0,this._path=""}_Add(t,e,s){let n;e.startsWith("/")?n=this._path+e.slice(1):n=this._path+e,this._toLoad.push({name:t,path:n,type:s}),++this._size}AddImage(t,e){return this._Add(t,e,"image"),this}AddAudio(t,e){return this._Add(t,e,"audio"),this}AddJSON(t,e){return this._Add(t,e,"json"),this}AddFont(t,e){return this._Add(t,e,"font"),this}_HandleCallback(t,e,s,n){t.set(e.name,s),++this._counter,this._HandleOnProgress(e),this._counter===this._size&&(this._counter=this._size=0,this._toLoad=[],n(t))}_OnProgressHandler(t,e){}OnProgress(t){return this._OnProgressHandler=t,this}SetPath(t){return this._path=t,this._path.endsWith("/")||(this._path+="/"),this}_HandleOnProgress(t){let e=this._counter/this._size;this._OnProgressHandler(e,t)}Load(t){let e=new Map;if(this._size===0){t(e);return}for(let s of this._toLoad)switch(s.type){case"image":P.LoadImage(s.path,n=>{this._HandleCallback(e,s,n,t)});break;case"audio":P.LoadAudio(s.path,n=>{this._HandleCallback(e,s,n,t)});break;case"json":P.LoadJSON(s.path,n=>{this._HandleCallback(e,s,n,t)});break;case"font":P.LoadFont(s.name,s.path,n=>{this._HandleCallback(e,s,n,t)})}}static LoadImage(t,e){let s=new Image;s.src=t,s.addEventListener("load",()=>{e(s)},{once:!0})}static LoadAudio(t,e){let s=new Audio(t);s.load(),s.addEventListener("canplaythrough",()=>{e(s)},{once:!0})}static LoadJSON(t,e){fetch(t).then(s=>s.json()).then(s=>e(s))}static LoadFont(t,e,s){new FontFace(t,`url(${e})`).load().then(r=>{document.fonts.add(r),s(t)})}};var lt=class{constructor(t){this._width=t.width,this._height=t.height,this._preload=t.preload==null?null:t.preload.bind(this),this._init=t.init.bind(this),this._parentElement=p.ParseValue(t.parentElement,document.body),this._resources=null,this._loader=new P;let e=this._parentElement;e.style.userSelect="none",e.style.touchAction="none",e.style.WebkitUserSelect="none",e.style.position="relative",e.style.overflow="hidden",e.style.background="black",this._renderer=new Q({width:this._width,height:this._height,parentElement:e}),this._engine=new X,this._sceneManager=new Y;let s=p.ParseObject(t.controls,{active:!1,layout:{joystick:{left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown"},X:"e",Y:"d",A:"s",B:"f",SL:"Control",SR:"Control",start:" ",select:"Tab"}});s.active&&"ontouchstart"in document&&this._InitControls(s.layout),this.timeout=this._engine.timeout,this.audio=(()=>{let r=new Map,h=c=>{r.set(c,new N)};return{Play:(c,g,m={})=>{r.has(c)||h(c);let x=r.get(c);x._audioMap.has(g)||x.AddAudio(g,this._resources.get(g)),m.primary===!1?x.PlaySecondary(g):x.Play(g,m)},Pause:c=>{r.get(c).Pause()},SetVolume:(c,g)=>{r.has(c)||h(c),r.get(c).volume=g},IsPlaying:c=>r.get(c).playing,GetVolume:c=>(r.has(c)||h(c),r.get(c).volume)}})();let n=r=>{for(let h of this._sceneManager._scenes)h.Update(r*.001);this._renderer.Render(this._sceneManager._scenes)};this._engine._step=n,this._InitSceneEvents(),this._engine.Start(),this._preload?(this._preload(),this._loader.Load(r=>{this._resources=r,this._init()})):(this._resources=new Map,this._init())}get loader(){return this._loader}get resources(){return this._resources}_InitControls(t){let e=(u,c=!0)=>{let g="rgba(150, 150, 150, 0.6)";u.style.pointerEvents="auto",u.style.position="absolute",u.style.border="2px solid "+g,u.style.color=g,u.style.fontFamily="Arial",u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="center",c&&(u.style.background="radial-gradient(circle at center, "+g+" 0, rgba(0, 0, 0, 0.6) 60%)")},s=(u,c,g)=>{let m=document.createElement("div");return m.style.width="46px",m.style.height="46px",m.style.right=u-5+"px",m.style.bottom=c+10+"px",m.textContent=g,m.style.borderRadius="50%",m.style.fontSize="22px",e(m),h.appendChild(m),m},n=u=>{let c=document.createElement("div");return c.style.width="46px",c.style.height="46px",c.style.bottom=190+"px",c.style.fontSize="22px",u=="left"?(c.style.left=5+"px",c.textContent="L",c.style.borderRadius="50% 0 0 50%"):u=="right"&&(c.style.right=5+"px",c.textContent="R",c.style.borderRadius="0 50% 50% 0"),e(c),h.appendChild(c),c},r=u=>{let c=document.createElement("div");return c.style.width="50px",c.style.height="22px",u=="Start"?c.style.left="calc(50% + "+3+"px)":u=="Select"&&(c.style.right="calc(50% + "+3+"px)"),c.style.bottom=20+"px",c.textContent=u,c.style.borderRadius="12px",c.style.fontSize="12px",c.style.fontWeight="bolder",e(c),h.appendChild(c),c},h=document.createElement("div");h.style.width="100%",h.style.height="100%",h.style.left="0",h.style.top="0",h.style.zIndex="999",h.style.position="absolute",h.style.pointerEvents="none";let l={},d=document.createElement("div");d.style.width="120px",d.style.height="120px",d.style.left="10px",d.style.bottom="50px",d.style.borderRadius="50%",d.style.overflow="hidden",e(d),h.appendChild(d);for(let u=0;u<4;++u){let c=document.createElement("div");c.style.width="120px",c.style.height="120px",c.style.left=-75+150*(u%2)+"px",c.style.top=-75+150*Math.floor(u/2)+"px",e(c,!1),d.appendChild(c)}l.joystick=d,l.A=s(10,63,"A"),l.B=s(63,10,"B"),l.X=s(63,116,"X"),l.Y=s(116,63,"Y"),l.SL=n("left"),l.SR=n("right"),l.select=r("Select",-20),l.start=r("Start",20),this._parentElement.appendChild(h);let _=u=>{let c={left:new a(-1,0),right:new a(1,0),top:new a(0,-1),bottom:new a(0,1)},g=d.getBoundingClientRect(),m=u.changedTouches[0].pageX-(g.left+g.width/2),x=u.changedTouches[0].pageY-(g.top+g.height/2),F=new a(m,x);if(F.Mag()<20)return[];let M=F.Clone().Unit(),A=[];return a.Dot(M,c.left)>=.5&&A.push("left"),a.Dot(M,c.right)>=.5&&A.push("right"),a.Dot(M,c.top)>=.5&&A.push("up"),a.Dot(M,c.bottom)>=.5&&A.push("down"),A},f=(u,c,g)=>{for(let m of c)this._HandleSceneEvent(u,{key:g[m]})};for(let u in l){let c=l[u],g=t[u];if(u=="joystick"){c.addEventListener("touchstart",m=>{let x=_(m);f("keydown",x,g)}),c.addEventListener("touchmove",m=>{f("keyup",["left","right","up","down"],g);let x=_(m);f("keydown",x,g)}),c.addEventListener("touchend",m=>{let x=_(m);f("keyup",["left","right","up","down"],g)});continue}c.addEventListener("touchstart",()=>{this._HandleSceneEvent("keydown",{key:g})}),c.addEventListener("touchend",()=>{this._HandleSceneEvent("keyup",{key:g})})}}RequestFullScreen(){let t=this._parentElement;var e=t.requestFullScreen||t.webkitRequestFullScreen;if(e)e.call(t);else if(typeof window.ActiveXObject!="undefined"){var s=new ActiveXObject("WScript.Shell");s!==null&&s.SendKeys("{F11}")}}_InitSceneEvents(){let t="ontouchstart"in document,e=this._renderer._canvas;t?(e.addEventListener("touchstart",s=>this._HandleTouchEvent(s)),e.addEventListener("touchmove",s=>this._HandleTouchEvent(s)),e.addEventListener("touchend",s=>this._HandleTouchEvent(s))):(e.addEventListener("mousedown",s=>this._HandleMouseEvent(s)),e.addEventListener("mousemove",s=>this._HandleMouseEvent(s)),e.addEventListener("mouseup",s=>this._HandleMouseEvent(s))),addEventListener("keydown",s=>this._HandleKeyEvent(s)),addEventListener("keyup",s=>this._HandleKeyEvent(s))}_HandleKeyEvent(t){this._HandleSceneEvent(t.type,{key:t.key})}_HandleTouchEvent(t){let e={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"};this._HandleSceneEvent(e[t.type],{x:t.changedTouches[0].pageX,y:t.changedTouches[0].pageY})}_HandleMouseEvent(t){this._HandleSceneEvent(t.type,{x:t.pageX,y:t.pageY})}_HandleSceneEvent(t,e){for(let s of this._sceneManager._scenes){let n=Object.assign({},e);if(t.startsWith("mouse")){let r=this._renderer.DisplayToSceneCoords(s,n.x,n.y);n.x=r.x,n.y=r.y}if(s._On(t,n))break}}CreateSection(t){let e=document.createElement("div");return e.id=t,e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.display="none",this._renderer._container.appendChild(e),e}GetSection(t){return document.getElementById(t)}ShowSection(t){this.GetSection(t).style.display="block"}HideSection(t){this.GetSection(t).style.display="none"}CreateScene(t,e={}){let s=new ht(e);return s.resources=this._resources,this._sceneManager.Add(s,t,e.zIndex||0),s}PlayScene(t){return this._sceneManager.Play(t)}};var I=class extends w{constructor(t={}){super();this._type="drawable",this._zIndex=p.ParseValue(t.zIndex,0),this.opacity=p.ParseValue(t.opacity,1),this._fillStyle=p.ParseValue(t.fillStyle,"black"),this._strokeStyle=p.ParseValue(t.strokeStyle,"black"),this.strokeWidth=p.ParseValue(t.strokeWidth,0),this.mode=p.ParseValue(t.mode,"source-over"),this._fillStyleParsed=null,this._strokeStyleParsed=null}get zIndex(){return this._zIndex}set zIndex(t){this._zIndex=t,this.scene&&(this.scene._RemoveDrawable(this),this.scene._AddDrawable(this))}get fillStyle(){return this._fillStyle}set fillStyle(t){this._fillStyle=t,this._fillStyleParsed=null}get strokeStyle(){return this._strokeStyle}set strokeStyle(t){this._strokeStyle=t,this._strokeStyleParsed=null}get boundingBox(){return{x:0,y:0,width:0,height:0}}Draw(t){}Draw0(t){this.ParseStyles(t),t.save(),t.globalCompositeOperation=this.mode,t.globalAlpha=this.opacity,t.fillStyle=this._fillStyleParsed,t.strokeStyle=this._strokeStyleParsed,t.lineWidth=this.strokeWidth,this.Draw(t),t.restore()}ParseStyles(t){this._fillStyleParsed||(this._fillStyleParsed=D.ParseColor(t,this.fillStyle)),this._strokeStyleParsed||(this._strokeStyleParsed=D.ParseColor(t,this.strokeStyle))}},v=class extends I{constructor(t){super(t);this._offset=new a,this._shaking=null,this.flip=p.ParseObject(t.flip,{x:!1,y:!1}),this._scale=p.ParseObject(t.scale,{x:1,y:1}),this._image=null,this._imageOptions=t.image,this.center=new a,this._width=p.ParseValue(t.width,0),this._height=p.ParseValue(t.height,0),this._angle=0}InitComponent(){this._imageOptions&&(this._image=this.scene.resources.get(this._imageOptions.src),this._imageOptions=p.ParseObject(this._imageOptions,{frameWidth:this._image.width,frameHeight:this._image.height,framePosition:{x:0,y:0}}))}get width(){return this._width}get height(){return this._height}set width(t){this._width=t}set height(t){this._height=t}set angle(t){this._angle=t}get angle(){return this._angle}get scale(){return this._scale}set scale(t){this._scale=t}get boundingBox(){let t=Math.hypot(this._width,this._height);return{width:t*this.scale.x,height:t*this.scale.y,x:this.position.x,y:this.position.y}}Shake(t,e,s,n){this._shaking={counter:0,freq:s,angle:n,dur:e,range:t}}StopShaking(){this._shaking=null,this._offset=new a}Draw0(t){this.ParseStyles(t),t.save(),t.translate(-this._offset.x,-this._offset.y),t.globalCompositeOperation=this.mode,t.globalAlpha=this.opacity,t.translate(this.position.x,this.position.y),t.scale(this.flip.x?-this.scale.x:this.scale.x,this.flip.y?-this.scale.y:this.scale.y),t.rotate(this.angle),t.translate(this.center.x,this.center.y),t.fillStyle=this._fillStyleParsed,t.strokeStyle=this._strokeStyleParsed,t.lineWidth=this.strokeWidth,this.Draw(t),t.restore()}DrawImage(t,e,s,n=!0,r=this._imageOptions.framePosition){n&&t.clip(),t.drawImage(this._image,r.x*this._imageOptions.frameWidth,r.y*this._imageOptions.frameHeight,this._imageOptions.frameWidth,this._imageOptions.frameHeight,-e/2,-s/2,e,s)}Update(t){if(this._shaking){let e=this._shaking,s=Math.floor(e.freq/1e3*e.dur);e.counter+=t*1e3;let n=Math.min(e.counter/e.dur,1);this._offset.Copy(new a(Math.sin(n*Math.PI*2*s)*e.range,0).Rotate(e.angle)),n==1&&this.StopShaking()}}FollowBody(){!this.parent.body||this.parent.AddComponent(new Lt({target:this}))}SetSize(t,e){this.width=t,this.height=e}},Lt=class extends w{constructor(t){super();this._target=t.target}Update(t){let e=this.parent.body;this._target.angle=e.angle,this._target.offset=e.offset}};var at=class extends v{constructor(t){super(t);this._radius=t.radius}get radius(){return this._radius}get boundingBox(){return{width:this._radius*2,height:this._radius*2,x:this.position.x,y:this.position.y}}set radius(t){this._radius=t}Draw(t){t.beginPath(),t.arc(0,0,this._radius,0,2*Math.PI),t.fill(),this.strokeWidth>0&&t.stroke(),this._imageOptions&&this.DrawImage(t,this._radius*2,this._radius*2)}};var dt=class extends v{constructor(t){super(t);this.length=t.length}get boundingBox(){let t=a.FromAngle(this.angle).Mult(this.length/2);return{width:this.length,height:this.length,x:t.x,y:t.y}}Draw(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.length,0),t.stroke()}};var W=class extends v{constructor(t){super(t);this._points=p.ParseValue(t.points,[])}get boundingBox(){let t=this._points,e=0,s=0;for(let r=0;r<t.length;++r){let h=t[r],l=Math.hypot(h[0],h[1]);l>e&&(e=l,s=r)}let n=e*2;return{width:n,height:n,x:this.position.x,y:this.position.y}}Draw(t){t.beginPath();for(let e=0;e<this._points.length;++e){let s=this._points[e];e==0?t.moveTo(...s):t.lineTo(...s)}t.closePath(),t.fill(),this.strokeWidth>0&&t.stroke()}},ct=class extends W{constructor(t){super(t);this._radius=t.radius,this.sides=t.sides,this._InitPoints()}_InitPoints(){let t=[];for(let e=0;e<this.sides;++e){let s=Math.PI*2/this.sides*e;t.push([Math.cos(s)*this.radius,Math.sin(s)*this.radius])}this._points=t}get radius(){return this._radius}set radius(t){this._radius=t}get boundingBox(){return{width:this._radius*2,height:this._radius*2,x:this.position.x,y:this.position.y}}Draw(t){super.Draw(t),this._imageOptions&&this.DrawImage(t,this.radius*2,this.radius*2)}};var ut=class extends v{constructor(t){super(t)}Draw(t){t.beginPath(),t.rect(-this._width/2,-this._height/2,this._width,this._height),t.fill(),this.strokeWidth>0&&t.stroke(),this._imageOptions&&this.DrawImage(t,this._width,this._height)}};var E=class extends v{constructor(t){super(t);this._anims=new Map,this._currentAnim=null,this._paused=!0,this._framePos={x:0,y:0}}AddAnim(t,e){this._anims.set(t,e)}PlayAnim(t,e,s,n){if(this.currentAnim==t)return;this._paused=!1;let r={name:t,rate:e,repeat:s,OnEnd:n,frame:0,counter:0};this._currentAnim=r,this._framePos=this._anims.get(r.name)[r.frame]}Reset(){this._currentAnim&&(this._currentAnim.frame=0,this._currentAnim.counter=0)}Pause(){this._paused=!0}Resume(){this._currentAnim&&(this._paused=!1)}Update(t){if(super.Update(t),this._paused)return;let e=this._currentAnim,s=this._anims.get(e.name);e.counter+=t*1e3,e.counter>=e.rate&&(e.counter=0,++e.frame,e.frame>=s.length&&(e.frame=0,e.OnEnd&&e.OnEnd(),e.repeat||(this._currentAnim=null,this._paused=!0)),this._framePos=s[e.frame])}get currentAnim(){return this._currentAnim?this._currentAnim.name:null}Draw(t){this.DrawImage(t,this._width,this._height,!1,this._framePos)}};var O=class extends v{constructor(t){super(t)}Draw(t){this.DrawImage(t,this._width,this._height,!1)}};var _t=class extends v{constructor(t){super(t);this._text=t.text,this._lines=this._text.split(/\n/),this._padding=p.ParseValue(t.padding,0),this._align=p.ParseValue(t.align,"center"),this._fontSize=p.ParseValue(t.fontSize,16),this._fontFamily=p.ParseValue(t.fontFamily,"Arial"),this._fontStyle=p.ParseValue(t.fontStyle,"normal"),this._ComputeDimensions()}get linesCount(){return this._lines.length}get lineHeight(){return this._fontSize+this._padding*2}get text(){return this._text}set text(t){this._text=t,this._ComputeDimensions()}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this._ComputeDimensions()}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily=t,this._ComputeDimensions()}get padding(){return this._padding}set padding(t){this._padding=t,this._ComputeDimensions()}get align(){return this._align}set align(t){this._align=t,this._ComputeDimensions()}_ComputeDimensions(){this._height=this.lineHeight*this.linesCount;let t=0,e=document.createElement("canvas").getContext("2d");e.font=`${this._fontStyle} ${this._fontSize}px '${this._fontFamily}'`;for(let s of this._lines){let n=e.measureText(s).width;n>t&&(t=n)}this._width=t+this._padding*2}Draw(t){let e=this._align=="left"?-this._width/2:this._align=="right"?this._width/2:0;t.font=`${this._fontStyle} ${this._fontSize}px '${this._fontFamily}'`,t.textAlign=this._align,t.textBaseline="middle",t.beginPath();for(let s=0;s<this.linesCount;++s)t.fillText(this._lines[s],e+this._padding,this.lineHeight*s-(this.linesCount-1)/2*this.lineHeight)}};var pt=class extends I{constructor(t){super(t);this._points=t.points}get boundingBox(){let t=this._points,e=1/0,s=-1/0,n=1/0,r=-1/0;for(let h=0;h<t.length;++h){let l=t[h];l[0]<e?e=l[0]:l[0]>s&&(s=l[0]),l[1]<n?n=l[1]:l[1]>r&&(r=l[1])}return{width:Math.abs(s-e),height:Math.abs(r-n),x:(s+e)/2,y:(r+n)/2}}Draw(t){t.beginPath();for(let e=0;e<this._points.length;++e){let s=this._points[e];e==0?t.moveTo(...s):t.lineTo(...s)}t.closePath(),t.fill(),this.strokeWidth>0&&t.stroke()}};var ft={};q(ft,{Emitter:()=>Ht});var Ht=class extends w{constructor(t){super();this._particles=[],this._width=p.ParseValue(t.width,0),this._angle=p.ParseValue(t.angle,0),this._options=p.ParseObject(t.options,{lifetime:{min:1e3,max:1e3},friction:{min:0,max:0},variance:{min:0,max:0},angle:{min:0,max:Math.PI*2},speed:{min:300,max:300},force:{x:0,y:0},scale:{from:1,to:1},opacity:{from:1,to:1},rotationSpeed:{min:0,max:0}}),this._emitting=null}_CreateParticle(){let t=this.scene.CreateEntity(),e=a.FromAngle(this._angle),s=this.position.Clone().Add(e.Clone().Mult(y.rand(-this._width/2,this._width/2)));t.position.Copy(s),t.groupList.add("particle");let n=y.choice(this._particles);t.AddComponent(new n[0](n[1]),"Sprite"),t.AddComponent(new Ut(this._options,this._angle))}Add(t,e){this._particles.push([t,e])}Emit(t,e=!1,s=0){if(e)this._emitting={count:t,counter:s,delay:s};else for(let n=0;n<t;++n)this._CreateParticle()}Update(t){if(this._emitting){let e=this._emitting;e.counter+=t*1e3,e.counter>=e.delay&&(e.counter=0,this.Emit(e.count))}}},Ut=class extends w{constructor(t,e){super();this._friction=this._InitMinMax(t.friction),this._lifetime=this._InitMinMax(t.lifetime),this._angleVariance=this._InitMinMax(t.variance),this._acc=new a(t.force.x,t.force.y),this._counter=0,this._scale=this._InitRange(t.scale),this._opacity=this._InitRange(t.opacity),this._vel=new a(this._InitMinMax(t.speed),0).Rotate(e-Math.PI/2+this._InitMinMax(t.angle)),this._rotationSpeed=this._InitMinMax(t.rotationSpeed)}_InitMinMax(t){return y.rand(t.min,t.max)}_InitRange(t){return t?{from:t.from==null?1:t.from,to:t.to}:null}Update(t){if(this._counter+=t*1e3,this._counter>=this._lifetime){this.scene.RemoveEntity(this.parent);return}this._vel.Add(this._acc.Clone().Mult(t));let e=16,s=new a(this._vel.x*e*this._friction,this._vel.y*e*this._friction);this._vel.Sub(s.Mult(t)),this._vel.Rotate(y.rand(-this._angleVariance,this._angleVariance)*t),this.position.Add(this._vel.Clone().Mult(t));let n=this.GetComponent("Sprite"),r=Math.min(this._counter/this._lifetime,1);this._scale&&(n.scale=y.lerp(r,this._scale.from,this._scale.to)),this._opacity&&(n.opacity=y.lerp(r,this._opacity.from,this._opacity.to)),n.angle+=this._rotationSpeed*t}};var gt=class{constructor(t){this._image=t.image,this._tileWidth=t.tileWidth,this._tileHeight=t.tileHeight,this._columns=t.columns,this._tileData=[]}get image(){return this._image}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get columns(){return this._columns}_CreateData(t){let e={id:t,properties:[]};return this._tileData.push(e),e}_GetData(t){return this._tileData.find(e=>e.id==t)}AddAnim(t,e,s){let n=this._GetData(t);n||(n=this._CreateData(t)),n.animation={frameRate:e,frames:s}}AddProperty(t,e,s){let n=this._GetData(t);n||(n=this._CreateData(t)),n.properties.push({name:e,value:s})}_GetPos(t){return{x:t%this._columns,y:Math.floor(t/this._columns)}}CreateTile(t,e){let s=this._GetData(e),n=t.CreateEntity(),r;return s&&s.animation?(r=new E({image:{src:this._image,frameWidth:this._tileWidth,frameHeight:this._tileHeight}}),r.AddAnim("loop",s.animation.frames.map(h=>this._GetPos(h))),r.PlayAnim("loop",s.animation.frameRate,!0)):r=new O({image:{src:this._image,frameWidth:this._tileWidth,frameHeight:this._tileHeight,framePosition:this._GetPos(e)}}),n.AddComponent(r,"TileSprite"),n.AddComponent(new Gt({properties:s==null?[]:s.properties})),n}},Gt=class extends w{constructor(t){super();this.properties=new Map;for(let e of t.properties)this.properties.set(e.name,e.value)}};var mt=class{constructor(){this.vertices={}}AddVertex(t,e,s,n){this.vertices[t]={id:t,x:e,y:s,neighbors:n,state:0,parent:null,weight:1/0}}_Dist(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}ShortestPath(t,e){let s=(h,l=0,d=null)=>{h.state=1,h.weight=l,h.parent=d,r.push(h);for(let _=r.length-1;_>0&&!(h.weight<r[_-1].weight);--_)[r[_],r[_-1]]=[r[_-1],r[_]]},n=this.vertices[t],r=[];for(s(n);r.length;){let h=r.pop();for(let l of h.neighbors){let d=this.vertices[l];if(d.state==2)continue;let _=this._Dist(h,d),f=h.weight+_;if(d.weight>f&&(s(d,f,h),d.id==e))return d}h.state=2}return null}};var Bt="Lancelot",Qt={Drawable:I,FixedDrawable:v,Circle:at,Line:dt,Polygon:ct,Poly:W,Rect:ut,Sprite:E,Text:_t,Path:pt,Image:O},T={Vector:a,Game:lt,Component:w,Tileset:gt,particles:ft,drawable:Qt,physics:nt,math:y,light:rt,PathGraph:mt};if(typeof module=="object"&&typeof module.exports=="object")module.exports=T;else if(typeof define=="function"&&define.amd)define(Bt,[],T);else{let o=typeof globalThis!="undefined"?globalThis:self;o[Bt]=T}var us=T;})();
