(()=>{var ot=Object.defineProperty;var Dt=n=>ot(n,"__esModule",{value:!0});var H=(n,t)=>{Dt(n);for(var e in t)ot(n,e,{get:t[e],enumerable:!0})};var p=function(){return{rand(n,t){return Math.random()*(t-n)+n},randint(n,t){return Math.floor(Math.random()*(t-n+1)+n)},lerp(n,t,e){return t+(e-t)*n},clamp(n,t,e){return Math.min(Math.max(n,t),e)},in_range(n,t,e){return n>=t&&n<=e},sat(n){return Math.min(Math.max(n,0),1)},ease_out(n){return Math.min(Math.max(Math.pow(n,1/2),0),1)},ease_in(n){return Math.min(Math.max(Math.pow(n,3),0),1)},choice(n){let t=n.length;return n[Math.floor(Math.random()*t)]}}}();var F=class{constructor(){this._volume=1,this._playing=!1,this._audioMap=new Map,this._current=null}get volume(){return this._volume}set volume(t){t=p.sat(t),this._volume=t,this._audioMap.forEach(e=>{e.volume=this._volume})}get playing(){return this._current?!this._current.paused:!1}AddAudio(t,e,i=!1){e.loop=i,e.volume=this._volume,this._audioMap.set(t,e)}Play(t,e=!1){this._current&&this._current.pause();let i=this._audioMap.get(t);i&&(this._current=i,e&&(this._current.currentTime=0),this._current.play())}PlayClone(t){let e=this._audioMap.get(t);if(e){let i=e.cloneNode(!0);i.volume=this._volume,i.play()}}Pause(){this._current&&this._current.pause()}};var b=class{constructor(){this._timeouts=[]}Set(t,e){this._timeouts.push({action:t,dur:e,counter:0})}Update(t){for(let e=0;e<this._timeouts.length;++e){let i=this._timeouts[e];(i.counter+=t)>=i.dur&&(i.action(),this._timeouts.splice(e--,1))}}};var U=class{constructor(t){this._step=t,this.paused=!0,this.timeout=new b}_RAF(){this._paused||(this._frame=window.requestAnimationFrame(t=>{this._RAF();let e=Math.min(t-this._previousRAF,1e3/30);this.timeout.Update(e),this._step(e),this._previousRAF=t}))}Start(){this.paused=!1,this._previousRAF=performance.now(),this._RAF()}Stop(){this.paused=!0,window.cancelAnimationFrame(this._frame)}};var C=function(){return{ParseStyle(n,t){if(t==null)return"black";let e=t.split(";"),i=e.length;if(i===1)return t;let s,o=e[1].split(",").map(r=>parseFloat(r));switch(e[0]){case"linear":s=n.createLinearGradient(...o);break;case"radial":s=n.createRadialGradient(...o);break;default:return"black"}for(let r=2;r<i;++r){let h=e[r].split("=");s.addColorStop(parseFloat(h[1]),h[0])}return s}}}();var a=class{constructor(t=0,e=0){this._x=t,this._y=e}get x(){return this._x}get y(){return this._y}set x(t){this.Set(t,this.y)}set y(t){this.Set(this.x,t)}Set(t,e){this._x=t,this._y=e}Copy(t){return this.Set(t.x,t.y),this}Clone(){return new a(this.x,this.y)}Add(t){return this.Set(this.x+t.x,this.y+t.y),this}Sub(t){return this.Set(this.x-t.x,this.y-t.y),this}Mult(t){return this.Set(this.x*t,this.y*t),this}Norm(){return this.Set(this.y,-this.x),this}Unit(){let t=this.Mag();return t===0?this:(this.Set(this.x/t,this.y/t),this)}Mag(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}Lerp(t,e){return this.Add(t.Clone().Sub(this).Mult(e))}Angle(){return Math.atan2(this.y,this.x)}Rotate(t){let e=Math.sin(t),i=Math.cos(t),s=this.x*i-this.y*e,o=this.x*e+this.y*i;return this.Set(s,o),this}static Dot(t,e){return t.x*e.x+t.y*e.y}static Dist(t,e){return t.Clone().Sub(e).Mag()}static Cross(t,e){return t.x*e.y-t.y*e.x}static AngleBetween(t,e){let i=t.Mag(),s=e.Mag();return i===0||s===0?0:Math.acos(a.Dot(t,e)/(i*s))}},R=class extends a{constructor(t,e=0,i=0){super(e,i);this._positionFunction=t}Set(t,e){(t!=this.x||e!=this.y)&&(this._x=t,this._y=e,this._positionFunction())}};var L=class{constructor(t){this._width=t.width,this._height=t.height,this._aspect=this._width/this._height,this._scale=1,this._InitContainer(),this._InitCanvas(),this._OnResize(),window.addEventListener("resize",()=>this._OnResize())}get dimension(){return this._canvas.getBoundingClientRect()}get background(){return this._background}set background(t){this._background=t,this._canvas.style.background=t}_InitContainer(){let t=document.body;t.style.userSelect="none",t.style.touchAction="none",t.style.position="fixed",t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",t.style.margin="0",t.style.padding="0";let e=this._container=document.createElement("div");e.style.width=this._width+"px",e.style.height=this._height+"px",e.style.position="absolute",e.style.left="50%",e.style.top="50%",e.style.transformOrigin="center",t.appendChild(e)}_InitCanvas(){let t=this._canvas=document.createElement("canvas");t.width=this._width,t.height=this._height,this._context=t.getContext("2d"),t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.display="block",t.style.background=this._background,this._container.appendChild(t)}_OnResize(){let[t,e]=[document.body.clientWidth,document.body.clientHeight];t/e>this._aspect?this._scale=e/this._height:this._scale=t/this._width,this._container.style.transform="translate(-50%, -50%) scale("+this._scale+")",this._context.imageSmoothingEnabled=!1}Render(t){let e=this._context;if(!t)return;e.globalCompositeOperation="source-over",t._ambientLight.Draw(e);let i=t.camera;e.globalCompositeOperation="lighter",e.save(),e.translate(-i.position.x*i.scale+this._width/2,-i.position.y*i.scale+this._height/2),e.scale(i.scale,i.scale);for(let o of t._lights)o.Draw(e);e.restore(),e.globalCompositeOperation="multiply";let s=document.createElement("canvas").getContext("2d");s.canvas.width=this._width,s.canvas.height=this._height,s.beginPath(),s.fillStyle=C.ParseStyle(s,t.background),s.fillRect(0,0,this._width,this._height),s.save(),s.translate(-i.position.x*i.scale+this._width/2,-i.position.y*i.scale+this._height/2),s.scale(i.scale,i.scale);for(let o of t._drawable){let r=o.boundingBox,h=new a(r.x,r.y);h.Sub(i.position),h.Mult(i.scale);let[l,c]=[r.width,r.height].map(u=>u*i.scale);h.x+l/2<-this._width/2||h.x-l/2>this._width/2||h.y+c/2<-this._height/2||h.y-c/2>this._height/2||o.Draw0(s)}s.restore(),e.drawImage(s.canvas,0,0)}DisplayToSceneCoords(t,e,i){let s=this.dimension,o=(e-s.left)/this._scale,r=(i-s.top)/this._scale,h=t.camera;return{x:(o-this._width/2)/h.scale+h.position.x,y:(r-this._height/2)/h.scale+h.position.y}}};var G=class{constructor(){this._currentScene=null,this._scenes=new Map}get currentScene(){return this._currentScene}set currentScene(t){this._currentScene=this._scenes.get(t)||null}Add(t,e){this._scenes.set(e,t)}Play(t){return this.currentScene=t,this._currentScene&&this._currentScene.Play(),this._currentScene}};var O=class{constructor(){this._entities=[],this._entitiesMap=new Map,this._ids=0}_GenerateName(){return++this._ids,"__entity__"+this._ids}Add(t,e){e===void 0&&(e=this._GenerateName()),this._entities.push(t),this._entitiesMap.set(e,t),t._parent=this,t._name=e}Get(t){return this._entitiesMap.get(t)}Remove(t){let e=this._entities.indexOf(t);e<0||this._entities.splice(e,1)}Filter(t){return this._entities.filter(t)}Update(t){for(let e of this._entities)e.Update(t)}};var M=class{constructor(){this._pos=new R(this.DoWeirdStuff.bind(this)),this._parent=null,this._fixed=!1,this._offset=new R(this.DoWeirdStuffWithOffset.bind(this)),this._attached=[],this._moving=null}Clip(t,e=!1){this._attached.push(t),t._parent=this,t._fixed=e,t._offset.Copy(t.position.Clone().Sub(this.position))}Unclip(t){let e=this._attached.indexOf(t);e!=-1&&(this._attached.splice(e,1),t._parent=null)}get position(){return this._pos}set position(t){this.position.Copy(t)}MoveTo(t,e,i="linear"){this._moving={counter:0,dur:e,from:this.position.Clone(),to:t,timing:i}}StopMoving(){this._moving=null}DoWeirdStuff(){this._parent&&(this._fixed?this._parent.position.Copy(this.position.Clone().Sub(this._offset)):this._offset.Copy(this.position.Clone().Sub(this._parent.position)));for(let t of this._attached)t.position.Copy(this.position.Clone().Add(t._offset))}DoWeirdStuffWithOffset(){this._parent&&this._fixed&&this.position.Copy(this._parent.position.Clone().Add(this._offset))}Update(t){if(this._moving){let e=this._moving;e.counter+=t*1e3;let i=Math.min(e.counter/e.dur,1),s;switch(e.timing){case"linear":s=i;break;case"ease-in":s=p.ease_in(i);break;case"ease-out":s=p.ease_out(i);break}this.position.Copy(e.from.Clone().Lerp(e.to,s)),i==1&&(this._moving=null)}}};var B=class{constructor(){this._position=new M,this.scale=1,this._target=null,this._vel=new a,this._scaling=null,this._shaking=null,this._offset=new a}get position(){return this._position.position}set position(t){this._position.position.Copy(t)}get shaking(){return this._shaking}get scaling(){return this._scaling}get moving(){return this._position._moving}get velocity(){return this._vel}set velocity(t){this._vel.Copy(t)}Clip(t){this._position.Clip(t._position)}Unclip(t){this._position.Unclip(t._position)}MoveTo(t,e,i="linear"){this._position.MoveTo(t,e,i)}StopMoving(){this._position.StopMoving()}Follow(t){this._target=t}Unfollow(){this._target=null}ScaleTo(t,e,i="linear"){this._scaling={counter:0,dur:e,from:this.scale,to:t,timing:i}}StopScaling(){this._scaling=null}MoveAndScaleTo(t,e,i,s="linear"){this.MoveTo(t,i,s),this.ScaleTo(e,i,s)}Shake(t,e,i,s){this._shaking={counter:0,count:i,angle:s,dur:e,range:t}}StopShaking(){this._shaking=null,this._offset=new a}Update(t){if(this.moving)this._position.Update(t);else if(this._target){let e=4*t;this.position.Lerp(this._target.position,e)}else{let e=this._vel.Clone();e.Mult(t),this.position.Add(e)}if(this._scaling){let e=this._scaling;e.counter+=t*1e3;let i=Math.min(e.counter/e.dur,1),s;switch(e.timing){case"linear":s=i;break;case"ease-in":s=p.ease_in(i);break;case"ease-out":s=p.ease_out(i);break}this.scale=p.lerp(s,e.from,e.to),i==1&&this.StopScaling()}if(this._shaking){let e=this._shaking;e.counter+=t*1e3;let i=Math.min(e.counter/e.dur,1);this.position.Sub(this._offset),this._offset.Copy(new a(Math.sin(i*Math.PI*2*e.count)*e.range,0).Rotate(e.angle)),this.position.Add(this._offset),i==1&&this.StopShaking()}}};var f=class{constructor(){this._type="",this._parent=null,this._position=new M}get type(){return this._type}get scene(){return this._parent._scene}get parent(){return this._parent}get position(){return this._position.position}set position(t){this._position.position=t}get offset(){return this._position._offset}set offset(t){this._position._offset.Copy(t)}InitComponent(){}GetComponent(t){return this._parent.GetComponent(t)}FindEntity(t){return this._parent.FindEntity(t)}Update(t){}};var z=class extends f{constructor(t){super();this._capture=t.capture===void 0?!1:t.capture,this._eventHandlers=new Map}AddEventHandler(t,e){this._eventHandlers.has(t)||this._eventHandlers.set(t,[]),this._eventHandlers.get(t).push(e)}RemoveEventHandler(t,e){if(!this._eventHandlers.has(t))return;let i=this._eventHandlers.get(t),s=i.indexOf(e);s>-1&&i.splice(s,1)}_On(t,e){if(!this._eventHandlers.has(t))return;let i=this._eventHandlers.get(t);for(let s of i)s(e)}};var N=class{constructor(){this._position=new M(this.DoWeirdStuff.bind(this)),this._components=new Map,this._parent=null,this._name=null,this._scene=null,this.groupList=new Set}get name(){return this._name}get scene(){return this._scene}get position(){return this._position.position}set position(t){this._position.position=t}get moving(){return this._position._moving}DoWeirdStuff(){this._components.forEach(t=>{t.position.Copy(this.position.Clone().Add(t.offset))})}Update(t){this._position.Update(t),this._components.forEach(e=>{e.Update(t)})}Clip(t,e=!1){this._position.Clip(t._position,e)}Unclip(t){this._position.Unclip(t._position)}MoveTo(t,e,i="linear"){this._position.MoveTo(t,e,i)}StopMoving(){this._position.StopMoving()}AddComponent(t,e){switch(e===void 0&&(e=t.constructor.name),this._components.set(e,t),t._parent=this,t.position.Copy(this.position.Clone().Add(t.offset)),this.Clip(t,!0),t.InitComponent(),t.type){case"drawable":this.scene._AddDrawable(t);break;case"body":this.scene._AddBody(this,t);break;case"light":this._scene._lights.push(t)}}GetComponent(t){return this._components.get(t)}FindEntity(t){return this._parent.Get(t)}};var X={};H(X,{Ball:()=>y,Box:()=>rt,Ray:()=>S,RegularPolygon:()=>ht,World:()=>k});var _=function(){return{ParseValue(n,t){return n!=null&&typeof n==typeof t?n:t},ParseObject(n,t){if(n)for(let e in t)t[e]=typeof t[e]=="object"?this.ParseObject(n[e],t[e]):this.ParseValue(n[e],t[e]);return t}}}();var W=class{constructor(t,e){let[i,s]=e;this._cells=[...Array(s)].map(o=>[...Array(i)].map(r=>null)),this._dimensions=e,this._bounds=t}NewClient(t,e){let i={position:t,dimensions:e,indices:null};return this._InsertClient(i),i}_InsertClient(t){let[e,i]=t.dimensions,[s,o]=t.position,r=this._GetCellIndex([s-e/2,o-i/2]),h=this._GetCellIndex([s+e/2,o+i/2]);t.indices=[r,h];for(let l=r[1];l<=h[1];++l)for(let c=r[0];c<=h[0];++c)this._cells[l][c]||(this._cells[l][c]=new Set),this._cells[l][c].add(t)}_GetCellIndex(t){let e=p.sat((t[0]-this._bounds[0][0])/(this._bounds[1][0]-this._bounds[0][0])),i=p.sat((t[1]-this._bounds[0][1])/(this._bounds[1][1]-this._bounds[0][1])),s=Math.floor(e*(this._dimensions[0]-1)),o=Math.floor(i*(this._dimensions[1]-1));return[s,o]}FindNear(t,e){let[i,s]=e,[o,r]=t,h=this._GetCellIndex([o-i/2,r-s/2]),l=this._GetCellIndex([o+i/2,r+s/2]),c=new Set;for(let u=h[1];u<=l[1];++u)for(let d=h[0];d<=l[0];++d)if(this._cells[u][d])for(let m of this._cells[u][d])c.add(m);return Array.from(c)}UpdateClient(t){this.RemoveClient(t),this._InsertClient(t)}RemoveClient(t){let[e,i]=t.indices;for(let s=e[1];s<=i[1];++s)for(let o=e[0];o<=i[0];++o)this._cells[s][o].delete(t)}Draw(t){let e=this._bounds;t.save(),t.strokeStyle="white",t.beginPath();let i=(e[1][0]-e[0][0])/this._dimensions[0];for(let o=0;o<=this._dimensions[0];++o)t.moveTo(e[0][0]+o*i,e[0][1]),t.lineTo(e[0][0]+o*i,e[1][1]);let s=(e[1][1]-e[0][1])/this._dimensions[1];for(let o=0;o<=this._dimensions[1];++o)t.moveTo(e[0][0],e[0][1]+o*s),t.lineTo(e[1][0],e[0][1]+o*s);t.stroke(),t.restore()}};var D=class{constructor(t,e,i,s,o){this.x=t,this.y=e,this.w=i,this.h=s,this.entity=o}_vsAabb(t){return this.x+this.w/2>=t.x-t.w/2&&this.x-this.w/2<=t.x+t.w/2&&this.y+this.h/2>=t.y-t.h/2&&this.y-this.h/2<=t.y+t.h/2}},v=class{constructor(t,e){this._bounds=t;let i=t[1][0]-t[0][0],s=t[1][1]-t[0][1];this.aabb=new D(t[0][0]+i/2,t[0][1]+s/2,i,s),this.limit=e,this.divided=!1,this.data=[]}_divide(){let t=this._bounds,e=t[1][0]-t[0][0],i=t[1][1]-t[0][1];this.topLeft=new v([[t[0][0],t[0][1]],[t[0][0]+e/2,t[0][1]+i/2]],this.limit),this.topRight=new v([[t[0][0]+e/2,t[0][1]],[t[0][0]+e,t[0][1]+i/2]],this.limit),this.bottomLeft=new v([[t[0][0],t[0][1]+i/2],[t[0][0]+e/2,t[0][1]+i]],this.limit),this.bottomRight=new v([[t[0][0]+e/2,t[0][1]+i/2],[t[0][0]+e,t[0][1]+i]],this.limit);for(let s=0;s<this.data.length;s++)this.topLeft._Insert(this.data[s]),this.topRight._Insert(this.data[s]),this.bottomLeft._Insert(this.data[s]),this.bottomRight._Insert(this.data[s]);this.divided=!0}Clear(){this.data=[],this.divided=!1,this.topRight=null,this.topLeft=null,this.bottomLeft=null,this.bottomRight=null}FindNear(t,e){let[i,s]=e,[o,r]=t,h=new D(o,r,i,s),l=this._Search(h);return l==null?[]:Array.from(l)}_Search(t,e){if(e==null&&(e=new Set),!!t._vsAabb(this.aabb)){if(this.divided)this.topLeft._Search(t,e),this.topRight._Search(t,e),this.bottomLeft._Search(t,e),this.bottomRight._Search(t,e);else for(let i=0;i<this.data.length;i++)t._vsAabb(this.data[i])&&e.add(this.data[i]);return e}}NewClient(t,e){let i=new D(t[0],t[1],e[0],e[1]);return this._Insert(i),i}_Insert(t,e=0){let i=5;if(!this.aabb._vsAabb(t))return!1;if(this.data.length<this.limit||e>i)return this.data.push(t),!0;this.divided||this._divide(),this.topLeft._Insert(t,e+1),this.topRight._Insert(t,e+1),this.bottomLeft._Insert(t,e+1),this.bottomRight._Insert(t,e+1)}UpdateClient(t){this._Insert(t)}Draw(t){t.beginPath(),t.strokeStyle="white",t.strokeRect(this.aabb.x-this.aabb.w/2,this.aabb.y-this.aabb.h/2,this.aabb.w,this.aabb.h),this.divided&&(this.topLeft.Draw(t),this.topRight.Draw(t),this.bottomLeft.Draw(t),this.bottomRight.Draw(t))}};var T=class extends f{constructor(t){super();this._params=t,this._width=this._params.width,this._height=this._params.height,this._quadtree=this._params.quadtree}InitComponent(){let t=[this._parent.body.position.x,this._parent.body.position.y];this._client=this._quadtree.NewClient(t,[this._width,this._height]),this._client.entity=this._parent}FindNearby(t,e){return this._quadtree.FindNear([this._parent.position.x,this._parent.position.y],[t,e]).filter(s=>s.entity!=this._parent).map(s=>s.entity)}UpdateClient(){let t=[this._parent.body.position.x,this._parent.body.position.y];this._client.x=t[0],this._client.y=t[1],this._quadtree.UpdateClient(this._client)}};var k=class{constructor(t={}){this._relaxationCount=_.ParseValue(t.relaxationCount,5),this._bounds=_.ParseValue(t.bounds,[[-1e3,-1e3],[1e3,1e3]]),this._cellDimensions=_.ParseObject(t.cellDimensions,{width:100,height:100}),this._limit=_.ParseValue(t.limit,10),this._bodies=[],this._joints=[];let e=Math.floor((this._bounds[1][0]-this._bounds[0][0])/this._cellDimensions.width),i=Math.floor((this._bounds[1][1]-this._bounds[0][1])/this._cellDimensions.height);this._spatialGrid=new W(this._bounds,[e,i]),this._quadtree=new v(this._bounds,this._limit)}_AddJoint(t){this._joints.push(t)}_AddBody(t,e){t.body=e;let i=e.boundingRect,s=new T({quadtree:this._quadtree,width:i.width,height:i.height});t.AddComponent(s),this._bodies.push(e)}_RemoveBody(t,e){let i=this._bodies.indexOf(e);i!=-1&&this._bodies.splice(i,1)}Update(t){for(let e of this._bodies)e._collisions.left.clear(),e._collisions.right.clear(),e._collisions.top.clear(),e._collisions.bottom.clear(),e._collisions.other.clear();for(let e of this._bodies)e.UpdatePosition(t);for(let e of this._joints)e.Update(t);for(let e=0;e<this._relaxationCount;++e)for(let i of this._bodies)i.HandleBehavior();this._quadtree.Clear();for(let e of this._bodies)e.GetComponent("QuadtreeController").UpdateClient()}},V=class extends f{constructor(t){super();this._type="body",this._vel=new a,this._angVel=0,this.mass=_.ParseValue(t.mass,0),this.bounce=_.ParseValue(t.bounce,0),this.angle=0,this.rotating=_.ParseValue(t.rotating,1),this.friction=_.ParseObject(t.friction,{x:0,y:0,angular:0,collide:.3}),this._behavior=[],this._collisions={left:new Set,right:new Set,top:new Set,bottom:new Set,other:new Set}}get velocity(){return this._vel}set velocity(t){this._vel.Copy(t)}get angularVelocity(){return this._angVel}set angularVelocity(t){this._angVel=t}get inverseMass(){return this.mass===0?0:1/this.mass}get inertia(){return 0}get boundingRect(){return{width:0,height:0}}get collisions(){return this._collisions}Draw(t){let e=this.boundingRect;t.beginPath(),t.strokeStyle="lime",t.strokeRect(-e.width/2,-e.height/2,e.width,e.height)}AddBehavior(t,e,i,s){this._behavior.push({groups:t.split(" "),type:e,action:i,elseAction:s})}UpdatePosition(t){let e=60,i=new a(this._vel.x*this.friction.x*e,this._vel.y*this.friction.y*e);this._vel.Sub(i.Mult(t));let s=this._vel.Clone().Mult(t);this.position.Add(s),this._angVel-=this._angVel*this.friction.angular*e*t,this.angle+=this._angVel*t}HandleBehavior(){let t=this.GetComponent("QuadtreeController"),e=this.boundingRect;for(let i of this._behavior){let o=t.FindNearby(e.width,e.height).filter(r=>i.groups.map(h=>r.groupList.has(h)).some(h=>h));o.sort((r,h)=>{let l=r.body.boundingRect,c=h.body.boundingRect,u=a.Dist(this.position,r.body.position)/new a(e.width+l.width,e.height+l.height).Mag(),d=a.Dist(this.position,h.body.position)/new a(e.width+c.width,e.height+c.height).Mag();return u-d});for(let r of o){let h;switch(i.type){case"detect":h=at(this,r.body),h.collide?i.action&&i.action(r.body,h.point):i.elseAction&&i.elseAction();break;case"resolve":h=It(this,r.body),h.collide&&i.action&&i.action(r.body,h.point);break}}}}Join(t,e,i){let s;switch(e){case"spring":s=new _t(this,t,i);break;case"stick":s=new ut(this,t,i);break}if(!s)return;this.scene._world._AddJoint(s)}Contains(t){return!1}ApplyForce(t,e){let i=this.position.Clone().Sub(e),s=t.Clone().Mult(1/this.inverseMass);this.velocity.Add(s),this.angularVelocity+=a.Cross(i,s.Clone().Mult(1/this.inertia))}},g=class extends V{constructor(t){super(t);this._points=t.points}GetVertices(){return this._points.map(t=>new a(t[0],t[1]))}GetComputedVertices(){let t=this.GetVertices();for(let e=0;e<t.length;++e){let i=t[e];i.Rotate(this.angle),i.Add(this.position)}return t}get boundingRect(){let t=this.GetVertices(),e=0,i=0;for(let o=0;o<t.length;++o){let h=t[o].Mag();h>e&&(e=h,i=o)}let s=e*2;return{width:s,height:s}}static GetFaceNormals(t){let e=[];for(let i=0;i<t.length;i++){let s=t[i].Clone(),o=t[(i+1)%t.length].Clone();e[i]=o.Clone().Sub(s).Norm().Unit()}return e}static FindSupportPoint(t,e,i){let s=-1/0,o=-1;for(let r=0;r<t.length;r++){let h=t[r].Clone().Sub(i),l=a.Dot(h,e);l>0&&l>s&&(s=l,o=r)}return{sp:t[o],depth:s}}Contains(t){let e=this.GetComputedVertices(),i=e.length,s=0;for(let o=0;o<i;++o){let r=e[o],h=e[(o+1)%i];(t.y-r.y)*(t.y-h.y)<=0&&(t.x<=r.x||t.x<=h.x)&&(r.x>=t.x&&h.x>=t.x||(h.x-r.x)*(t.y-r.y)/(h.y-r.y)>=t.x-r.x)&&++s}return s%2}},rt=class extends g{constructor(t){super(t);this._width=t.width,this._height=t.height,this._points=[[-this._width/2,-this._height/2],[this._width/2,-this._height/2],[this._width/2,this._height/2],[-this._width/2,this._height/2]]}get width(){return this._width}get height(){return this._height}get inertia(){return(this.width**2+this.height**2)/1/this.rotating}},y=class extends V{constructor(t){super(t);this._radius=t.radius}get radius(){return this._radius}get boundingRect(){return{width:2*this.radius,height:2*this.radius}}get inertia(){return Math.PI*this.radius**2/1/this.rotating}FindSupportPoint(t,e){let i=[];i[0]=this.position.Clone().Add(t.Clone().Mult(this.radius)),i[1]=this.position.Clone().Add(t.Clone().Mult(-this.radius));let s=-1/0,o=-1;for(let r=0;r<i.length;r++){let h=i[r].Clone().Sub(e),l=a.Dot(h,t);l>0&&l>s&&(s=l,o=r)}return{sp:i[o],depth:s,n:t}}FindNearestVertex(t){let e=1/0,i=0;for(let s=0;s<t.length;s++){let o=a.Dist(t[s],this.position);o<e&&(e=o,i=s)}return t[i]}Contains(t){return a.Dist(t,this.position)<=this.radius}},ht=class extends g{constructor(t){super(t);this._radius=t.radius,this._sides=t.sides;let e=[];for(let i=0;i<this._sides;++i){let s=Math.PI*2/this._sides*i;e.push([Math.cos(s)*this._radius,Math.sin(s)*this._radius])}this._points=e}get radius(){return this._radius}get boundingRect(){return{width:2*this.radius,height:2*this.radius}}get inertia(){return Math.PI*this.radius**2/1/this.rotating}},S=class extends V{constructor(t){super(t);this._range=t.range}get range(){return this._range}set range(t){this._range=t}get boundingRect(){return{width:2*this.range,height:2*this.range}}get point(){return this.position.Clone().Add(new a(this.range,0).Rotate(this.angle))}},at=(n,t)=>n instanceof y&&t instanceof y?Vt(n,t):n instanceof g&&t instanceof g?jt(n,t):n instanceof y&&t instanceof g?dt(n,t):n instanceof g&&t instanceof y?dt(t,n):n instanceof S&&t instanceof g?lt(n,t):n instanceof g&&t instanceof S?lt(t,n):n instanceof S&&t instanceof y?ct(n,t):n instanceof y&&t instanceof S?ct(t,n):{collide:!1},kt=(n,t,e,i)=>{let s=t.Clone().Sub(n),o=i.Clone().Sub(e),r=s.x*o.y-s.y*o.x,h=((e.x-n.x)*s.y-(e.y-n.y)*s.x)/r,l=((e.x-n.x)*o.y-(e.y-n.y)*o.x)/r;return 0<=h&&h<=1&&0<=l&&l<=1?{collide:!0,point:n.Clone().Add(s.Clone().Mult(l))}:{collide:!1}},lt=(n,t)=>{let e=1/0,i=null,s=t.GetComputedVertices();for(let o=0;o<s.length;++o){let r=s[o],h=s[(o+1)%s.length],l=kt(n.position,n.point,r,h);if(l.collide){let c=a.Dist(n.position,l.point);c<e&&(e=c,i=l.point)}}return i!=null?(n._collisions.other.add(t),{collide:!0,point:i}):{collide:!1}},ct=(n,t)=>{let e=n.point.Clone().Sub(n.position).Unit(),i=t.position.Clone().Sub(n.position),s=t.radius**2,o=i.Mag()**2,r=a.Dot(i,e),h=o-r*r;if(s-h<0)return{collide:!1};let l=Math.sqrt(s-h),c;o<s?c=r+l:c=r-l;let u=n.position.Clone().Add(e.Clone().Mult(c));return a.Dot(u.Clone().Sub(n.position),n.point.Clone().Sub(n.position))<0||a.Dist(u,n.position)>n.range?{collide:!1}:{collide:!0,point:u}},Vt=(n,t)=>{let e=n.position.Clone().Sub(t.position),i={};return e.Mag()<n.radius+t.radius?(i.normal=e.Clone().Unit(),i.depth=n.radius+t.radius-e.Mag(),i.point=n.position.Clone().Add(i.normal.Clone().Mult(n.radius)),i.collide=!0,i):{collide:!1}},jt=(n,t)=>{let e=n.GetComputedVertices(),i=t.GetComputedVertices(),s=g.GetFaceNormals(e),o=g.GetFaceNormals(i),r=[];for(let d=0;d<s.length;d++){let m=g.FindSupportPoint(i,s[d].Clone().Mult(-1),e[d]);if(m.n=s[d].Clone(),r[d]=m,m.sp==null)return{collide:!1}}let h=[];for(let d=0;d<o.length;d++){let m=g.FindSupportPoint(e,o[d].Clone().Mult(-1),i[d]);if(m.n=o[d].Clone(),h[d]=m,m.sp==null)return{collide:!1}}r=r.concat(h);let l=1/0,c=0;for(let d=0;d<r.length;d++)r[d].depth<l&&(l=r[d].depth,c=d);let u=t.position.Clone().Sub(n.position);return a.Dot(u,r[c].n)>0&&r[c].n.Mult(-1),{collide:!0,normal:r[c].n,depth:r[c].depth,point:r[c].sp}},dt=(n,t)=>{let e=t.GetComputedVertices(),i=g.GetFaceNormals(e),s=[];for(let d=0;d<i.length;d++){let m=n.FindSupportPoint(i[d].Clone().Mult(-1),e[d].Clone());if(m.sp==null)return{collide:!1};s[d]=m}let r=n.FindNearestVertex(e).Clone().Sub(n.position).Unit(),h=g.FindSupportPoint(e,r.Clone(),n.position.Clone());if(h.sp==null)return{collide:!1};h.n=r.Clone(),s.push(h);let l=1/0,c=null;for(let d=0;d<s.length;d++)s[d].depth<l&&(l=s[d].depth,c=d);let u=t.position.Clone().Sub(n.position);return a.Dot(u,s[c].n)<0&&s[c].n.Mult(-1),{collide:!0,normal:s[c].n,point:s[c].sp,depth:s[c].depth}},It=(n,t)=>{n instanceof y&&t instanceof g&&([n,t]=[t,n]);let e=at(n,t);if(e.collide){let i={collide:!0,point:e.point};if(n.mass===0&&t.mass===0)return i;let s=e.normal.Clone().Mult(e.depth/(n.inverseMass+t.inverseMass));n.position.Add(s.Clone().Mult(n.inverseMass)),t.position.Sub(s.Clone().Mult(t.inverseMass));let o=e.point.Clone().Sub(n.position),r=e.point.Clone().Sub(t.position),h=n.angularVelocity,l=t.angularVelocity,c=n._vel,u=t._vel,d=c.Clone().Add(new a(-h*o.y,h*o.x)),m=u.Clone().Add(new a(-l*r.y,l*r.x)),E=d.Clone().Sub(m),K=Math.max(n.bounce,t.bounce);if(a.Dot(E,e.normal)>0)return i;let At=-(1+K)*a.Dot(E,e.normal)/(n.inverseMass+t.inverseMass+Math.pow(a.Cross(o,e.normal),2)/n.inertia+Math.pow(a.Cross(r,e.normal),2)/t.inertia),Z=e.normal.Clone().Mult(At),tt=Z.Clone().Mult(n.inverseMass),et=Z.Clone().Mult(t.inverseMass);n._vel.Add(tt.Clone().Mult(1)),t._vel.Sub(et.Clone().Mult(1)),n.angularVelocity+=a.Cross(o,tt.Clone().Mult(1/n.inertia)),t.angularVelocity-=a.Cross(r,et.Clone().Mult(1/n.inertia));let Pt=Math.max(n.friction.collide,t.friction.collide),A=e.normal.Clone().Norm(),Rt=-(1+K)*a.Dot(E,A)*Pt/(n.inverseMass+t.inverseMass+Math.pow(a.Cross(o,A),2)/n.inertia+Math.pow(a.Cross(r,A),2)/t.inertia),it=A.Clone().Mult(Rt),st=it.Clone().Mult(n.inverseMass),nt=it.Clone().Mult(t.inverseMass);n._vel.Add(st.Clone()),t._vel.Sub(nt.Clone()),n.angularVelocity+=a.Cross(o,st.Clone().Mult(1/n.inertia)),t.angularVelocity-=a.Cross(r,nt.Clone().Mult(1/t.inertia));let P={left:new a(-1,0),right:new a(1,0),top:new a(0,-1),bottom:new a(0,1)};return a.Dot(e.normal,P.left)>=Math.SQRT2/2?(n._collisions.right.add(t),t._collisions.left.add(n)):a.Dot(e.normal,P.right)>=Math.SQRT2/2?(n._collisions.left.add(t),t._collisions.right.add(n)):a.Dot(e.normal,P.top)>=Math.SQRT2/2?(n._collisions.bottom.add(t),t._collisions.top.add(n)):a.Dot(e.normal,P.bottom)>=Math.SQRT2/2&&(n._collisions.top.add(t),t._collisions.bottom.add(n)),i}return{collide:!1}},q=class{constructor(t,e,i){this._body1=t,this._body2=e;let s=_.ParseObject(i.offset1,{x:0,y:0});this._offset1=new a(s.x,s.y);let o=_.ParseObject(i.offset2,{x:0,y:0});this._offset2=new a(o.x,o.y);let r=this._body1.position.Clone().Add(this._offset1.Clone().Rotate(this._body1.angle)),h=this._body2.position.Clone().Add(this._offset2.Clone().Rotate(this._body2.angle));this._length=_.ParseValue(i.length,a.Dist(r,h))}Update(t){}},_t=class extends q{constructor(t,e,i){super(t,e,i);this._stiffness=_.ParseValue(i.stiffness,0)*10}Update(){let t=this._offset1.Clone().Rotate(this._body1.angle),e=this._offset2.Clone().Rotate(this._body2.angle),i=this._body1.position.Clone().Add(t),s=this._body2.position.Clone().Add(e),o=i.Clone().Sub(s),r=o.Clone().Unit(),h=o.Mag(),l=r.Clone().Mult((h-this._length)*-this._stiffness/(this._body1.inverseMass+this._body2.inverseMass)),c=l.Clone().Mult(this._body1.inverseMass);this._body1.velocity.Add(c.Clone().Mult(1)),this._body1.angularVelocity+=a.Cross(t,c.Clone().Mult(1/this._body1.inertia));let u=l.Clone().Mult(this._body2.inverseMass);this._body2.velocity.Sub(u.Clone().Mult(1)),this._body2.angularVelocity-=a.Cross(e,u.Clone().Mult(1/this._body2.inertia))}},ut=class extends q{constructor(t,e,i){super(t,e,i)}Update(){let t=this._offset1.Clone().Rotate(this._body1.angle),e=this._offset2.Clone().Rotate(this._body2.angle),i=this._body1.position.Clone().Add(t),s=this._body2.position.Clone().Add(e),o=i.Clone().Sub(s),r=o.Clone().Unit(),h=o.Mag(),l=r.Clone().Mult((h-this._length)*-this._stiffness/(this._body1.inverseMass+this._body2.inverseMass))}};var $={};H($,{AmbientLight:()=>j,RadialLight:()=>pt});var j=class{constructor(t){this.color=_.ParseValue(t.color,"white")}Draw(t){t.beginPath(),t.fillStyle=C.ParseStyle(t,this.color),t.fillRect(0,0,t.canvas.width,t.canvas.height)}},pt=class extends f{constructor(t){super();this._type="light",this.color=_.ParseValue(t.color,"white"),this.radius=_.ParseValue(t.radius,100),this.angle=0,this.angleRange=_.ParseValue(t.angleRange,Math.PI*2)}Draw(t){t.beginPath(),t.save(),t.translate(this.position.x,this.position.y),t.rotate(this.angle),t.fillStyle=C.ParseStyle(t,this.color),t.arc(0,0,this.radius,-this.angleRange/2,this.angleRange/2),t.lineTo(0,0),t.closePath(),t.fill(),t.restore()}};var J=class{constructor(t){this.background=t.background,this._world=new k(t.physics),this.paused=!0,this.speed=1,this.timeout=new b,this._lights=[],this._ambientLight=new j({color:t.light||"white"}),this._drawable=[],this._interactiveEntities=[],this._eventHandlers=new Map,this._entityManager=new O,this._camera=new B}get camera(){return this._camera}set light(t){this._ambientLight.color=t}CreateEntity(t){let e=new N;return this.AddEntity(e,t),e}AddEventHandler(t,e){this._eventHandlers.has(t)||this._eventHandlers.set(t,[]),this._eventHandlers.get(t).push(e)}RemoveEventHandler(t,e){if(!this._eventHandlers.has(t))return;let i=this._eventHandlers.get(t),s=i.indexOf(e);s>-1&&i.splice(s,1)}SetInteractive(t,e={}){this._interactiveEntities.push(t);let i=new z(e);t.AddComponent(i),t.interactive=i}_On(t,e){if(this._eventHandlers.has(t)){let i=this._eventHandlers.get(t);for(let s of i)s(e)}if(t=="mousedown"){let i=this._world._quadtree.FindNear([e.x,e.y],[0,0]).map(s=>s.entity);for(let s of i)if(!!s.interactive&&s.body.Contains(new a(e.x,e.y))&&(s.interactive._On(t,e),s.interactive._id=e.id,s.interactive._capture))break}else if(t=="mousemove"||t=="mouseup")for(let i of this._interactiveEntities)i.interactive._id==e.id&&(i.interactive._On(t,e),t=="mouseup"&&(i.interactive._id=-1))}GetEntityByName(t){return this._entityManager.Get(t)}GetEntitiesByGroup(t){return this._entityManager.Filter(e=>e.groupList.has(t))}AddEntity(t,e){t._scene=this,this._entityManager.Add(t,e)}RemoveEntity(t){this._entityManager.Remove(t),t._components.forEach(e=>{if(e._type=="drawable")this._RemoveDrawable(e);else if(e._type=="body")this._RemoveBody(t,e);else if(e._type=="light"){let i=this._lights.indexOf(e);this._lights.splice(i,1)}})}_AddDrawable(t){this._drawable.push(t);for(let e=this._drawable.length-1;e>0&&!(t._zIndex>=this._drawable[e-1]._zIndex);--e)[this._drawable[e],this._drawable[e-1]]=[this._drawable[e-1],this._drawable[e]]}_RemoveDrawable(t){let e=this._drawable.indexOf(t);e!=-1&&this._drawable.splice(e,1)}_AddBody(t,e){this._world._AddBody(t,e)}_RemoveBody(t,e){this._world._RemoveBody(t,e)}_PhysicsUpdate(t){for(let e of this._bodies)e._collisions.left.clear(),e._collisions.right.clear(),e._collisions.top.clear(),e._collisions.bottom.clear();for(let e of this._bodies)e.UpdatePosition(t);for(let e=0;e<this._relaxationCount;++e)for(let i of this._bodies)i.HandleBehavior()}Update(t){this.paused||(this.timeout.Update(t*1e3),t*=this.speed,this._entityManager.Update(t),this._world.Update(t),this._camera.Update(t))}Play(){this.paused=!1}Pause(){this.paused=!0}};var x=class{constructor(){this._toLoad=[],this._size=0,this._counter=0,this._path=""}_Add(t,e,i){this._toLoad.push({name:t,path:this._path+e,type:i}),++this._size}AddImage(t,e){return this._Add(t,e,"image"),this}AddAudio(t,e){return this._Add(t,e,"audio"),this}AddJSON(t,e){return this._Add(t,e,"json"),this}AddFont(t,e){return this._Add(t,e,"font"),this}_HandleCallback(t,e,i,s){t.set(e.name,i),++this._counter,this._HandleOnProgress(e),this._counter===this._size&&(this._counter=this._size=0,this._toLoad=[],s(t))}_OnProgressHandler(t,e){}OnProgress(t){return this._OnProgressHandler=t,this}SetPath(t){return this._path=t,this}_HandleOnProgress(t){let e=this._counter/this._size;this._OnProgressHandler(e,t)}Load(t){let e=new Map;if(this._size===0){t(e);return}for(let i of this._toLoad)switch(i.type){case"image":x.LoadImage(i.path,s=>{this._HandleCallback(e,i,s,t)});break;case"audio":x.LoadAudio(i.path,s=>{this._HandleCallback(e,i,s,t)});break;case"json":x.LoadJSON(i.path,s=>{this._HandleCallback(e,i,s,t)});break;case"font":x.LoadFont(i.name,i.path,s=>{this._HandleCallback(e,i,s,t)})}}static LoadImage(t,e){let i=new Image;i.src=t,i.addEventListener("load",()=>{e(i)},{once:!0})}static LoadAudio(t,e){let i=new Audio(t);i.load(),i.addEventListener("canplaythrough",()=>{e(i)},{once:!0})}static LoadJSON(t,e){fetch(t).then(i=>i.json()).then(i=>e(i))}static LoadFont(t,e,i){new FontFace(t,`url(${e})`).load().then(o=>{document.fonts.add(o),i(t)})}};var Y=class{constructor(t){this._width=t.width,this._height=t.height,this._preload=t.preload==null?null:t.preload.bind(this),this._init=t.init.bind(this),this._resources=null,this._loader=new x,this._renderer=new L({width:this._width,height:this._height}),this._engine=new U,this._sceneManager=new G,this.timeout=this._engine.timeout,this.audio=(()=>{let i=new Map,s=l=>{i.set(l,new F)};s("music"),s("effects");let o=(l,c,u=!1)=>{i.get(l).AddAudio(c,this._resources.get(c),u)};return{get music(){return i.get("music")},get effects(){return i.get("effects")},AddMusic:(l,c=!1)=>{o("music",l,c)},AddEffect:(l,c=!1)=>{o("effects",l,c)}}})();let e=i=>{let s=this._sceneManager.currentScene;s&&s.Update(i*.001),this._renderer.Render(s)};this._engine._step=e,this._InitSceneEvents(),this._engine.Start(),this._preload?(this._preload(),this._loader.Load(i=>{this._resources=i,this._init()})):(this._resources=new Map,this._init())}get loader(){return this._loader}get resources(){return this._resources}_InitSceneEvents(){let t="ontouchstart"in document,e=this._renderer._canvas;t?(e.addEventListener("touchstart",i=>this._HandleTouchEvent(i)),e.addEventListener("touchmove",i=>this._HandleTouchEvent(i)),e.addEventListener("touchend",i=>this._HandleTouchEvent(i))):(e.addEventListener("mousedown",i=>this._HandleMouseEvent(i)),e.addEventListener("mousemove",i=>this._HandleMouseEvent(i)),e.addEventListener("mouseup",i=>this._HandleMouseEvent(i)))}_HandleTouchEvent(t){let e={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"};this._HandleSceneEvent(e[t.type],t.changedTouches[0].pageX,t.changedTouches[0].pageY)}_HandleMouseEvent(t){this._HandleSceneEvent(t.type,t.pageX,t.pageY)}_HandleSceneEvent(t,e,i){let s=this._sceneManager.currentScene;if(s){let o=this._renderer.DisplayToSceneCoords(s,e,i);s._On(t,{x:o.x,y:o.y,id:0,type:t})}}CreateSection(t){let e=document.createElement("div");return e.id=t,e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.display="none",this._renderer._container.appendChild(e),e}GetSection(t){return document.getElementById(t)}ShowSection(t){this.GetSection(t).style.display="block"}HideSection(t){this.GetSection(t).style.display="none"}CreateScene(t,e={}){let i=new J(e);return this._sceneManager.Add(i,t),i}PlayScene(t){return this._sceneManager.Play(t)}PauseScene(){let t=this._sceneManager.currentScene;t&&(t.paused?t.Play():t.Pause())}};var Q={};H(Q,{Circle:()=>yt,Drawable:()=>w,Line:()=>vt,Picture:()=>gt,Polygon:()=>wt,Rect:()=>mt,Sprite:()=>Ct,Text:()=>ft});var w=class extends f{constructor(t={}){super();this._type="drawable",this._params=t,this._width=this._params.width||0,this._height=this._params.height||0,this._vertices=[],this._zIndex=this._params.zIndex||0,this.flip={x:this._params.flipX||!1,y:this._params.flipY||!1},this._scale=t.scale||1,this._rotationCount=this._params.rotationCount||0,this.opacity=this._params.opacity!==void 0?this._params.opacity:1,this.filter=this._params.filter||"",this._angle=this._params.angle||this._rotationCount*Math.PI/2||0,this.fillStyle=this._params.fillStyle||"black",this.strokeStyle=this._params.strokeStyle||"black",this.strokeWidth=this._params.strokeWidth||0,this.mode=this._params.mode||"source-over",this._offset=new a,this._shaking=null}get zIndex(){return this._zIndex}set zIndex(t){this._zIndex=t,this.scene&&(this.scene._RemoveDrawable(this),this.scene._AddDrawable(this))}get width(){return this._width}get height(){return this._height}set width(t){this._width=t,this._ComputeVertices()}set height(t){this._height=t,this._ComputeVertices()}set angle(t){this._angle=t}get angle(){return this._angle}get rotationCount(){return this._rotationCount}set rotationCount(t){this._rotationCount=t,this.angle=this._rotationCount*Math.PI/2}get scale(){return this._scale}set scale(t){this._scale=t}get boundingBox(){let t=this._vertices,e=0,i=0;for(let o=0;o<t.length;++o){let h=t[o].Mag();h>e&&(e=h,i=o)}let s=e*2;return{width:s,height:s,x:this.position.x,y:this.position.y}}get position0(){return this.position}Shake(t,e,i,s){this._shaking={counter:0,count:i,angle:s,dur:e,range:t}}StopShaking(){this._shaking=null,this._offset=new a}InitComponent(){this._ComputeVertices()}GetVertices(){return[new a(-this._width/2,-this._height/2),new a(this._width/2,-this._height/2),new a(-this._width/2,this._height/2),new a(this._width/2,this._height/2)]}_ComputeVertices(){this._vertices=this.GetVertices();for(let t=0;t<this._vertices.length;++t){let e=this._vertices[t];e.x*=this.flip.x?-this.scale:this.scale,e.y*=this.flip.y?-this.scale:this.scale,e.Rotate(this.angle)}}SetSize(t,e){this._width=t,this._height=e}Draw(t){}Draw0(t){t.save(),t.translate(-this._offset.x,-this._offset.y),t.save(),t.globalAlpha=this.opacity,t.translate(this.position0.x,this.position0.y),t.scale(this.flip.x?-this.scale:this.scale,this.flip.y?-this.scale:this.scale),t.rotate(this.angle),t.fillStyle=C.ParseStyle(t,this.fillStyle),t.strokeStyle=C.ParseStyle(t,this.strokeStyle),t.lineWidth=this.strokeWidth,this.Draw(t),t.restore(),t.restore();let e=this.boundingBox;t.beginPath(),t.strokeStyle="orange",t.strokeRect(e.x-e.width/2,e.y-e.height/2,e.width,e.height)}Update(t){if(this._shaking){let e=this._shaking;e.counter+=t*1e3;let i=Math.min(e.counter/e.dur,1);this._offset.Copy(new a(Math.sin(i*Math.PI*2*e.count)*e.range,0).Rotate(e.angle)),i==1&&this.StopShaking()}}},ft=class extends w{constructor(t){super(t);this._text=this._params.text,this._lines=this._text.split(/\n/),this._padding=this._params.padding||0,this._align=t.align||"center",this._fontSize=this._params.fontSize||16,this._fontFamily=this._params.fontFamily||"Arial",this._fontStyle=this._params.fontStyle||"normal",this._ComputeDimensions()}get linesCount(){return this._lines.length}get lineHeight(){return this._fontSize+this._padding*2}get text(){return this._text}set text(t){this._text=t,this._ComputeDimensions()}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this._ComputeDimensions()}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily=t,this._ComputeDimensions()}get padding(){return this._padding}set padding(t){this._padding=t,this._ComputeDimensions()}get align(){return this._align}set align(t){this._align=t,this._ComputeDimensions()}_ComputeDimensions(){this._height=this.lineHeight*this.linesCount;let t=0,e=document.createElement("canvas").getContext("2d");e.font=`${this._fontStyle} ${this._fontSize}px '${this._fontFamily}'`;for(let i of this._lines){let s=e.measureText(i).width;s>t&&(t=s)}this._width=t+this._padding*2}Draw(t){let e=this._align=="left"?-this._width/2:this._align=="right"?this._width/2:0;t.font=`${this._fontStyle} ${this._fontSize}px '${this._fontFamily}'`,t.textAlign=this._align,t.textBaseline="middle",t.beginPath();for(let i=0;i<this.linesCount;++i)t.fillText(this._lines[i],e+this._padding,this.lineHeight*i-(this.linesCount-1)/2*this.lineHeight)}},gt=class extends w{constructor(t){super(t);this._image=this._params.image,this._frameWidth=this._params.frameWidth||this._image.width,this._frameHeight=this._params.frameHeight||this._image.height,this._framePos={x:this._params.posX||0,y:this._params.posY||0}}Draw(t){t.drawImage(this._image,this._framePos.x*this._frameWidth,this._framePos.y*this._frameHeight,this._frameWidth,this._frameHeight,-this._width/2,-this._height/2,this._width,this._height)}},mt=class extends w{constructor(t){super(t)}Draw(t){t.beginPath(),t.rect(-this._width/2,-this._height/2,this._width,this._height),t.fill(),this.strokeWidth>0&&t.stroke()}},yt=class extends w{constructor(t){super(t);this._radius=this._params.radius}get radius(){return this._radius}get boundingBox(){return{width:this._radius*2,height:this._radius*2,x:this.position.x,y:this.position.y}}set radius(t){this._radius=t}Draw(t){t.beginPath(),t.arc(0,0,this._radius,0,2*Math.PI),t.fill(),this.strokeWidth>0&&t.stroke(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.radius,0),t.stroke()}},wt=class extends w{constructor(t){super(t);this._points=this._params.points}GetVertices(){return this._points.map(t=>new a(t[0],t[1]))}Draw(t){t.beginPath();for(let e=0;e<this._vertices.length;++e){let i=this._vertices[e];e==0?t.moveTo(i.x,i.y):t.lineTo(i.x,i.y)}t.closePath(),t.fill(),this.strokeWidth>0&&t.stroke()}},Ct=class extends w{constructor(t){super(t);this._anims=new Map,this._currentAnim=null,this._paused=!0,this._framePos={x:0,y:0}}AddAnim(t,e){this._anims.set(t,e)}PlayAnim(t,e,i,s){if(this.currentAnim==t)return;this._paused=!1;let o={name:t,rate:e,repeat:i,OnEnd:s,frame:0,counter:0};this._currentAnim=o,this._framePos=this._anims[o.name][o.frame]}Reset(){this._currentAnim&&(this._currentAnim.frame=0,this._currentAnim.counter=0)}Pause(){this._paused=!0}Resume(){this._currentAnim&&(this._paused=!1)}Update(t){if(super.Update(t),this._paused)return;let e=this._currentAnim,i=this._anims.get(e.name);e.counter+=t*1e3,e.counter>=e.rate&&(e.counter=0,++e.frame,e.frame>=i.length&&(e.frame=0,e.OnEnd&&e.OnEnd(),e.repeat||(this._currentAnim=null,this._paused=!0)),this._framePos=i[e.frame])}get currentAnim(){return this._currentAnim?this._currentAnim.name:null}Draw(t){t.drawImage(this._params.image,this._framePos.x*this._params.frameWidth,this._framePos.y*this._params.frameHeight,this._params.frameWidth,this._params.frameHeight,-this._width/2,-this._height/2,this._width,this._height)}},vt=class extends w{constructor(t){super(t);this.range=t.range}get boundingBox(){return{width:this.range*2,height:this.range*2,x:this.position.x,y:this.position.y}}Draw(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.range,0),t.stroke()}};var xt=class extends f{constructor(t){super();this._particles=[],this._options={lifetime:_.ParseObject(t.lifetime,{min:1e3,max:1e3}),friction:_.ParseValue(t.friction,0),angleVariance:_.ParseValue(t.angleVariance,0),angle:_.ParseObject(t.angle,{min:0,max:0}),speed:_.ParseObject(t.speed,{min:0,max:0}),acceleration:t.acceleration||new a,scale:_.ParseObject(t.scale,{from:1,to:0}),opacity:_.ParseObject(t.opacity,{from:1,to:0}),rotationSpeed:_.ParseValue(t.rotationSpeed,0)},this._emitting=null}_CreateParticle(){let t=this.scene.CreateEntity();t.groupList.add("particle"),t.position.Copy(this.position);let e=p.choice(this._particles);t.AddComponent(new e[0](e[1]),"Sprite"),t.AddComponent(new Mt(this._options))}AddParticle(t,e){this._particles.push([t,e])}Emit(t,e=!1,i=0){if(e)this._emitting={count:t,counter:i,delay:i};else for(let s=0;s<t;++s)this._CreateParticle()}Update(t){if(this._emitting){let e=this._emitting;e.counter+=t*1e3,e.counter>=e.delay&&(e.counter=0,this.Emit(e.count))}}},Mt=class extends f{constructor(t){super();this._friction=t.friction||0,this._lifetime=this._InitMinMax(t.lifetime),this._angleVariance=t.angleVariance||0,this._acc=t.acceleration||new a,this._counter=0,this._scale=this._InitRange(t.scale),this._opacity=this._InitRange(t.opacity),this._vel=new a(this._InitMinMax(t.speed),0).Rotate(this._InitMinMax(t.angle)),this._rotationSpeed=t.rotationSpeed||0}_InitMinMax(t){return p.rand(t.min,t.max)}_InitRange(t){return t?{from:t.from==null?1:t.from,to:t.to}:null}Update(t){if(this._counter+=t*1e3,this._counter>=this._lifetime){this.scene.RemoveEntity(this.parent);return}this._vel.Add(this._acc.Mult(t));let e=60,i=new a(this._vel.x*e*this._friction,this._vel.y*e*this._friction);this._vel.Sub(i.Mult(t)),this._vel.Rotate(p.rand(-this._angleVariance,this._angleVariance)*t),this.position.Add(this._vel.Clone().Mult(t));let s=this.GetComponent("Sprite"),o=Math.min(this._counter/this._lifetime,1);this._scale&&(s.scale=p.lerp(o,this._scale.from,this._scale.to)),this._opacity&&(s.opacity=p.lerp(o,this._opacity.from,this._opacity.to)),this._rotationSpeed-=this._rotationSpeed*e*this._friction,s.angle+=this._rotationSpeed*t}},St={Emitter:xt};var bt="Lancelot",I={Vector:a,Game:Y,Component:f,particle:St,drawable:Q,physics:X,math:p,light:$};if(typeof module=="object"&&typeof module.exports=="object")module.exports=I;else if(typeof define=="function"&&define.amd)define(bt,[],I);else{let n=typeof globalThis!="undefined"?globalThis:self;n[bt]=I}var ri=I;})();
